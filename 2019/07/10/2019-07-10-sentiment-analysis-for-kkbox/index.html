<!DOCTYPE HTML>
<html lang="en">


<head>
    <meta charset="utf-8">
    <meta name="keywords" content="Sentiment Analysis for KKBOX, Yang&#39;s Blog">
    <meta name="description" content="CS Student / NLP Enthusiast / Tireless Coder">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <meta name="renderer" content="webkit|ie-stand|ie-comp">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="format-detection" content="telephone=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <!-- Global site tag (gtag.js) - Google Analytics -->


    <title>Sentiment Analysis for KKBOX | Yang&#39;s Blog</title>
    <link rel="icon" type="image/png" href="/Hexo-Blog/favicon.png">

    <link rel="stylesheet" type="text/css" href="/Hexo-Blog/libs/awesome/css/all.css">
    <link rel="stylesheet" type="text/css" href="/Hexo-Blog/libs/materialize/materialize.min.css">
    <link rel="stylesheet" type="text/css" href="/Hexo-Blog/libs/aos/aos.css">
    <link rel="stylesheet" type="text/css" href="/Hexo-Blog/libs/animate/animate.min.css">
    <link rel="stylesheet" type="text/css" href="/Hexo-Blog/libs/lightGallery/css/lightgallery.min.css">
    <link rel="stylesheet" type="text/css" href="/Hexo-Blog/css/matery.css">
    <link rel="stylesheet" type="text/css" href="/Hexo-Blog/css/my.css">

    <script src="/Hexo-Blog/libs/jquery/jquery.min.js"></script>

<!-- hexo injector head_end start -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.12.0/dist/katex.min.css">

<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/hexo-math@4.0.0/dist/style.css">
<!-- hexo injector head_end end --><meta name="generator" content="Hexo 5.4.0"></head>




<body>
    <header class="navbar-fixed">
    <nav id="headNav" class="bg-color nav-transparent">
        <div id="navContainer" class="nav-wrapper container">
            <div class="brand-logo">
                <a href="/Hexo-Blog/" class="waves-effect waves-light">
                    
                    <img src="/Hexo-Blog/medias/logo.png" class="logo-img" alt="LOGO">
                    
                    <span class="logo-span">Yang&#39;s Blog</span>
                </a>
            </div>
            

<a href="#" data-target="mobile-nav" class="sidenav-trigger button-collapse"><i class="fas fa-bars"></i></a>
<ul class="right nav-menu">
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/Hexo-Blog/" class="waves-effect waves-light">
      
      <i class="fas fa-home" style="zoom: 0.6;"></i>
      
      <span>Index</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/Hexo-Blog/tags" class="waves-effect waves-light">
      
      <i class="fas fa-tags" style="zoom: 0.6;"></i>
      
      <span>Tags</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/Hexo-Blog/categories" class="waves-effect waves-light">
      
      <i class="fas fa-bookmark" style="zoom: 0.6;"></i>
      
      <span>Categories</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/Hexo-Blog/archives" class="waves-effect waves-light">
      
      <i class="fas fa-archive" style="zoom: 0.6;"></i>
      
      <span>Archives</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/Hexo-Blog/about" class="waves-effect waves-light">
      
      <i class="fas fa-user-circle" style="zoom: 0.6;"></i>
      
      <span>About</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/Hexo-Blog/contact" class="waves-effect waves-light">
      
      <i class="fas fa-comments" style="zoom: 0.6;"></i>
      
      <span>Contact</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/Hexo-Blog/friends" class="waves-effect waves-light">
      
      <i class="fas fa-address-book" style="zoom: 0.6;"></i>
      
      <span>Friends</span>
    </a>
    
  </li>
  
  <li>
    <a href="#searchModal" class="modal-trigger waves-effect waves-light">
      <i id="searchIcon" class="fas fa-search" title="Search" style="zoom: 0.85;"></i>
    </a>
  </li>
</ul>


<div id="mobile-nav" class="side-nav sidenav">

    <div class="mobile-head bg-color">
        
        <img src="/Hexo-Blog/medias/logo.png" class="logo-img circle responsive-img">
        
        <div class="logo-name">Yang&#39;s Blog</div>
        <div class="logo-desc">
            
            CS Student / NLP Enthusiast / Tireless Coder
            
        </div>
    </div>

    

    <ul class="menu-list mobile-menu-list">
        
        <li class="m-nav-item">
	  
		<a href="/Hexo-Blog/" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-home"></i>
			
			Index
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/Hexo-Blog/tags" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-tags"></i>
			
			Tags
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/Hexo-Blog/categories" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-bookmark"></i>
			
			Categories
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/Hexo-Blog/archives" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-archive"></i>
			
			Archives
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/Hexo-Blog/about" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-user-circle"></i>
			
			About
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/Hexo-Blog/contact" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-comments"></i>
			
			Contact
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/Hexo-Blog/friends" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-address-book"></i>
			
			Friends
		</a>
          
        </li>
        
        
        <li><div class="divider"></div></li>
        <li>
            <a href="https://github.com/penguinwang96825" class="waves-effect waves-light" target="_blank">
                <i class="fab fa-github-square fa-fw"></i>Fork Me
            </a>
        </li>
        
    </ul>
</div>


        </div>

        
            <style>
    .nav-transparent .github-corner {
        display: none !important;
    }

    .github-corner {
        position: absolute;
        z-index: 10;
        top: 0;
        right: 0;
        border: 0;
        transform: scale(1.1);
    }

    .github-corner svg {
        color: #0f9d58;
        fill: #fff;
        height: 64px;
        width: 64px;
    }

    .github-corner:hover .octo-arm {
        animation: a 0.56s ease-in-out;
    }

    .github-corner .octo-arm {
        animation: none;
    }

    @keyframes a {
        0%,
        to {
            transform: rotate(0);
        }
        20%,
        60% {
            transform: rotate(-25deg);
        }
        40%,
        80% {
            transform: rotate(10deg);
        }
    }
</style>

<a href="https://github.com/penguinwang96825" class="github-corner tooltipped hide-on-med-and-down" target="_blank"
   data-tooltip="Fork Me" data-position="left" data-delay="50">
    <svg viewBox="0 0 250 250" aria-hidden="true">
        <path d="M0,0 L115,115 L130,115 L142,142 L250,250 L250,0 Z"></path>
        <path d="M128.3,109.0 C113.8,99.7 119.0,89.6 119.0,89.6 C122.0,82.7 120.5,78.6 120.5,78.6 C119.2,72.0 123.4,76.3 123.4,76.3 C127.3,80.9 125.5,87.3 125.5,87.3 C122.9,97.6 130.6,101.9 134.4,103.2"
              fill="currentColor" style="transform-origin: 130px 106px;" class="octo-arm"></path>
        <path d="M115.0,115.0 C114.9,115.1 118.7,116.5 119.8,115.4 L133.7,101.6 C136.9,99.2 139.9,98.4 142.2,98.6 C133.8,88.0 127.5,74.4 143.8,58.0 C148.5,53.4 154.0,51.2 159.7,51.0 C160.3,49.4 163.2,43.6 171.4,40.1 C171.4,40.1 176.1,42.5 178.8,56.2 C183.1,58.6 187.2,61.8 190.9,65.4 C194.5,69.0 197.7,73.2 200.1,77.6 C213.8,80.2 216.3,84.9 216.3,84.9 C212.7,93.1 206.9,96.0 205.4,96.6 C205.1,102.4 203.0,107.8 198.3,112.5 C181.9,128.9 168.3,122.5 157.7,114.1 C157.9,116.9 156.7,120.9 152.7,124.9 L141.0,136.5 C139.8,137.7 141.6,141.9 141.8,141.8 Z"
              fill="currentColor" class="octo-body"></path>
    </svg>
</a>
        
    </nav>

</header>

    



<div class="bg-cover pd-header post-cover" style="background-image: url('https://github.com/penguinwang96825/penguinwang96825.github.io/blob/master/2019/07/10/2019-07-10-sentiment-analysis-for-kkbox/piano-1638633.png?raw=true')">
    <div class="container" style="right: 0px;left: 0px;">
        <div class="row">
            <div class="col s12 m12 l12">
                <div class="brand">
                    <h1 class="description center-align post-title">Sentiment Analysis for KKBOX</h1>
                </div>
            </div>
        </div>
    </div>
</div>




<main class="post-container content">

    
    <link rel="stylesheet" href="/Hexo-Blog/libs/tocbot/tocbot.css">
<style>
    #articleContent h1::before,
    #articleContent h2::before,
    #articleContent h3::before,
    #articleContent h4::before,
    #articleContent h5::before,
    #articleContent h6::before {
        display: block;
        content: " ";
        height: 100px;
        margin-top: -100px;
        visibility: hidden;
    }

    #articleContent :focus {
        outline: none;
    }

    .toc-fixed {
        position: fixed;
        top: 64px;
    }

    .toc-widget {
        width: 345px;
        padding-left: 20px;
    }

    .toc-widget .toc-title {
        padding: 35px 0 15px 17px;
        font-size: 1.5rem;
        font-weight: bold;
        line-height: 1.5rem;
    }

    .toc-widget ol {
        padding: 0;
        list-style: none;
    }

    #toc-content {
        padding-bottom: 30px;
        overflow: auto;
    }

    #toc-content ol {
        padding-left: 10px;
    }

    #toc-content ol li {
        padding-left: 10px;
    }

    #toc-content .toc-link:hover {
        color: #42b983;
        font-weight: 700;
        text-decoration: underline;
    }

    #toc-content .toc-link::before {
        background-color: transparent;
        max-height: 25px;

        position: absolute;
        right: 23.5vw;
        display: block;
    }

    #toc-content .is-active-link {
        color: #42b983;
    }

    #floating-toc-btn {
        position: fixed;
        right: 15px;
        bottom: 76px;
        padding-top: 15px;
        margin-bottom: 0;
        z-index: 998;
    }

    #floating-toc-btn .btn-floating {
        width: 48px;
        height: 48px;
    }

    #floating-toc-btn .btn-floating i {
        line-height: 48px;
        font-size: 1.4rem;
    }
</style>
<div class="row">
    <div id="main-content" class="col s12 m12 l9">
        <!-- 文章内容详情 -->
<div id="artDetail">
    <div class="card">
        <div class="card-content article-info">
            <div class="row tag-cate">
                <div class="col s7">
                    
                    <div class="article-tag">
                        
                            <a href="/Hexo-Blog/tags/Python/">
                                <span class="chip bg-color">Python</span>
                            </a>
                        
                            <a href="/Hexo-Blog/tags/NLP/">
                                <span class="chip bg-color">NLP</span>
                            </a>
                        
                            <a href="/Hexo-Blog/tags/KKBOX/">
                                <span class="chip bg-color">KKBOX</span>
                            </a>
                        
                            <a href="/Hexo-Blog/tags/UtaPass/">
                                <span class="chip bg-color">UtaPass</span>
                            </a>
                        
                    </div>
                    
                </div>
                <div class="col s5 right-align">
                    
                    <div class="post-cate">
                        <i class="fas fa-bookmark fa-fw icon-category"></i>
                        
                            <a href="/Hexo-Blog/categories/NLP/" class="post-category">
                                NLP
                            </a>
                        
                    </div>
                    
                </div>
            </div>

            <div class="post-info">
                
                <div class="post-date info-break-policy">
                    <i class="far fa-calendar-minus fa-fw"></i>Publish Date:&nbsp;&nbsp;
                    2019-07-10
                </div>
                

                

                
                <div class="info-break-policy">
                    <i class="far fa-file-word fa-fw"></i>Word Count:&nbsp;&nbsp;
                    8.4k
                </div>
                

                
                <div class="info-break-policy">
                    <i class="far fa-clock fa-fw"></i>Read Times:&nbsp;&nbsp;
                    52 Min
                </div>
                

                
                    <div id="busuanzi_container_page_pv" class="info-break-policy">
                        <i class="far fa-eye fa-fw"></i>Read Count:&nbsp;&nbsp;
                        <span id="busuanzi_value_page_pv"></span>
                    </div>
				
            </div>
        </div>
        <hr class="clearfix">

        
        <!-- 是否加载使用自带的 prismjs. -->
        <link rel="stylesheet" href="/Hexo-Blog/libs/prism/prism.css">
        

        

        <div class="card-content article-card-content">
            <div id="articleContent">
                <h1 id="Sentiment-Classification-for-UtaPass-amp-KKBOX-Reviews"><a href="#Sentiment-Classification-for-UtaPass-amp-KKBOX-Reviews" class="headerlink" title="Sentiment Classification for UtaPass &amp; KKBOX Reviews"></a>Sentiment Classification for UtaPass &amp; KKBOX Reviews</h1><p>Text classification for reviews of UtaPass &amp; KKBOX using different deep learning models.</p>
<h2 id="Introduction"><a href="#Introduction" class="headerlink" title="Introduction"></a>Introduction</h2><p>This sentiment classification task is based on reviews data of UtaPass and KKBOX from Google Play platform. As a KKStreamer at KKBOX, I become more interested in Natural Language Processing, especially text classification. First, I start crawling the text data using web crawler technique, namely BeautifulSoup and Selenium. Second, I develop several different neural network architectures, including simple RNN, LSTM, GRU, and CNN, to name but a few, to detect the polarity of reviews from customers.</p>
<h2 id="Data-Source"><a href="#Data-Source" class="headerlink" title="Data Source"></a>Data Source</h2><ol>
<li><a target="_blank" rel="noopener" href="https://play.google.com/store/apps/details?id=com.kddi.android.UtaPass&hl=ja&showAllReviews=true">UtaPass</a> reviews on Google Play.</li>
<li><a target="_blank" rel="noopener" href="https://play.google.com/store/apps/details?id=com.skysoft.kkbox.android&hl=ja&showAllReviews=true">KKBOX</a> reviews on Google Play.</li>
</ol>
<h2 id="Bottleneck"><a href="#Bottleneck" class="headerlink" title="Bottleneck"></a>Bottleneck</h2><ul>
<li>Is text pre-processing (e.g. remove stop words, remove punctuation, remove bad characters) neccessary?</li>
<li>Tokenise in character-level or word-level?</li>
<li>Do every reviews have sentiment words or charateristic of polarity?</li>
<li>Does this dataset exist an imbalance problem?</li>
</ul>
<h2 id="Flow-Chart-of-Text-Classification"><a href="#Flow-Chart-of-Text-Classification" class="headerlink" title="Flow Chart of Text Classification"></a>Flow Chart of Text Classification</h2><p><img src="https://github.com/penguinwang96825/Text-Classifier-for-UtaPass-and-KKBOX/raw/master/image/flowChart.jpg" alt="Flow Chart"></p>
<h2 id="Workstation"><a href="#Workstation" class="headerlink" title="Workstation"></a>Workstation</h2><ul>
<li>Processor: Intel Core i9-9900K</li>
<li>Motherboard: Gigabyte Z390 AORUS MASTER</li>
<li>GPU: MSI RTX2080Ti Gaming X Trio 11G</li>
<li>RAM: Kingston 64GB DDR4-3000 HyperX Predator</li>
<li>CPU Cooler: MasterLiquid ML240L</li>
<li>Storage: PLEXTOR M9PeGN 1TB M.2 2280 PCIe SSD</li>
<li>Power: Antec HCG750 Gold</li>
<li>Case: Fractal Design R6-BKO-TG</li>
</ul>
<h1 id="Preparation"><a href="#Preparation" class="headerlink" title="Preparation"></a>Preparation</h1><ol>
<li>Preparing Selenium, BeautifulSoup, and Pandas.</li>
</ol>
<ul>
<li>Selenium: Selenium is an open source tool used for automating.</li>
<li>Beautiful Soup: BeautifulSoup is a Python library for parsing data out of HTML and XML files.</li>
<li>Pandas: Pandas is an open source data analysis tools for the Python programming language.</li>
</ul>
<ol start="2">
<li>Install <a target="_blank" rel="noopener" href="https://qiita.com/yukinoi/items/990b6933d9f21ba0fb43">MeCab</a> on win10.</li>
</ol>
<ul>
<li>Download <a target="_blank" rel="noopener" href="https://github.com/ikegami-yukino/mecab/releases/download/v0.996.2/mecab-64-0.996.2.exe">MeCab</a> 64bit version first.</li>
<li>Run pip install <code>https://github.com/ikegami-yukino/mecab/archive/v0.996.2.tar.gz</code> in terminal.</li>
<li>Run <code>python -m pip install mecab</code> in terminal.</li>
</ul>
<p>There are other tools which can deal with other languages.</p>
<ul>
<li><p>English Segmentation Tools</p>
<ul>
<li><a target="_blank" rel="noopener" href="https://github.com/nltk/nltk">NLTK</a></li>
<li><a target="_blank" rel="noopener" href="https://spacy.io/api/tokenizer">spaCy</a></li>
<li><a target="_blank" rel="noopener" href="https://github.com/google/sentencepiece">SentencePiece</a></li>
<li><a target="_blank" rel="noopener" href="https://github.com/stanfordnlp/CoreNLP">Stanford CoreNLP</a></li>
</ul>
</li>
<li><p>Chinese Segmentation Tools</p>
<ul>
<li><a target="_blank" rel="noopener" href="https://github.com/fxsjy/jieba">Jieba</a></li>
<li><a target="_blank" rel="noopener" href="https://github.com/isnowfy/snownlp">SnowNLP</a></li>
<li><a target="_blank" rel="noopener" href="https://www.ltp-cloud.com/">LTP</a></li>
<li><a target="_blank" rel="noopener" href="https://github.com/hankcs/HanLP">HanNLP</a></li>
<li><a target="_blank" rel="noopener" href="https://github.com/lancopku/pkuseg-python">PKUSEG</a></li>
</ul>
</li>
<li><p>Japanese Segmentation Tools</p>
<ul>
<li><a target="_blank" rel="noopener" href="https://github.com/ikegami-yukino/mecab/releases">MeCab</a></li>
<li><a target="_blank" rel="noopener" href="https://www.dampfkraft.com/nlp/how-to-tokenize-japanese.html">Fugashi</a></li>
<li><a target="_blank" rel="noopener" href="https://mocobeta.github.io/janome/en/">Janome</a></li>
</ul>
</li>
</ul>
<h1 id="Main-Code-for-Crawling"><a href="#Main-Code-for-Crawling" class="headerlink" title="Main Code for Crawling"></a>Main Code for Crawling</h1><p>Data Crawling is to deal with large data-sets where you develop your crawlers (or bots) which crawl to the deepest of the web pages. In this project, I am going to crawl all the reviews related to UtaPass from Google Play.</p>
<h2 id="Scroll-down-Feature-and-Click-button-Feature"><a href="#Scroll-down-Feature-and-Click-button-Feature" class="headerlink" title="Scroll-down Feature and Click-button Feature"></a>Scroll-down Feature and Click-button Feature</h2><p>In Google Play, you need to scroll down pages to reach all the contents, in this project, I utilise Selenium to do so.</p>
<pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">def</span> <span class="token function">check_exists_by_xpath</span><span class="token punctuation">(</span>xpath<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">try</span><span class="token punctuation">:</span>
        driver<span class="token punctuation">.</span>find_element_by_xpath<span class="token punctuation">(</span>xpath<span class="token punctuation">)</span>
    <span class="token keyword">except</span> NoSuchElementException<span class="token punctuation">:</span>
        <span class="token keyword">return</span> <span class="token boolean">False</span>
    <span class="token keyword">return</span> <span class="token boolean">True</span>

<span class="token keyword">def</span> <span class="token function">scroll_ownPage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token comment"># Xpath of "もっと見る" bottom</span>
    button <span class="token operator">=</span> <span class="token string">'//*[@id="fcxH9b"]/div[4]/c-wiz/div/div[2]/div/div[1]/div/div/div[1]/div[2]/div[2]/div/span/span'</span>
    
    <span class="token comment"># Keep scrolling down until to the very bottom</span>
    keep_scrolling <span class="token operator">=</span> <span class="token boolean">True</span>
    <span class="token keyword">while</span> keep_scrolling<span class="token punctuation">:</span>
        <span class="token keyword">try</span><span class="token punctuation">:</span> 
            <span class="token comment"># Scroll down to the bottom</span>
            <span class="token keyword">for</span> _ <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
                <span class="token keyword">try</span><span class="token punctuation">:</span> 
                    driver<span class="token punctuation">.</span>execute_script<span class="token punctuation">(</span><span class="token string">'window.scrollTo(0, document.body.scrollHeight);'</span><span class="token punctuation">)</span>
                    time<span class="token punctuation">.</span>sleep<span class="token punctuation">(</span><span class="token number">1</span> <span class="token operator">+</span> random<span class="token punctuation">.</span>random<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                <span class="token keyword">except</span><span class="token punctuation">:</span>
                    <span class="token keyword">break</span>
            <span class="token comment"># Click "もっと見る"</span>
            <span class="token keyword">if</span> check_exists_by_xpath<span class="token punctuation">(</span>button<span class="token punctuation">)</span><span class="token punctuation">:</span>
                driver<span class="token punctuation">.</span>find_element_by_xpath<span class="token punctuation">(</span>button<span class="token punctuation">)</span><span class="token punctuation">.</span>click<span class="token punctuation">(</span><span class="token punctuation">)</span>
                time<span class="token punctuation">.</span>sleep<span class="token punctuation">(</span><span class="token number">2</span> <span class="token operator">+</span> random<span class="token punctuation">.</span>random<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
            <span class="token keyword">else</span><span class="token punctuation">:</span>
                <span class="token comment"># Stop scrolling down</span>
                keep_scrolling <span class="token operator">=</span> <span class="token boolean">False</span>
        <span class="token keyword">except</span><span class="token punctuation">:</span> 
            <span class="token keyword">pass</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h2 id="Start-Crawling"><a href="#Start-Crawling" class="headerlink" title="Start Crawling"></a>Start Crawling</h2><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">def</span> <span class="token function">open_google_play_reviews</span><span class="token punctuation">(</span>url<span class="token punctuation">)</span><span class="token punctuation">:</span>
    driver_path <span class="token operator">=</span> <span class="token string">r"C:\Users\YangWang\Desktop\Text_Classifier_for_UtaPass_and_KKBOX\chromedriver.exe"</span>
    driver <span class="token operator">=</span> webdriver<span class="token punctuation">.</span>Chrome<span class="token punctuation">(</span>driver_path<span class="token punctuation">)</span>
    time<span class="token punctuation">.</span>sleep<span class="token punctuation">(</span><span class="token number">2</span> <span class="token operator">+</span> random<span class="token punctuation">.</span>random<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    driver<span class="token punctuation">.</span>get<span class="token punctuation">(</span>url<span class="token punctuation">)</span>
    time<span class="token punctuation">.</span>sleep<span class="token punctuation">(</span><span class="token number">5</span> <span class="token operator">+</span> random<span class="token punctuation">.</span>random<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    
    scrollDownPage<span class="token punctuation">(</span><span class="token punctuation">)</span>
    soup <span class="token operator">=</span> BeautifulSoup<span class="token punctuation">(</span>driver<span class="token punctuation">.</span>page_source<span class="token punctuation">,</span> <span class="token string">"html.parser"</span><span class="token punctuation">)</span>
    time<span class="token punctuation">.</span>sleep<span class="token punctuation">(</span><span class="token number">3</span> <span class="token operator">+</span> random<span class="token punctuation">.</span>random<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    driver<span class="token punctuation">.</span>quit<span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">return</span> soup
    
<span class="token keyword">def</span> <span class="token function">convert_soup_to_dataframe</span><span class="token punctuation">(</span>soup<span class="token punctuation">)</span><span class="token punctuation">:</span>
    reviews <span class="token operator">=</span> soup<span class="token punctuation">.</span>find<span class="token punctuation">(</span>name<span class="token operator">=</span><span class="token string">"div"</span><span class="token punctuation">,</span> attrs<span class="token operator">=</span><span class="token punctuation">&#123;</span><span class="token string">"jsname"</span><span class="token punctuation">:</span> <span class="token string">"fk8dgd"</span><span class="token punctuation">&#125;</span><span class="token punctuation">)</span>
    reviews_list <span class="token operator">=</span> reviews<span class="token punctuation">.</span>find_all<span class="token punctuation">(</span>name<span class="token operator">=</span><span class="token string">"div"</span><span class="token punctuation">,</span> attrs<span class="token operator">=</span><span class="token punctuation">&#123;</span><span class="token string">"jscontroller"</span><span class="token punctuation">:</span> <span class="token string">"H6eOGe"</span><span class="token punctuation">&#125;</span><span class="token punctuation">)</span>
    reviews_all <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
    <span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token builtin">len</span><span class="token punctuation">(</span>reviews_list<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        name <span class="token operator">=</span> reviews_list<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>find<span class="token punctuation">(</span>name<span class="token operator">=</span><span class="token string">"span"</span><span class="token punctuation">,</span> attrs<span class="token operator">=</span><span class="token punctuation">&#123;</span><span class="token string">"class"</span><span class="token punctuation">:</span> <span class="token string">"X43Kjb"</span><span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">.</span>string
        date <span class="token operator">=</span> reviews_list<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>find<span class="token punctuation">(</span>name<span class="token operator">=</span><span class="token string">"span"</span><span class="token punctuation">,</span> attrs<span class="token operator">=</span><span class="token punctuation">&#123;</span><span class="token string">"class"</span><span class="token punctuation">:</span> <span class="token string">"p2TkOb"</span><span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">.</span>string
        rating <span class="token operator">=</span> reviews_list<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>find<span class="token punctuation">(</span>name<span class="token operator">=</span><span class="token string">"div"</span><span class="token punctuation">,</span> attrs<span class="token operator">=</span><span class="token punctuation">&#123;</span><span class="token string">"class"</span><span class="token punctuation">:</span> <span class="token string">"pf5lIe"</span><span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">.</span>find<span class="token punctuation">(</span>name<span class="token operator">=</span><span class="token string">"div"</span><span class="token punctuation">)</span><span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">"aria-label"</span><span class="token punctuation">)</span>
        rating <span class="token operator">=</span> <span class="token builtin">int</span><span class="token punctuation">(</span>rating<span class="token punctuation">.</span>split<span class="token punctuation">(</span><span class="token string">"/"</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
        content <span class="token operator">=</span> reviews_list<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>find<span class="token punctuation">(</span>name<span class="token operator">=</span><span class="token string">"span"</span><span class="token punctuation">,</span> attrs<span class="token operator">=</span><span class="token punctuation">&#123;</span><span class="token string">"jsname"</span><span class="token punctuation">:</span> <span class="token string">"bN97Pc"</span><span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">.</span>string
        like <span class="token operator">=</span> reviews_list<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>find<span class="token punctuation">(</span>name<span class="token operator">=</span><span class="token string">"div"</span><span class="token punctuation">,</span> attrs<span class="token operator">=</span><span class="token punctuation">&#123;</span><span class="token string">"class"</span><span class="token punctuation">:</span> <span class="token string">"jUL89d y92BAb"</span><span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">.</span>string
        reviews_all<span class="token punctuation">.</span>append<span class="token punctuation">(</span><span class="token punctuation">[</span>name<span class="token punctuation">,</span> date<span class="token punctuation">,</span> rating<span class="token punctuation">,</span> content<span class="token punctuation">,</span> like<span class="token punctuation">]</span><span class="token punctuation">)</span>
    df <span class="token operator">=</span> pd<span class="token punctuation">.</span>DataFrame<span class="token punctuation">(</span>reviews_all<span class="token punctuation">)</span>
    df<span class="token punctuation">.</span>columns <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string">"name"</span><span class="token punctuation">,</span> <span class="token string">"date"</span><span class="token punctuation">,</span> <span class="token string">"rating"</span><span class="token punctuation">,</span> <span class="token string">"content"</span><span class="token punctuation">,</span> <span class="token string">"like"</span><span class="token punctuation">]</span>
    <span class="token keyword">return</span> df
    
<span class="token keyword">def</span> <span class="token function">crawl</span><span class="token punctuation">(</span>url<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"Parsing soup from url..."</span><span class="token punctuation">)</span>
    soup <span class="token operator">=</span> open_google_play_reviews<span class="token punctuation">(</span>url<span class="token punctuation">)</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"Done parsing soup from url."</span><span class="token punctuation">)</span>
    df <span class="token operator">=</span> convert_soup_to_dataframe<span class="token punctuation">(</span>soup<span class="token punctuation">)</span>
    <span class="token keyword">return</span> df<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h2 id="Data-Storage"><a href="#Data-Storage" class="headerlink" title="Data Storage"></a>Data Storage</h2><p>There are 12498 reviews in total. Take a look at the dataframe.</p>
<table>
<thead>
<tr>
<th></th>
<th>Author Name</th>
<th>Review Date</th>
<th>Reviewer Ratings</th>
<th>Review Content</th>
</tr>
</thead>
<tbody><tr>
<td>195</td>
<td>眞也大平</td>
<td>2018年12月4日</td>
<td>1</td>
<td>聴い途中止まる強制終了する止まる辞め</td>
</tr>
<tr>
<td>13</td>
<td>狼音牙</td>
<td>2019年4月22日</td>
<td>1</td>
<td>LISMO使えなっ早くもどせうたパスLISMO使い</td>
</tr>
<tr>
<td>47</td>
<td>美能孝行</td>
<td>2019年3月12日</td>
<td>3</td>
<td>アルバム曲名読み方登録それ名前反映不具合かなり継続技術改善でき諦め使いあり</td>
</tr>
<tr>
<td>142</td>
<td>梅川洋子</td>
<td>2019年2月14日</td>
<td>4</td>
<td>いつ聴けるいい</td>
</tr>
<tr>
<td>45</td>
<td>わんたった</td>
<td>2019年4月27日</td>
<td>1</td>
<td>アンストアプリ残っ</td>
</tr>
</tbody></table>
<h1 id="Main-Code-for-Modelling"><a href="#Main-Code-for-Modelling" class="headerlink" title="Main Code for Modelling"></a>Main Code for Modelling</h1><h2 id="Import-Packages"><a href="#Import-Packages" class="headerlink" title="Import Packages"></a>Import Packages</h2><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">import</span> warnings
<span class="token keyword">import</span> re
<span class="token keyword">import</span> emoji
<span class="token keyword">import</span> MeCab
<span class="token keyword">import</span> numpy <span class="token keyword">as</span> np
<span class="token keyword">import</span> pandas <span class="token keyword">as</span> pd
<span class="token keyword">import</span> matplotlib<span class="token punctuation">.</span>pyplot <span class="token keyword">as</span> plt
<span class="token keyword">from</span> collections <span class="token keyword">import</span> Counter
<span class="token keyword">from</span> sklearn<span class="token punctuation">.</span>feature_extraction<span class="token punctuation">.</span>text <span class="token keyword">import</span> CountVectorizer
<span class="token keyword">from</span> sklearn<span class="token punctuation">.</span>model_selection <span class="token keyword">import</span> train_test_split
<span class="token keyword">from</span> sklearn<span class="token punctuation">.</span>metrics <span class="token keyword">import</span> accuracy_score
<span class="token keyword">from</span> sklearn<span class="token punctuation">.</span>metrics <span class="token keyword">import</span> confusion_matrix
<span class="token keyword">from</span> sklearn<span class="token punctuation">.</span>metrics <span class="token keyword">import</span> roc_auc_score
<span class="token keyword">from</span> sklearn<span class="token punctuation">.</span>metrics <span class="token keyword">import</span> precision_score
<span class="token keyword">from</span> sklearn<span class="token punctuation">.</span>metrics <span class="token keyword">import</span> recall_score
<span class="token keyword">from</span> sklearn<span class="token punctuation">.</span>metrics <span class="token keyword">import</span> f1_score

<span class="token keyword">import</span> tensorflow <span class="token keyword">as</span> tf
<span class="token keyword">import</span> keras<span class="token punctuation">.</span>backend <span class="token keyword">as</span> K
<span class="token keyword">from</span> keras <span class="token keyword">import</span> regularizers
<span class="token keyword">from</span> keras<span class="token punctuation">.</span>models <span class="token keyword">import</span> Sequential
<span class="token keyword">from</span> keras<span class="token punctuation">.</span>models <span class="token keyword">import</span> Model
<span class="token keyword">from</span> keras<span class="token punctuation">.</span>layers <span class="token keyword">import</span> Input
<span class="token keyword">from</span> keras<span class="token punctuation">.</span>layers <span class="token keyword">import</span> InputLayer
<span class="token keyword">from</span> keras<span class="token punctuation">.</span>layers <span class="token keyword">import</span> Embedding
<span class="token keyword">from</span> keras<span class="token punctuation">.</span>layers <span class="token keyword">import</span> Dense
<span class="token keyword">from</span> keras<span class="token punctuation">.</span>layers <span class="token keyword">import</span> Add
<span class="token keyword">from</span> keras<span class="token punctuation">.</span>layers <span class="token keyword">import</span> Concatenate
<span class="token keyword">from</span> keras<span class="token punctuation">.</span>layers <span class="token keyword">import</span> ZeroPadding1D
<span class="token keyword">from</span> keras<span class="token punctuation">.</span>layers <span class="token keyword">import</span> Dropout
<span class="token keyword">from</span> keras<span class="token punctuation">.</span>layers <span class="token keyword">import</span> SpatialDropout1D
<span class="token keyword">from</span> keras<span class="token punctuation">.</span>layers <span class="token keyword">import</span> Activation
<span class="token keyword">from</span> keras<span class="token punctuation">.</span>layers <span class="token keyword">import</span> Conv1D
<span class="token keyword">from</span> keras<span class="token punctuation">.</span>layers <span class="token keyword">import</span> MaxPooling1D
<span class="token keyword">from</span> keras<span class="token punctuation">.</span>layers <span class="token keyword">import</span> GlobalAveragePooling1D
<span class="token keyword">from</span> keras<span class="token punctuation">.</span>layers <span class="token keyword">import</span> GlobalMaxPool1D
<span class="token keyword">from</span> keras<span class="token punctuation">.</span>layers <span class="token keyword">import</span> AveragePooling1D
<span class="token keyword">from</span> keras<span class="token punctuation">.</span>layers <span class="token keyword">import</span> BatchNormalization
<span class="token keyword">from</span> keras<span class="token punctuation">.</span>layers <span class="token keyword">import</span> Flatten
<span class="token keyword">from</span> keras<span class="token punctuation">.</span>layers <span class="token keyword">import</span> SimpleRNN
<span class="token keyword">from</span> keras<span class="token punctuation">.</span>layers <span class="token keyword">import</span> CuDNNLSTM
<span class="token keyword">from</span> keras<span class="token punctuation">.</span>layers <span class="token keyword">import</span> Bidirectional
<span class="token keyword">from</span> keras<span class="token punctuation">.</span>layers<span class="token punctuation">.</span>recurrent <span class="token keyword">import</span> LSTM
<span class="token keyword">from</span> keras<span class="token punctuation">.</span>layers<span class="token punctuation">.</span>recurrent <span class="token keyword">import</span> GRU
<span class="token keyword">from</span> keras<span class="token punctuation">.</span>optimizers <span class="token keyword">import</span> Adam
<span class="token keyword">from</span> keras<span class="token punctuation">.</span>optimizers <span class="token keyword">import</span> SGD
<span class="token keyword">from</span> keras<span class="token punctuation">.</span>layers<span class="token punctuation">.</span>normalization <span class="token keyword">import</span> BatchNormalization
<span class="token keyword">from</span> keras<span class="token punctuation">.</span>preprocessing <span class="token keyword">import</span> text
<span class="token keyword">from</span> keras<span class="token punctuation">.</span>preprocessing <span class="token keyword">import</span> sequence
<span class="token keyword">from</span> keras<span class="token punctuation">.</span>callbacks <span class="token keyword">import</span> EarlyStopping<span class="token punctuation">,</span> TensorBoard<span class="token punctuation">,</span> ModelCheckpoint
<span class="token keyword">from</span> keras<span class="token punctuation">.</span>callbacks <span class="token keyword">import</span> ReduceLROnPlateau
<span class="token keyword">from</span> gensim<span class="token punctuation">.</span>models<span class="token punctuation">.</span>word2vec <span class="token keyword">import</span> Word2Vec<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h2 id="Load-Data-In"><a href="#Load-Data-In" class="headerlink" title="Load Data In"></a>Load Data In</h2><p>First, split dataframe into two categories: positive and negative. Second, do some text preprocessing. For instance, if rating is lower than 3 stars, label it as negative.</p>
<pre class="line-numbers language-python" data-language="python"><code class="language-python">df <span class="token operator">=</span> pd<span class="token punctuation">.</span>read_csv<span class="token punctuation">(</span><span class="token string">r"C:\Users\YangWang\Desktop\Text_Classifier_for_UtaPass_and_KKBOX\data\all_20200423.csv"</span><span class="token punctuation">)</span>
<span class="token comment"># create the label</span>
df<span class="token punctuation">[</span><span class="token string">"label"</span><span class="token punctuation">]</span> <span class="token operator">=</span> df<span class="token punctuation">[</span><span class="token string">"rating"</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token builtin">apply</span><span class="token punctuation">(</span><span class="token keyword">lambda</span> x<span class="token punctuation">:</span> <span class="token number">0</span> <span class="token keyword">if</span> <span class="token builtin">int</span><span class="token punctuation">(</span>x<span class="token punctuation">)</span> <span class="token operator">&lt;=</span> <span class="token number">3</span> <span class="token keyword">else</span> <span class="token number">1</span><span class="token punctuation">)</span>
<span class="token comment"># select only relevant columns</span>
df <span class="token operator">=</span> df<span class="token punctuation">[</span><span class="token punctuation">[</span><span class="token string">"content"</span><span class="token punctuation">,</span> <span class="token string">"label"</span><span class="token punctuation">]</span><span class="token punctuation">]</span>
df<span class="token punctuation">[</span><span class="token string">"content"</span><span class="token punctuation">]</span> <span class="token operator">=</span> df<span class="token punctuation">[</span><span class="token string">"content"</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token builtin">map</span><span class="token punctuation">(</span><span class="token builtin">str</span><span class="token punctuation">)</span>
df<span class="token punctuation">.</span>head<span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<hr>
<table>
<thead>
<tr>
<th></th>
<th>content</th>
<th>label</th>
</tr>
</thead>
<tbody><tr>
<td>0</td>
<td>歌詞見れるいいずれ誤字あるあとお気に入りプレイリスト開くライブラリ更新リセットれるマジ入れラ…</td>
<td>0</td>
</tr>
<tr>
<td>1</td>
<td>通知切る方法分かりすぎる見る新たアプリ入れ通知切れ判明アプリ開発若者毎日アクティブ新曲買っ聴…</td>
<td>0</td>
</tr>
<tr>
<td>2</td>
<td>どうしてもLISMO比べダウンロード反映LISMO動画一覧表示パス分離とにかく使いLISMO…</td>
<td>0</td>
</tr>
<tr>
<td>3</td>
<td>以前購入機種だぶっダウンロードれる消す出来機種するダウンロード出来有るガラケー購入スマ出来有り</td>
<td>0</td>
</tr>
<tr>
<td>4</td>
<td>LISMOライブラリ開けなっ愛着あっLISMO使っ消し下らないうたパスLISMOいらついて最…</td>
<td>0</td>
</tr>
</tbody></table>
<h2 id="Data-Pre-processing"><a href="#Data-Pre-processing" class="headerlink" title="Data Pre-processing"></a>Data Pre-processing</h2><ol>
<li>Remove emoji.</li>
<li>Remove punctuation</li>
<li>Remove digits.</li>
<li>Tokenise sentence using MeCab.</li>
</ol>
<pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">def</span> <span class="token function">create_mecab_list</span><span class="token punctuation">(</span>text<span class="token punctuation">)</span><span class="token punctuation">:</span>
    pos_list <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token number">10</span><span class="token punctuation">,</span> <span class="token number">11</span><span class="token punctuation">,</span> <span class="token number">31</span><span class="token punctuation">,</span> <span class="token number">32</span><span class="token punctuation">,</span> <span class="token number">34</span><span class="token punctuation">]</span>
    pos_list<span class="token punctuation">.</span>extend<span class="token punctuation">(</span><span class="token builtin">list</span><span class="token punctuation">(</span><span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">36</span><span class="token punctuation">,</span><span class="token number">50</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    pos_list<span class="token punctuation">.</span>extend<span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token number">59</span><span class="token punctuation">,</span> <span class="token number">60</span><span class="token punctuation">,</span> <span class="token number">62</span><span class="token punctuation">,</span> <span class="token number">67</span><span class="token punctuation">]</span><span class="token punctuation">)</span>

    mecab_list <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
    mecab <span class="token operator">=</span> MeCab<span class="token punctuation">.</span>Tagger<span class="token punctuation">(</span><span class="token string">"-Owakati"</span><span class="token punctuation">)</span>
    mecab<span class="token punctuation">.</span>parse<span class="token punctuation">(</span><span class="token string">""</span><span class="token punctuation">)</span>
    <span class="token comment"># encoding = text.encode('utf-8')</span>
    node <span class="token operator">=</span> mecab<span class="token punctuation">.</span>parseToNode<span class="token punctuation">(</span>text<span class="token punctuation">)</span>
    <span class="token keyword">while</span> node<span class="token punctuation">:</span>
        <span class="token keyword">if</span> <span class="token builtin">len</span><span class="token punctuation">(</span>node<span class="token punctuation">.</span>surface<span class="token punctuation">)</span> <span class="token operator">></span> <span class="token number">1</span><span class="token punctuation">:</span>
            <span class="token keyword">if</span> node<span class="token punctuation">.</span>posid <span class="token keyword">in</span> pos_list<span class="token punctuation">:</span>
                morpheme <span class="token operator">=</span> node<span class="token punctuation">.</span>surface
                mecab_list<span class="token punctuation">.</span>append<span class="token punctuation">(</span>morpheme<span class="token punctuation">)</span>
        node <span class="token operator">=</span> node<span class="token punctuation">.</span><span class="token builtin">next</span>
    <span class="token keyword">return</span> mecab_list

<span class="token keyword">def</span> <span class="token function">give_emoji_free_text</span><span class="token punctuation">(</span>text<span class="token punctuation">)</span><span class="token punctuation">:</span>
    allchars <span class="token operator">=</span> <span class="token punctuation">[</span>string <span class="token keyword">for</span> string <span class="token keyword">in</span> text<span class="token punctuation">]</span>
    emoji_list <span class="token operator">=</span> <span class="token punctuation">[</span>c <span class="token keyword">for</span> c <span class="token keyword">in</span> allchars <span class="token keyword">if</span> c <span class="token keyword">in</span> emoji<span class="token punctuation">.</span>UNICODE_EMOJI<span class="token punctuation">]</span>
    cleaned_text <span class="token operator">=</span> <span class="token string">' '</span><span class="token punctuation">.</span>join<span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token builtin">str</span> <span class="token keyword">for</span> <span class="token builtin">str</span> <span class="token keyword">in</span> text<span class="token punctuation">.</span>split<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">if</span> <span class="token keyword">not</span> <span class="token builtin">any</span><span class="token punctuation">(</span>i <span class="token keyword">in</span> <span class="token builtin">str</span> <span class="token keyword">for</span> i <span class="token keyword">in</span> emoji_list<span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
    <span class="token keyword">return</span> cleaned_text

<span class="token keyword">def</span> <span class="token function">clean_text</span><span class="token punctuation">(</span>text<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token comment"># Remove emoji</span>
    text <span class="token operator">=</span> give_emoji_free_text<span class="token punctuation">(</span>text<span class="token punctuation">)</span>
    <span class="token comment"># Remove punctuation</span>
    text <span class="token operator">=</span> re<span class="token punctuation">.</span>sub<span class="token punctuation">(</span><span class="token string">r'[^\w\d\s]+'</span><span class="token punctuation">,</span> <span class="token string">''</span><span class="token punctuation">,</span> text<span class="token punctuation">)</span>
    <span class="token comment"># Remove digits</span>
    text <span class="token operator">=</span> <span class="token string">''</span><span class="token punctuation">.</span>join<span class="token punctuation">(</span><span class="token punctuation">[</span>i <span class="token keyword">for</span> i <span class="token keyword">in</span> text <span class="token keyword">if</span> <span class="token keyword">not</span> i<span class="token punctuation">.</span>isdigit<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">)</span> 
    <span class="token comment"># Tokenize the sentence</span>
    tokenised_text_list <span class="token operator">=</span> create_mecab_list<span class="token punctuation">(</span>text<span class="token punctuation">)</span>
    <span class="token keyword">return</span> tokenised_text_list<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h2 id="Main-Code-for-Modelling-1"><a href="#Main-Code-for-Modelling-1" class="headerlink" title="Main Code for Modelling"></a>Main Code for Modelling</h2><h3 id="Set-Parameters"><a href="#Set-Parameters" class="headerlink" title="Set Parameters"></a>Set Parameters</h3><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token comment"># Input parameters</span>
config <span class="token operator">=</span> <span class="token punctuation">&#123;</span>
    <span class="token comment"># Text parameters</span>
    <span class="token string">"MAX_FEATURE"</span><span class="token punctuation">:</span> <span class="token number">10000</span><span class="token punctuation">,</span> 
    <span class="token string">"MAX_LEN"</span><span class="token punctuation">:</span> <span class="token number">64</span><span class="token punctuation">,</span> 
    <span class="token string">"EMBED_SIZE"</span><span class="token punctuation">:</span> <span class="token number">300</span><span class="token punctuation">,</span> 

    <span class="token comment"># Convolution parameters</span>
    <span class="token string">"filter_length"</span><span class="token punctuation">:</span> <span class="token number">3</span><span class="token punctuation">,</span> 
    <span class="token string">"nb_filter"</span><span class="token punctuation">:</span> <span class="token number">150</span><span class="token punctuation">,</span> 
    <span class="token string">"pool_length"</span><span class="token punctuation">:</span> <span class="token number">2</span><span class="token punctuation">,</span> 
    <span class="token string">"cnn_activation"</span><span class="token punctuation">:</span> <span class="token string">'relu'</span><span class="token punctuation">,</span> 
    <span class="token string">"border_mode"</span><span class="token punctuation">:</span> <span class="token string">'same'</span><span class="token punctuation">,</span> 

    <span class="token comment"># RNN parameters</span>
    <span class="token string">"lstm_cell"</span><span class="token punctuation">:</span> <span class="token number">128</span><span class="token punctuation">,</span> 
    <span class="token string">"output_size"</span><span class="token punctuation">:</span> <span class="token number">50</span><span class="token punctuation">,</span> 
    <span class="token string">"rnn_activation"</span><span class="token punctuation">:</span> <span class="token string">'tanh'</span><span class="token punctuation">,</span> 
    <span class="token string">"recurrent_activation"</span><span class="token punctuation">:</span> <span class="token string">'hard_sigmoid'</span><span class="token punctuation">,</span> 
    
    <span class="token comment"># FC and Dropout</span>
    <span class="token string">"fc_cell"</span><span class="token punctuation">:</span> <span class="token number">128</span><span class="token punctuation">,</span> 
    <span class="token string">"dropout_rate"</span><span class="token punctuation">:</span> <span class="token number">0.25</span><span class="token punctuation">,</span> 

    <span class="token comment"># Compile parameters</span>
    <span class="token string">"loss"</span><span class="token punctuation">:</span> <span class="token string">'binary_crossentropy'</span><span class="token punctuation">,</span> 
    <span class="token string">"optimizer"</span><span class="token punctuation">:</span> <span class="token string">'adam'</span><span class="token punctuation">,</span> 

    <span class="token comment"># Training parameters</span>
    <span class="token string">"batch_size"</span><span class="token punctuation">:</span> <span class="token number">256</span><span class="token punctuation">,</span> 
    <span class="token string">"nb_epoch"</span><span class="token punctuation">:</span> <span class="token number">1000</span><span class="token punctuation">,</span> 
    <span class="token string">"validation_split"</span><span class="token punctuation">:</span> <span class="token number">0.20</span><span class="token punctuation">,</span> 
    <span class="token string">"shuffle"</span><span class="token punctuation">:</span> <span class="token boolean">True</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h3 id="Create-Word-Index"><a href="#Create-Word-Index" class="headerlink" title="Create Word Index"></a>Create Word Index</h3><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">def</span> <span class="token function">create_word2index_and_index2word</span><span class="token punctuation">(</span>df<span class="token punctuation">)</span><span class="token punctuation">:</span>
    df<span class="token punctuation">[</span><span class="token string">"cleaned_text"</span><span class="token punctuation">]</span> <span class="token operator">=</span> df<span class="token punctuation">[</span><span class="token string">"content"</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token builtin">apply</span><span class="token punctuation">(</span>clean_text<span class="token punctuation">)</span>
    sum_list <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
    <span class="token keyword">for</span> index<span class="token punctuation">,</span> row <span class="token keyword">in</span> df<span class="token punctuation">.</span>iterrows<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        sum_list <span class="token operator">+=</span> row<span class="token punctuation">[</span><span class="token string">"cleaned_text"</span><span class="token punctuation">]</span>

    word2index <span class="token operator">=</span> <span class="token builtin">dict</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    index2word <span class="token operator">=</span> <span class="token builtin">dict</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    num_words <span class="token operator">=</span> <span class="token number">0</span>
    <span class="token keyword">for</span> word <span class="token keyword">in</span> sum_list<span class="token punctuation">:</span>
        <span class="token keyword">if</span> word <span class="token keyword">not</span> <span class="token keyword">in</span> word2index<span class="token punctuation">:</span>
            <span class="token comment"># First entry of word into vocabulary</span>
            word2index<span class="token punctuation">[</span>word<span class="token punctuation">]</span> <span class="token operator">=</span> num_words
            index2word<span class="token punctuation">[</span>num_words<span class="token punctuation">]</span> <span class="token operator">=</span> word
            num_words <span class="token operator">+=</span> <span class="token number">1</span>
    
    <span class="token keyword">return</span> word2index<span class="token punctuation">,</span> index2word

<span class="token keyword">def</span> <span class="token function">convert_tokens_to_ids</span><span class="token punctuation">(</span>tokens_list<span class="token punctuation">,</span> word2index<span class="token punctuation">)</span><span class="token punctuation">:</span>
    ids_list <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
    <span class="token keyword">for</span> token <span class="token keyword">in</span> tokens_list<span class="token punctuation">:</span>
        <span class="token keyword">if</span> word2index<span class="token punctuation">.</span>get<span class="token punctuation">(</span>token<span class="token punctuation">,</span> <span class="token boolean">None</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token boolean">None</span><span class="token punctuation">:</span>
            ids_list<span class="token punctuation">.</span>append<span class="token punctuation">(</span>word2index<span class="token punctuation">[</span>token<span class="token punctuation">]</span><span class="token punctuation">)</span>
    <span class="token keyword">return</span> ids_list

<span class="token keyword">def</span> <span class="token function">remove_empty_ids_rows</span><span class="token punctuation">(</span>df<span class="token punctuation">)</span><span class="token punctuation">:</span>
    empty <span class="token operator">=</span> <span class="token punctuation">(</span>df<span class="token punctuation">[</span><span class="token string">'ids'</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token builtin">map</span><span class="token punctuation">(</span><span class="token builtin">len</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span>
    <span class="token keyword">return</span> df<span class="token punctuation">[</span><span class="token operator">~</span>empty<span class="token punctuation">]</span>

word2index<span class="token punctuation">,</span> index2word <span class="token operator">=</span> create_word2index_and_index2word<span class="token punctuation">(</span>df<span class="token punctuation">)</span>
df<span class="token punctuation">[</span><span class="token string">"ids"</span><span class="token punctuation">]</span> <span class="token operator">=</span> df<span class="token punctuation">[</span><span class="token string">"content"</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token builtin">apply</span><span class="token punctuation">(</span><span class="token keyword">lambda</span> x<span class="token punctuation">:</span> convert_tokens_to_ids<span class="token punctuation">(</span>clean_text<span class="token punctuation">(</span>x<span class="token punctuation">)</span><span class="token punctuation">,</span> word2index<span class="token punctuation">)</span><span class="token punctuation">)</span>
df <span class="token operator">=</span> remove_empty_ids_rows<span class="token punctuation">(</span>df<span class="token punctuation">)</span>
df<span class="token punctuation">.</span>head<span class="token punctuation">(</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h3 id="Split-Data"><a href="#Split-Data" class="headerlink" title="Split Data"></a>Split Data</h3><p>Split the data into training data (80%) and testing data (20%).</p>
<ul>
<li>Training set: a subset to train a model</li>
<li>Testing set: a subset to test the trained model</li>
</ul>
<pre class="line-numbers language-python" data-language="python"><code class="language-python">x <span class="token operator">=</span> df<span class="token punctuation">[</span><span class="token string">"ids"</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token builtin">map</span><span class="token punctuation">(</span><span class="token keyword">lambda</span> x<span class="token punctuation">:</span> np<span class="token punctuation">.</span>array<span class="token punctuation">(</span>x<span class="token punctuation">)</span><span class="token punctuation">)</span>
x <span class="token operator">=</span> sequence<span class="token punctuation">.</span>pad_sequences<span class="token punctuation">(</span>x<span class="token punctuation">,</span> maxlen<span class="token operator">=</span>config<span class="token punctuation">[</span><span class="token string">"MAX_LEN"</span><span class="token punctuation">]</span><span class="token punctuation">,</span> padding<span class="token operator">=</span><span class="token string">"post"</span><span class="token punctuation">)</span>
<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"Features: \n"</span><span class="token punctuation">,</span> x<span class="token punctuation">)</span>
y <span class="token operator">=</span> df<span class="token punctuation">[</span><span class="token string">"label"</span><span class="token punctuation">]</span><span class="token punctuation">.</span>values
<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"Labels: \n"</span><span class="token punctuation">,</span> y<span class="token punctuation">)</span>

x_train<span class="token punctuation">,</span> x_test<span class="token punctuation">,</span> y_train<span class="token punctuation">,</span> y_test <span class="token operator">=</span> train_test_split<span class="token punctuation">(</span>x<span class="token punctuation">,</span> y<span class="token punctuation">,</span> test_size<span class="token operator">=</span><span class="token number">0.20</span><span class="token punctuation">,</span> random_state<span class="token operator">=</span><span class="token number">17</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h3 id="Word-Embedding"><a href="#Word-Embedding" class="headerlink" title="Word Embedding"></a>Word Embedding</h3><p>Build the word2vec model to do word embedding.</p>
<p>Reference:</p>
<ul>
<li><a target="_blank" rel="noopener" href="https://github.com/philipperemy/japanese-words-to-vectors/blob/master/README.md">https://github.com/philipperemy/japanese-words-to-vectors/blob/master/README.md</a>)</li>
<li><a target="_blank" rel="noopener" href="http://jalammar.github.io/illustrated-word2vec/">http://jalammar.github.io/illustrated-word2vec/</a></li>
</ul>
<p>Training a Japanese Wikipedia Word2Vec Model by Gensim and Mecab:</p>
<ul>
<li>Kyubyong Park’s <a target="_blank" rel="noopener" href="https://github.com/Kyubyong/wordvectors">GitHub</a></li>
<li>Omuram’s <a target="_blank" rel="noopener" href="https://qiita.com/omuram/items/6570973c090c6f0cb060">Qiita</a></li>
<li>TextMiner’s <a target="_blank" rel="noopener" href="https://textminingonline.com/training-a-japanese-wikipedia-word2vec-model-by-gensim-and-mecab">Website</a></li>
</ul>
<pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">def</span> <span class="token function">get_embedding_index</span><span class="token punctuation">(</span>model_path<span class="token punctuation">)</span><span class="token punctuation">:</span>
    w2v <span class="token operator">=</span> Word2Vec<span class="token punctuation">.</span>load<span class="token punctuation">(</span>model_path<span class="token punctuation">)</span>
    embedding_index <span class="token operator">=</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span>
    <span class="token keyword">for</span> word <span class="token keyword">in</span> w2v<span class="token punctuation">.</span>wv<span class="token punctuation">.</span>vocab<span class="token punctuation">:</span>
        embedding_index<span class="token punctuation">[</span>word<span class="token punctuation">]</span> <span class="token operator">=</span> w2v<span class="token punctuation">.</span>wv<span class="token punctuation">.</span>word_vec<span class="token punctuation">(</span>word<span class="token punctuation">)</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'Loaded &#123;&#125; word vectors.'</span><span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span><span class="token builtin">len</span><span class="token punctuation">(</span>embedding_index<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

    <span class="token keyword">return</span> embedding_index

<span class="token keyword">def</span> <span class="token function">get_embedding_matrix</span><span class="token punctuation">(</span>word2index<span class="token punctuation">,</span> embeddings_index<span class="token punctuation">,</span> embed_size<span class="token punctuation">)</span><span class="token punctuation">:</span>
    embedding_matrix <span class="token operator">=</span> np<span class="token punctuation">.</span>zeros<span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token builtin">len</span><span class="token punctuation">(</span>word2index<span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">,</span> embed_size<span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token keyword">for</span> word<span class="token punctuation">,</span> i <span class="token keyword">in</span> word2index<span class="token punctuation">.</span>items<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        embedding_vector <span class="token operator">=</span> embeddings_index<span class="token punctuation">.</span>get<span class="token punctuation">(</span>word<span class="token punctuation">)</span>
        <span class="token keyword">if</span> embedding_vector <span class="token keyword">is</span> <span class="token keyword">not</span> <span class="token boolean">None</span><span class="token punctuation">:</span>
            <span class="token comment"># words found in embedding index will be pretrained vectors.</span>
            embedding_matrix<span class="token punctuation">[</span>i<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">=</span> embedding_vector
        <span class="token keyword">else</span><span class="token punctuation">:</span>
            <span class="token comment"># words not found in embedding index will be random vectors with certain mean&amp;std.</span>
            embedding_matrix<span class="token punctuation">[</span>i<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">=</span> np<span class="token punctuation">.</span>random<span class="token punctuation">.</span>normal<span class="token punctuation">(</span><span class="token number">0.053</span><span class="token punctuation">,</span> <span class="token number">0.3146</span><span class="token punctuation">,</span> size<span class="token operator">=</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> embed_size<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>

    <span class="token comment"># save embedding matrix</span>
    <span class="token comment"># embed_df = pd.DataFrame(embedding_matrix)</span>
    <span class="token comment"># embed_df.to_csv(self.path_embedding_matrix, header=None, sep=' ')</span>

    <span class="token keyword">return</span> embedding_matrix

embedding_index <span class="token operator">=</span> get_embedding_index<span class="token punctuation">(</span>
    <span class="token string">r'C:\Users\YangWang\Desktop\Text_Classifier_for_UtaPass_and_KKBOX\word2vec\ja.bin'</span><span class="token punctuation">)</span>
embedding_matrix <span class="token operator">=</span> get_embedding_matrix<span class="token punctuation">(</span>word2index<span class="token punctuation">,</span> embedding_index<span class="token punctuation">,</span> embed_size<span class="token operator">=</span><span class="token number">300</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h3 id="Build-Model"><a href="#Build-Model" class="headerlink" title="Build Model"></a>Build Model</h3><p>Construct neural network architectures.</p>
<p>Reference:</p>
<ul>
<li>Asanilta Fahda’s <a target="_blank" rel="noopener" href="https://github.com/asanilta/amazon-sentiment-keras-experiment">GitHub</a></li>
<li>teratsyk’s <a target="_blank" rel="noopener" href="https://github.com/teratsyk/bokete-ai">GitHub</a></li>
</ul>
<p>Build a customised metrics function to record f1 value after each epoch.</p>
<pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">def</span> <span class="token function">get_f1</span><span class="token punctuation">(</span>y_true<span class="token punctuation">,</span> y_pred<span class="token punctuation">)</span><span class="token punctuation">:</span>
    true_positives <span class="token operator">=</span> K<span class="token punctuation">.</span><span class="token builtin">sum</span><span class="token punctuation">(</span>K<span class="token punctuation">.</span><span class="token builtin">round</span><span class="token punctuation">(</span>K<span class="token punctuation">.</span>clip<span class="token punctuation">(</span>y_true <span class="token operator">*</span> y_pred<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    possible_positives <span class="token operator">=</span> K<span class="token punctuation">.</span><span class="token builtin">sum</span><span class="token punctuation">(</span>K<span class="token punctuation">.</span><span class="token builtin">round</span><span class="token punctuation">(</span>K<span class="token punctuation">.</span>clip<span class="token punctuation">(</span>y_true<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    predicted_positives <span class="token operator">=</span> K<span class="token punctuation">.</span><span class="token builtin">sum</span><span class="token punctuation">(</span>K<span class="token punctuation">.</span><span class="token builtin">round</span><span class="token punctuation">(</span>K<span class="token punctuation">.</span>clip<span class="token punctuation">(</span>y_pred<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    precision <span class="token operator">=</span> true_positives <span class="token operator">/</span> <span class="token punctuation">(</span>predicted_positives <span class="token operator">+</span> K<span class="token punctuation">.</span>epsilon<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    recall <span class="token operator">=</span> true_positives <span class="token operator">/</span> <span class="token punctuation">(</span>possible_positives <span class="token operator">+</span> K<span class="token punctuation">.</span>epsilon<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    f1_val <span class="token operator">=</span> <span class="token number">2</span><span class="token operator">*</span><span class="token punctuation">(</span>precision<span class="token operator">*</span>recall<span class="token punctuation">)</span><span class="token operator">/</span><span class="token punctuation">(</span>precision<span class="token operator">+</span>recall<span class="token operator">+</span>K<span class="token punctuation">.</span>epsilon<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token keyword">return</span> f1_val<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>When training a neural network, f1 score is an important metric to evaluate the performance of classification models, especially for unbalanced classes where the binary accuracy is useless. So I biuld two helper functions <code>get_f1</code> and <code>predict</code>.</p>
<pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">def</span> <span class="token function">predict</span><span class="token punctuation">(</span>sentences<span class="token punctuation">,</span> model<span class="token punctuation">)</span><span class="token punctuation">:</span>
    y_prob <span class="token operator">=</span> model<span class="token punctuation">.</span>predict<span class="token punctuation">(</span>x_test<span class="token punctuation">)</span>
    y_prob <span class="token operator">=</span> y_prob<span class="token punctuation">.</span>squeeze<span class="token punctuation">(</span><span class="token punctuation">)</span>
    y_pred <span class="token operator">=</span> <span class="token punctuation">(</span>y_prob <span class="token operator">></span> <span class="token number">0.5</span><span class="token punctuation">)</span> 
    <span class="token keyword">return</span> y_pred<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>Set optimisers to update gradient.</p>
<pre class="line-numbers language-python" data-language="python"><code class="language-python">adagrad <span class="token operator">=</span> Adagrad<span class="token punctuation">(</span>learning_rate<span class="token operator">=</span><span class="token number">0.01</span><span class="token punctuation">)</span>
adadelta <span class="token operator">=</span> Adadelta<span class="token punctuation">(</span>learning_rate<span class="token operator">=</span><span class="token number">0.01</span><span class="token punctuation">,</span> rho<span class="token operator">=</span><span class="token number">0.95</span><span class="token punctuation">)</span>
rmsprop <span class="token operator">=</span> RMSprop<span class="token punctuation">(</span>learning_rate<span class="token operator">=</span><span class="token number">0.001</span><span class="token punctuation">,</span> rho<span class="token operator">=</span><span class="token number">0.9</span><span class="token punctuation">)</span>
nadam <span class="token operator">=</span> Nadam<span class="token punctuation">(</span>learning_rate<span class="token operator">=</span><span class="token number">0.001</span><span class="token punctuation">,</span> beta_1<span class="token operator">=</span><span class="token number">0.9</span><span class="token punctuation">,</span> beta_2<span class="token operator">=</span><span class="token number">0.999</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>

<h4 id="Simple-RNN"><a href="#Simple-RNN" class="headerlink" title="Simple RNN"></a>Simple RNN</h4><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">def</span> <span class="token function">train_simple_rnn</span><span class="token punctuation">(</span>x_train<span class="token punctuation">,</span> y_train<span class="token punctuation">,</span> wv_matrix<span class="token punctuation">,</span> verbose<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">,</span> load_weights<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    tf<span class="token punctuation">.</span>keras<span class="token punctuation">.</span>backend<span class="token punctuation">.</span>clear_session<span class="token punctuation">(</span><span class="token punctuation">)</span>
    
    x_input <span class="token operator">=</span> Input<span class="token punctuation">(</span>shape<span class="token operator">=</span><span class="token punctuation">(</span>config<span class="token punctuation">[</span><span class="token string">"MAX_LEN"</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">)</span><span class="token punctuation">)</span>
    x <span class="token operator">=</span> Embedding<span class="token punctuation">(</span>wv_matrix<span class="token punctuation">.</span>shape<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> wv_matrix<span class="token punctuation">.</span>shape<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span> weights<span class="token operator">=</span><span class="token punctuation">[</span>wv_matrix<span class="token punctuation">]</span><span class="token punctuation">,</span> trainable<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">)</span><span class="token punctuation">(</span>x_input<span class="token punctuation">)</span>
    x <span class="token operator">=</span> SpatialDropout1D<span class="token punctuation">(</span>config<span class="token punctuation">[</span><span class="token string">'dropout_rate'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">(</span>x<span class="token punctuation">)</span>
    x <span class="token operator">=</span> SimpleRNN<span class="token punctuation">(</span>
        units<span class="token operator">=</span>config<span class="token punctuation">[</span><span class="token string">"output_size"</span><span class="token punctuation">]</span><span class="token punctuation">,</span> 
        activation<span class="token operator">=</span>config<span class="token punctuation">[</span><span class="token string">"rnn_activation"</span><span class="token punctuation">]</span><span class="token punctuation">,</span> 
        kernel_regularizer<span class="token operator">=</span>regularizers<span class="token punctuation">.</span>l2<span class="token punctuation">(</span><span class="token number">0.3</span><span class="token punctuation">)</span><span class="token punctuation">,</span> 
        return_sequences<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span><span class="token punctuation">(</span>x<span class="token punctuation">)</span>
    x <span class="token operator">=</span> SimpleRNN<span class="token punctuation">(</span>
        units<span class="token operator">=</span>config<span class="token punctuation">[</span><span class="token string">"output_size"</span><span class="token punctuation">]</span><span class="token punctuation">,</span> 
        activation<span class="token operator">=</span>config<span class="token punctuation">[</span><span class="token string">"rnn_activation"</span><span class="token punctuation">]</span><span class="token punctuation">,</span> 
        kernel_regularizer<span class="token operator">=</span>regularizers<span class="token punctuation">.</span>l2<span class="token punctuation">(</span><span class="token number">0.3</span><span class="token punctuation">)</span><span class="token punctuation">,</span> 
        return_sequences<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">)</span><span class="token punctuation">(</span>x<span class="token punctuation">)</span>
    x <span class="token operator">=</span> Dropout<span class="token punctuation">(</span>config<span class="token punctuation">[</span><span class="token string">'dropout_rate'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">(</span>x<span class="token punctuation">)</span>
    x <span class="token operator">=</span> Dense<span class="token punctuation">(</span>units<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">(</span>x<span class="token punctuation">)</span>
    x <span class="token operator">=</span> Activation<span class="token punctuation">(</span><span class="token string">'sigmoid'</span><span class="token punctuation">)</span><span class="token punctuation">(</span>x<span class="token punctuation">)</span>
    model <span class="token operator">=</span> Model<span class="token punctuation">(</span>inputs<span class="token operator">=</span>x_input<span class="token punctuation">,</span> outputs<span class="token operator">=</span>x<span class="token punctuation">)</span>

    <span class="token keyword">if</span> <span class="token keyword">not</span> load_weights<span class="token punctuation">:</span> 
        model<span class="token punctuation">.</span><span class="token builtin">compile</span><span class="token punctuation">(</span>loss<span class="token operator">=</span>config<span class="token punctuation">[</span><span class="token string">"loss"</span><span class="token punctuation">]</span><span class="token punctuation">,</span> 
                      optimizer<span class="token operator">=</span>adagrad<span class="token punctuation">,</span> 
                      metrics<span class="token operator">=</span><span class="token punctuation">[</span>get_f1<span class="token punctuation">]</span><span class="token punctuation">)</span>

        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"="</span><span class="token operator">*</span><span class="token number">20</span><span class="token punctuation">,</span> <span class="token string">"Start Training Simple RNN"</span><span class="token punctuation">,</span> <span class="token string">"="</span><span class="token operator">*</span><span class="token number">20</span><span class="token punctuation">)</span>

        path <span class="token operator">=</span> <span class="token string">r'C:\Users\YangWang\Desktop\UtaPass_KKBOX_Classifier\weights\rnn_weights.hdf5'</span>
        model_checkpoint <span class="token operator">=</span> ModelCheckpoint<span class="token punctuation">(</span>path<span class="token punctuation">,</span> monitor<span class="token operator">=</span><span class="token string">'val_loss'</span><span class="token punctuation">,</span> verbose<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">,</span> save_best_only<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">,</span> mode<span class="token operator">=</span><span class="token string">'auto'</span><span class="token punctuation">)</span>
        early_stopping <span class="token operator">=</span> EarlyStopping<span class="token punctuation">(</span>monitor<span class="token operator">=</span><span class="token string">'val_loss'</span><span class="token punctuation">,</span> patience<span class="token operator">=</span><span class="token number">20</span><span class="token punctuation">,</span> verbose<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">,</span> mode<span class="token operator">=</span><span class="token string">'auto'</span><span class="token punctuation">)</span>
        reduce_lr <span class="token operator">=</span> ReduceLROnPlateau<span class="token punctuation">(</span>monitor<span class="token operator">=</span><span class="token string">'val_loss'</span><span class="token punctuation">,</span> factor<span class="token operator">=</span><span class="token number">0.2</span><span class="token punctuation">,</span> patience<span class="token operator">=</span><span class="token number">10</span><span class="token punctuation">,</span> min_lr<span class="token operator">=</span><span class="token number">0.001</span><span class="token punctuation">)</span>

        history <span class="token operator">=</span> model<span class="token punctuation">.</span>fit<span class="token punctuation">(</span>
            x_train<span class="token punctuation">,</span> y_train<span class="token punctuation">,</span> 
            batch_size<span class="token operator">=</span>config<span class="token punctuation">[</span><span class="token string">'batch_size'</span><span class="token punctuation">]</span><span class="token punctuation">,</span> 
            epochs<span class="token operator">=</span>config<span class="token punctuation">[</span><span class="token string">'nb_epoch'</span><span class="token punctuation">]</span><span class="token punctuation">,</span> 
            validation_split<span class="token operator">=</span>config<span class="token punctuation">[</span><span class="token string">'validation_split'</span><span class="token punctuation">]</span><span class="token punctuation">,</span> 
            shuffle<span class="token operator">=</span>config<span class="token punctuation">[</span><span class="token string">'shuffle'</span><span class="token punctuation">]</span><span class="token punctuation">,</span> 
            verbose<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">,</span> 
            callbacks<span class="token operator">=</span><span class="token punctuation">[</span>early_stopping<span class="token punctuation">,</span> reduce_lr<span class="token punctuation">,</span> model_checkpoint<span class="token punctuation">]</span><span class="token punctuation">)</span>
    <span class="token keyword">if</span> load_weights<span class="token punctuation">:</span>
        history <span class="token operator">=</span> <span class="token boolean">None</span>
        path <span class="token operator">=</span> <span class="token string">r'C:\Users\YangWang\Desktop\UtaPass_KKBOX_Classifier\weights\rnn_weights.hdf5'</span>
        model<span class="token punctuation">.</span>load_weights<span class="token punctuation">(</span>path<span class="token punctuation">)</span>
    
    <span class="token keyword">return</span> history<span class="token punctuation">,</span> model<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h4 id="GRU"><a href="#GRU" class="headerlink" title="GRU"></a>GRU</h4><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">def</span> <span class="token function">train_gru</span><span class="token punctuation">(</span>x_train<span class="token punctuation">,</span> y_train<span class="token punctuation">,</span> wv_matrix<span class="token punctuation">,</span> verbose<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">,</span> load_weights<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    tf<span class="token punctuation">.</span>keras<span class="token punctuation">.</span>backend<span class="token punctuation">.</span>clear_session<span class="token punctuation">(</span><span class="token punctuation">)</span>
    
    x_input <span class="token operator">=</span> Input<span class="token punctuation">(</span>shape<span class="token operator">=</span><span class="token punctuation">(</span>config<span class="token punctuation">[</span><span class="token string">"MAX_LEN"</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">)</span><span class="token punctuation">)</span>
    x <span class="token operator">=</span> Embedding<span class="token punctuation">(</span>wv_matrix<span class="token punctuation">.</span>shape<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> wv_matrix<span class="token punctuation">.</span>shape<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span> weights<span class="token operator">=</span><span class="token punctuation">[</span>wv_matrix<span class="token punctuation">]</span><span class="token punctuation">,</span> trainable<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">)</span><span class="token punctuation">(</span>x_input<span class="token punctuation">)</span>
    x <span class="token operator">=</span> SpatialDropout1D<span class="token punctuation">(</span>config<span class="token punctuation">[</span><span class="token string">'dropout_rate'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">(</span>x<span class="token punctuation">)</span>
    x <span class="token operator">=</span> GRU<span class="token punctuation">(</span>units<span class="token operator">=</span>config<span class="token punctuation">[</span><span class="token string">"output_size"</span><span class="token punctuation">]</span><span class="token punctuation">,</span> return_sequences<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">,</span> dropout<span class="token operator">=</span>config<span class="token punctuation">[</span><span class="token string">'dropout_rate'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">(</span>x<span class="token punctuation">)</span>
    x <span class="token operator">=</span> GRU<span class="token punctuation">(</span>units<span class="token operator">=</span>config<span class="token punctuation">[</span><span class="token string">"output_size"</span><span class="token punctuation">]</span><span class="token punctuation">,</span> return_sequences<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">,</span> dropout<span class="token operator">=</span>config<span class="token punctuation">[</span><span class="token string">'dropout_rate'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">(</span>x<span class="token punctuation">)</span>
    x <span class="token operator">=</span> Dropout<span class="token punctuation">(</span>config<span class="token punctuation">[</span><span class="token string">'dropout_rate'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">(</span>x<span class="token punctuation">)</span>
    x <span class="token operator">=</span> Dense<span class="token punctuation">(</span>units<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">(</span>x<span class="token punctuation">)</span>
    x <span class="token operator">=</span> Activation<span class="token punctuation">(</span><span class="token string">'sigmoid'</span><span class="token punctuation">)</span><span class="token punctuation">(</span>x<span class="token punctuation">)</span>
    model <span class="token operator">=</span> Model<span class="token punctuation">(</span>inputs<span class="token operator">=</span>x_input<span class="token punctuation">,</span> outputs<span class="token operator">=</span>x<span class="token punctuation">)</span>

    <span class="token keyword">if</span> <span class="token keyword">not</span> load_weights<span class="token punctuation">:</span>
        model<span class="token punctuation">.</span><span class="token builtin">compile</span><span class="token punctuation">(</span>loss<span class="token operator">=</span>config<span class="token punctuation">[</span><span class="token string">"loss"</span><span class="token punctuation">]</span><span class="token punctuation">,</span> 
                      optimizer<span class="token operator">=</span>rmsprop<span class="token punctuation">,</span> 
                      metrics<span class="token operator">=</span><span class="token punctuation">[</span>get_f1<span class="token punctuation">]</span><span class="token punctuation">)</span>

        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"="</span><span class="token operator">*</span><span class="token number">20</span><span class="token punctuation">,</span> <span class="token string">"Start Training GRU"</span><span class="token punctuation">,</span> <span class="token string">"="</span><span class="token operator">*</span><span class="token number">20</span><span class="token punctuation">)</span>

        path <span class="token operator">=</span> <span class="token string">r'C:\Users\YangWang\Desktop\UtaPass_KKBOX_Classifier\weights\gru_weights.hdf5'</span>
        model_checkpoint <span class="token operator">=</span> ModelCheckpoint<span class="token punctuation">(</span>path<span class="token punctuation">,</span> monitor<span class="token operator">=</span><span class="token string">'val_loss'</span><span class="token punctuation">,</span> verbose<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">,</span> save_best_only<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">,</span> mode<span class="token operator">=</span><span class="token string">'auto'</span><span class="token punctuation">)</span>
        early_stopping <span class="token operator">=</span> EarlyStopping<span class="token punctuation">(</span>monitor<span class="token operator">=</span><span class="token string">'val_loss'</span><span class="token punctuation">,</span> patience<span class="token operator">=</span><span class="token number">20</span><span class="token punctuation">,</span> verbose<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">,</span> mode<span class="token operator">=</span><span class="token string">'auto'</span><span class="token punctuation">)</span>
        reduce_lr <span class="token operator">=</span> ReduceLROnPlateau<span class="token punctuation">(</span>monitor<span class="token operator">=</span><span class="token string">'val_loss'</span><span class="token punctuation">,</span> factor<span class="token operator">=</span><span class="token number">0.2</span><span class="token punctuation">,</span> patience<span class="token operator">=</span><span class="token number">10</span><span class="token punctuation">,</span> min_lr<span class="token operator">=</span><span class="token number">0.001</span><span class="token punctuation">)</span>

        history <span class="token operator">=</span> model<span class="token punctuation">.</span>fit<span class="token punctuation">(</span>
            x_train<span class="token punctuation">,</span> y_train<span class="token punctuation">,</span> 
            batch_size<span class="token operator">=</span>config<span class="token punctuation">[</span><span class="token string">'batch_size'</span><span class="token punctuation">]</span><span class="token punctuation">,</span> 
            epochs<span class="token operator">=</span>config<span class="token punctuation">[</span><span class="token string">'nb_epoch'</span><span class="token punctuation">]</span><span class="token punctuation">,</span> 
            validation_split<span class="token operator">=</span>config<span class="token punctuation">[</span><span class="token string">'validation_split'</span><span class="token punctuation">]</span><span class="token punctuation">,</span> 
            shuffle<span class="token operator">=</span>config<span class="token punctuation">[</span><span class="token string">'shuffle'</span><span class="token punctuation">]</span><span class="token punctuation">,</span> 
            verbose<span class="token operator">=</span>verbose<span class="token punctuation">,</span> 
            callbacks<span class="token operator">=</span><span class="token punctuation">[</span>early_stopping<span class="token punctuation">,</span> reduce_lr<span class="token punctuation">,</span> model_checkpoint<span class="token punctuation">]</span><span class="token punctuation">)</span>
    <span class="token keyword">if</span> load_weights<span class="token punctuation">:</span>
        history <span class="token operator">=</span> <span class="token boolean">None</span>
        path <span class="token operator">=</span> <span class="token string">r'C:\Users\YangWang\Desktop\UtaPass_KKBOX_Classifier\weights\gru_weights.hdf5'</span>
        model<span class="token punctuation">.</span>load_weights<span class="token punctuation">(</span>path<span class="token punctuation">)</span>
    
    <span class="token keyword">return</span> history<span class="token punctuation">,</span> model<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h4 id="LSTM"><a href="#LSTM" class="headerlink" title="LSTM"></a>LSTM</h4><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">def</span> <span class="token function">train_lstm</span><span class="token punctuation">(</span>x_train<span class="token punctuation">,</span> y_train<span class="token punctuation">,</span> wv_matrix<span class="token punctuation">,</span> verbose<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">,</span> load_weights<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    tf<span class="token punctuation">.</span>keras<span class="token punctuation">.</span>backend<span class="token punctuation">.</span>clear_session<span class="token punctuation">(</span><span class="token punctuation">)</span>
    
    x_input <span class="token operator">=</span> Input<span class="token punctuation">(</span>shape<span class="token operator">=</span><span class="token punctuation">(</span>config<span class="token punctuation">[</span><span class="token string">"MAX_LEN"</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">)</span><span class="token punctuation">)</span>
    x <span class="token operator">=</span> Embedding<span class="token punctuation">(</span>wv_matrix<span class="token punctuation">.</span>shape<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> wv_matrix<span class="token punctuation">.</span>shape<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span> weights<span class="token operator">=</span><span class="token punctuation">[</span>wv_matrix<span class="token punctuation">]</span><span class="token punctuation">,</span> trainable<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">)</span><span class="token punctuation">(</span>x_input<span class="token punctuation">)</span>
    x <span class="token operator">=</span> SpatialDropout1D<span class="token punctuation">(</span>config<span class="token punctuation">[</span><span class="token string">'dropout_rate'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">(</span>x<span class="token punctuation">)</span>
    x <span class="token operator">=</span> LSTM<span class="token punctuation">(</span>units<span class="token operator">=</span>config<span class="token punctuation">[</span><span class="token string">'lstm_cell'</span><span class="token punctuation">]</span><span class="token punctuation">,</span> return_sequences<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">,</span> kernel_regularizer<span class="token operator">=</span>regularizers<span class="token punctuation">.</span>l2<span class="token punctuation">(</span><span class="token number">0.3</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">(</span>x<span class="token punctuation">)</span>
    x <span class="token operator">=</span> LSTM<span class="token punctuation">(</span>units<span class="token operator">=</span>config<span class="token punctuation">[</span><span class="token string">'lstm_cell'</span><span class="token punctuation">]</span><span class="token punctuation">,</span> return_sequences<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">,</span> kernel_regularizer<span class="token operator">=</span>regularizers<span class="token punctuation">.</span>l2<span class="token punctuation">(</span><span class="token number">0.3</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">(</span>x<span class="token punctuation">)</span>
    x <span class="token operator">=</span> Dropout<span class="token punctuation">(</span>config<span class="token punctuation">[</span><span class="token string">'dropout_rate'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">(</span>x<span class="token punctuation">)</span>
    x <span class="token operator">=</span> Dense<span class="token punctuation">(</span>units<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">(</span>x<span class="token punctuation">)</span>
    x <span class="token operator">=</span> Activation<span class="token punctuation">(</span><span class="token string">'sigmoid'</span><span class="token punctuation">)</span><span class="token punctuation">(</span>x<span class="token punctuation">)</span>
    model <span class="token operator">=</span> Model<span class="token punctuation">(</span>inputs<span class="token operator">=</span>x_input<span class="token punctuation">,</span> outputs<span class="token operator">=</span>x<span class="token punctuation">)</span>

    <span class="token keyword">if</span> <span class="token keyword">not</span> load_weights<span class="token punctuation">:</span> 
        model<span class="token punctuation">.</span><span class="token builtin">compile</span><span class="token punctuation">(</span>loss<span class="token operator">=</span>config<span class="token punctuation">[</span><span class="token string">"loss"</span><span class="token punctuation">]</span><span class="token punctuation">,</span> 
                      optimizer<span class="token operator">=</span>adagrad<span class="token punctuation">,</span> 
                      metrics<span class="token operator">=</span><span class="token punctuation">[</span>get_f1<span class="token punctuation">]</span><span class="token punctuation">)</span>

        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"="</span><span class="token operator">*</span><span class="token number">20</span><span class="token punctuation">,</span> <span class="token string">"Start Training LSTM"</span><span class="token punctuation">,</span> <span class="token string">"="</span><span class="token operator">*</span><span class="token number">20</span><span class="token punctuation">)</span>

        path <span class="token operator">=</span> <span class="token string">r'C:\Users\YangWang\Desktop\Text_Classifier_for_UtaPass_and_KKBOX\weights\lstm_weights.hdf5'</span>
        model_checkpoint <span class="token operator">=</span> ModelCheckpoint<span class="token punctuation">(</span>path<span class="token punctuation">,</span> monitor<span class="token operator">=</span><span class="token string">'val_loss'</span><span class="token punctuation">,</span> verbose<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">,</span> save_best_only<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">,</span> mode<span class="token operator">=</span><span class="token string">'auto'</span><span class="token punctuation">)</span>
        early_stopping <span class="token operator">=</span> EarlyStopping<span class="token punctuation">(</span>monitor<span class="token operator">=</span><span class="token string">'val_loss'</span><span class="token punctuation">,</span> patience<span class="token operator">=</span><span class="token number">20</span><span class="token punctuation">,</span> verbose<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">,</span> mode<span class="token operator">=</span><span class="token string">'auto'</span><span class="token punctuation">)</span>
        reduce_lr <span class="token operator">=</span> ReduceLROnPlateau<span class="token punctuation">(</span>monitor<span class="token operator">=</span><span class="token string">'val_loss'</span><span class="token punctuation">,</span> factor<span class="token operator">=</span><span class="token number">0.2</span><span class="token punctuation">,</span> patience<span class="token operator">=</span><span class="token number">10</span><span class="token punctuation">,</span> min_lr<span class="token operator">=</span><span class="token number">0.001</span><span class="token punctuation">)</span>

        history <span class="token operator">=</span> model<span class="token punctuation">.</span>fit<span class="token punctuation">(</span>
            x_train<span class="token punctuation">,</span> y_train<span class="token punctuation">,</span> 
            batch_size<span class="token operator">=</span>config<span class="token punctuation">[</span><span class="token string">'batch_size'</span><span class="token punctuation">]</span><span class="token punctuation">,</span> 
            epochs<span class="token operator">=</span>config<span class="token punctuation">[</span><span class="token string">'nb_epoch'</span><span class="token punctuation">]</span><span class="token punctuation">,</span> 
            validation_split<span class="token operator">=</span>config<span class="token punctuation">[</span><span class="token string">'validation_split'</span><span class="token punctuation">]</span><span class="token punctuation">,</span> 
            shuffle<span class="token operator">=</span>config<span class="token punctuation">[</span><span class="token string">'shuffle'</span><span class="token punctuation">]</span><span class="token punctuation">,</span> 
            verbose<span class="token operator">=</span>verbose<span class="token punctuation">,</span> 
            callbacks<span class="token operator">=</span><span class="token punctuation">[</span>early_stopping<span class="token punctuation">,</span> reduce_lr<span class="token punctuation">,</span> model_checkpoint<span class="token punctuation">]</span><span class="token punctuation">)</span>
    <span class="token keyword">if</span> load_weights<span class="token punctuation">:</span>
        history <span class="token operator">=</span> <span class="token boolean">None</span>
        path <span class="token operator">=</span> <span class="token string">r'C:\Users\YangWang\Desktop\Text_Classifier_for_UtaPass_and_KKBOX\weights\lstm_weights.hdf5'</span>
        model<span class="token punctuation">.</span>load_weights<span class="token punctuation">(</span>path<span class="token punctuation">)</span>
    
    <span class="token keyword">return</span> history<span class="token punctuation">,</span> model<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h4 id="BiLSTM"><a href="#BiLSTM" class="headerlink" title="BiLSTM"></a>BiLSTM</h4><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">def</span> <span class="token function">train_bilstm</span><span class="token punctuation">(</span>x_train<span class="token punctuation">,</span> y_train<span class="token punctuation">,</span> wv_matrix<span class="token punctuation">,</span> verbose<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">,</span> load_weights<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    tf<span class="token punctuation">.</span>keras<span class="token punctuation">.</span>backend<span class="token punctuation">.</span>clear_session<span class="token punctuation">(</span><span class="token punctuation">)</span>
    
    x_input <span class="token operator">=</span> Input<span class="token punctuation">(</span>shape<span class="token operator">=</span><span class="token punctuation">(</span>config<span class="token punctuation">[</span><span class="token string">"MAX_LEN"</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">)</span><span class="token punctuation">)</span>
    x <span class="token operator">=</span> Embedding<span class="token punctuation">(</span>wv_matrix<span class="token punctuation">.</span>shape<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> wv_matrix<span class="token punctuation">.</span>shape<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span> weights<span class="token operator">=</span><span class="token punctuation">[</span>wv_matrix<span class="token punctuation">]</span><span class="token punctuation">,</span> trainable<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">)</span><span class="token punctuation">(</span>x_input<span class="token punctuation">)</span>
    x <span class="token operator">=</span> SpatialDropout1D<span class="token punctuation">(</span>config<span class="token punctuation">[</span><span class="token string">'dropout_rate'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">(</span>x<span class="token punctuation">)</span>
    x <span class="token operator">=</span> Bidirectional<span class="token punctuation">(</span>LSTM<span class="token punctuation">(</span>
        units<span class="token operator">=</span>config<span class="token punctuation">[</span><span class="token string">'lstm_cell'</span><span class="token punctuation">]</span><span class="token punctuation">,</span> 
        return_sequences<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">,</span> 
        dropout<span class="token operator">=</span>config<span class="token punctuation">[</span><span class="token string">'dropout_rate'</span><span class="token punctuation">]</span><span class="token punctuation">,</span> 
        kernel_regularizer<span class="token operator">=</span>regularizers<span class="token punctuation">.</span>l2<span class="token punctuation">(</span><span class="token number">0.3</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">(</span>x<span class="token punctuation">)</span>
    x <span class="token operator">=</span> Bidirectional<span class="token punctuation">(</span>LSTM<span class="token punctuation">(</span>
        units<span class="token operator">=</span>config<span class="token punctuation">[</span><span class="token string">'lstm_cell'</span><span class="token punctuation">]</span><span class="token punctuation">,</span> 
        return_sequences<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">,</span> 
        kernel_regularizer<span class="token operator">=</span>regularizers<span class="token punctuation">.</span>l2<span class="token punctuation">(</span><span class="token number">0.3</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">(</span>x<span class="token punctuation">)</span>
    x <span class="token operator">=</span> Dropout<span class="token punctuation">(</span>config<span class="token punctuation">[</span><span class="token string">'dropout_rate'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">(</span>x<span class="token punctuation">)</span>
    x <span class="token operator">=</span> Dense<span class="token punctuation">(</span>config<span class="token punctuation">[</span><span class="token string">'fc_cell'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">(</span>x<span class="token punctuation">)</span>
    x <span class="token operator">=</span> Dropout<span class="token punctuation">(</span>config<span class="token punctuation">[</span><span class="token string">'dropout_rate'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">(</span>x<span class="token punctuation">)</span>
    x <span class="token operator">=</span> Dense<span class="token punctuation">(</span>units<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">(</span>x<span class="token punctuation">)</span>
    x <span class="token operator">=</span> Activation<span class="token punctuation">(</span><span class="token string">'sigmoid'</span><span class="token punctuation">)</span><span class="token punctuation">(</span>x<span class="token punctuation">)</span>
    model <span class="token operator">=</span> Model<span class="token punctuation">(</span>inputs<span class="token operator">=</span>x_input<span class="token punctuation">,</span> outputs<span class="token operator">=</span>x<span class="token punctuation">)</span>

    <span class="token keyword">if</span> <span class="token keyword">not</span> load_weights<span class="token punctuation">:</span>
        model<span class="token punctuation">.</span><span class="token builtin">compile</span><span class="token punctuation">(</span>loss<span class="token operator">=</span>config<span class="token punctuation">[</span><span class="token string">"loss"</span><span class="token punctuation">]</span><span class="token punctuation">,</span> 
                      optimizer<span class="token operator">=</span>adagrad<span class="token punctuation">,</span> 
                      metrics<span class="token operator">=</span><span class="token punctuation">[</span>get_f1<span class="token punctuation">]</span><span class="token punctuation">)</span>

        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"="</span><span class="token operator">*</span><span class="token number">20</span><span class="token punctuation">,</span> <span class="token string">"Start Training BiLSTM"</span><span class="token punctuation">,</span> <span class="token string">"="</span><span class="token operator">*</span><span class="token number">20</span><span class="token punctuation">)</span>

        path <span class="token operator">=</span> <span class="token string">r'C:\Users\YangWang\Desktop\Text_Classifier_for_UtaPass_and_KKBOX\weights\bilstm_weights.hdf5'</span>
        model_checkpoint <span class="token operator">=</span> ModelCheckpoint<span class="token punctuation">(</span>path<span class="token punctuation">,</span> monitor<span class="token operator">=</span><span class="token string">'val_loss'</span><span class="token punctuation">,</span> verbose<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">,</span> save_best_only<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">,</span> mode<span class="token operator">=</span><span class="token string">'auto'</span><span class="token punctuation">)</span>
        early_stopping <span class="token operator">=</span> EarlyStopping<span class="token punctuation">(</span>monitor<span class="token operator">=</span><span class="token string">'val_loss'</span><span class="token punctuation">,</span> patience<span class="token operator">=</span><span class="token number">20</span><span class="token punctuation">,</span> verbose<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">,</span> mode<span class="token operator">=</span><span class="token string">'auto'</span><span class="token punctuation">)</span>
        reduce_lr <span class="token operator">=</span> ReduceLROnPlateau<span class="token punctuation">(</span>monitor<span class="token operator">=</span><span class="token string">'val_loss'</span><span class="token punctuation">,</span> factor<span class="token operator">=</span><span class="token number">0.2</span><span class="token punctuation">,</span> patience<span class="token operator">=</span><span class="token number">10</span><span class="token punctuation">,</span> min_lr<span class="token operator">=</span><span class="token number">0.001</span><span class="token punctuation">)</span>

        history <span class="token operator">=</span> model<span class="token punctuation">.</span>fit<span class="token punctuation">(</span>
            x_train<span class="token punctuation">,</span> y_train<span class="token punctuation">,</span> 
            batch_size<span class="token operator">=</span>config<span class="token punctuation">[</span><span class="token string">'batch_size'</span><span class="token punctuation">]</span><span class="token punctuation">,</span> 
            epochs<span class="token operator">=</span>config<span class="token punctuation">[</span><span class="token string">'nb_epoch'</span><span class="token punctuation">]</span><span class="token punctuation">,</span> 
            validation_split<span class="token operator">=</span>config<span class="token punctuation">[</span><span class="token string">'validation_split'</span><span class="token punctuation">]</span><span class="token punctuation">,</span> 
            shuffle<span class="token operator">=</span>config<span class="token punctuation">[</span><span class="token string">'shuffle'</span><span class="token punctuation">]</span><span class="token punctuation">,</span> 
            verbose<span class="token operator">=</span>verbose<span class="token punctuation">,</span> 
            callbacks<span class="token operator">=</span><span class="token punctuation">[</span>early_stopping<span class="token punctuation">,</span> reduce_lr<span class="token punctuation">,</span> model_checkpoint<span class="token punctuation">]</span><span class="token punctuation">)</span>
    <span class="token keyword">if</span> load_weights<span class="token punctuation">:</span>
        history <span class="token operator">=</span> <span class="token boolean">None</span>
        path <span class="token operator">=</span> <span class="token string">r'C:\Users\YangWang\Desktop\Text_Classifier_for_UtaPass_and_KKBOX\weights\bilstm_weights.hdf5'</span>
        model<span class="token punctuation">.</span>load_weights<span class="token punctuation">(</span>path<span class="token punctuation">)</span>
    
    <span class="token keyword">return</span> history<span class="token punctuation">,</span> model<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h4 id="Attention"><a href="#Attention" class="headerlink" title="Attention"></a>Attention</h4><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">def</span> <span class="token function">train_attention</span><span class="token punctuation">(</span>x_train<span class="token punctuation">,</span> y_train<span class="token punctuation">,</span> wv_matrix<span class="token punctuation">,</span> verbose<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">,</span> load_weights<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    tf<span class="token punctuation">.</span>keras<span class="token punctuation">.</span>backend<span class="token punctuation">.</span>clear_session<span class="token punctuation">(</span><span class="token punctuation">)</span>
    
    x_input <span class="token operator">=</span> Input<span class="token punctuation">(</span>shape<span class="token operator">=</span><span class="token punctuation">(</span>config<span class="token punctuation">[</span><span class="token string">"MAX_LEN"</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">)</span><span class="token punctuation">)</span>
    x <span class="token operator">=</span> Embedding<span class="token punctuation">(</span>wv_matrix<span class="token punctuation">.</span>shape<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> wv_matrix<span class="token punctuation">.</span>shape<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span> weights<span class="token operator">=</span><span class="token punctuation">[</span>wv_matrix<span class="token punctuation">]</span><span class="token punctuation">,</span> trainable<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">)</span><span class="token punctuation">(</span>x_input<span class="token punctuation">)</span>
    x <span class="token operator">=</span> SpatialDropout1D<span class="token punctuation">(</span>config<span class="token punctuation">[</span><span class="token string">'dropout_rate'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">(</span>x<span class="token punctuation">)</span>
    x <span class="token operator">=</span> SeqSelfAttention<span class="token punctuation">(</span>units<span class="token operator">=</span><span class="token number">128</span><span class="token punctuation">,</span> kernel_regularizer<span class="token operator">=</span>regularizers<span class="token punctuation">.</span>l2<span class="token punctuation">(</span><span class="token number">0.1</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">(</span>x<span class="token punctuation">)</span>
    x <span class="token operator">=</span> SeqSelfAttention<span class="token punctuation">(</span>units<span class="token operator">=</span><span class="token number">128</span><span class="token punctuation">,</span> kernel_regularizer<span class="token operator">=</span>regularizers<span class="token punctuation">.</span>l2<span class="token punctuation">(</span><span class="token number">0.1</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">(</span>x<span class="token punctuation">)</span>
    x <span class="token operator">=</span> SeqSelfAttention<span class="token punctuation">(</span>units<span class="token operator">=</span><span class="token number">128</span><span class="token punctuation">,</span> kernel_regularizer<span class="token operator">=</span>regularizers<span class="token punctuation">.</span>l2<span class="token punctuation">(</span><span class="token number">0.1</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">(</span>x<span class="token punctuation">)</span>
    x <span class="token operator">=</span> SeqSelfAttention<span class="token punctuation">(</span>units<span class="token operator">=</span><span class="token number">128</span><span class="token punctuation">,</span> kernel_regularizer<span class="token operator">=</span>regularizers<span class="token punctuation">.</span>l2<span class="token punctuation">(</span><span class="token number">0.1</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">(</span>x<span class="token punctuation">)</span>
    x <span class="token operator">=</span> SeqSelfAttention<span class="token punctuation">(</span>units<span class="token operator">=</span><span class="token number">128</span><span class="token punctuation">,</span> kernel_regularizer<span class="token operator">=</span>regularizers<span class="token punctuation">.</span>l2<span class="token punctuation">(</span><span class="token number">0.1</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">(</span>x<span class="token punctuation">)</span>
    x <span class="token operator">=</span> SeqSelfAttention<span class="token punctuation">(</span>units<span class="token operator">=</span><span class="token number">128</span><span class="token punctuation">,</span> kernel_regularizer<span class="token operator">=</span>regularizers<span class="token punctuation">.</span>l2<span class="token punctuation">(</span><span class="token number">0.1</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">(</span>x<span class="token punctuation">)</span>
    x <span class="token operator">=</span> SeqSelfAttention<span class="token punctuation">(</span>units<span class="token operator">=</span><span class="token number">128</span><span class="token punctuation">,</span> kernel_regularizer<span class="token operator">=</span>regularizers<span class="token punctuation">.</span>l2<span class="token punctuation">(</span><span class="token number">0.1</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">(</span>x<span class="token punctuation">)</span>
    x <span class="token operator">=</span> SeqSelfAttention<span class="token punctuation">(</span>units<span class="token operator">=</span><span class="token number">128</span><span class="token punctuation">,</span> kernel_regularizer<span class="token operator">=</span>regularizers<span class="token punctuation">.</span>l2<span class="token punctuation">(</span><span class="token number">0.1</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">(</span>x<span class="token punctuation">)</span>
    x <span class="token operator">=</span> Flatten<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">(</span>x<span class="token punctuation">)</span>
    x <span class="token operator">=</span> Dropout<span class="token punctuation">(</span>config<span class="token punctuation">[</span><span class="token string">'dropout_rate'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">(</span>x<span class="token punctuation">)</span>
    x <span class="token operator">=</span> Dense<span class="token punctuation">(</span>units<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">(</span>x<span class="token punctuation">)</span>
    x <span class="token operator">=</span> Activation<span class="token punctuation">(</span><span class="token string">'sigmoid'</span><span class="token punctuation">)</span><span class="token punctuation">(</span>x<span class="token punctuation">)</span>
    model <span class="token operator">=</span> Model<span class="token punctuation">(</span>inputs<span class="token operator">=</span>x_input<span class="token punctuation">,</span> outputs<span class="token operator">=</span>x<span class="token punctuation">)</span>

    <span class="token keyword">if</span> <span class="token keyword">not</span> load_weights<span class="token punctuation">:</span>
        model<span class="token punctuation">.</span><span class="token builtin">compile</span><span class="token punctuation">(</span>loss<span class="token operator">=</span>config<span class="token punctuation">[</span><span class="token string">"loss"</span><span class="token punctuation">]</span><span class="token punctuation">,</span> 
                      optimizer<span class="token operator">=</span>adagrad<span class="token punctuation">,</span> 
                      metrics<span class="token operator">=</span><span class="token punctuation">[</span>get_f1<span class="token punctuation">]</span><span class="token punctuation">)</span>

        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"="</span><span class="token operator">*</span><span class="token number">20</span><span class="token punctuation">,</span> <span class="token string">"Start Training Attention"</span><span class="token punctuation">,</span> <span class="token string">"="</span><span class="token operator">*</span><span class="token number">20</span><span class="token punctuation">)</span>

        path <span class="token operator">=</span> <span class="token string">r'C:\Users\YangWang\Desktop\Text_Classifier_for_UtaPass_and_KKBOX\weights\attention_weights.hdf5'</span>
        model_checkpoint <span class="token operator">=</span> ModelCheckpoint<span class="token punctuation">(</span>path<span class="token punctuation">,</span> monitor<span class="token operator">=</span><span class="token string">'val_loss'</span><span class="token punctuation">,</span> verbose<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">,</span> save_best_only<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">,</span> mode<span class="token operator">=</span><span class="token string">'auto'</span><span class="token punctuation">)</span>
        early_stopping <span class="token operator">=</span> EarlyStopping<span class="token punctuation">(</span>monitor<span class="token operator">=</span><span class="token string">'val_loss'</span><span class="token punctuation">,</span> patience<span class="token operator">=</span><span class="token number">20</span><span class="token punctuation">,</span> verbose<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">,</span> mode<span class="token operator">=</span><span class="token string">'auto'</span><span class="token punctuation">)</span>
        reduce_lr <span class="token operator">=</span> ReduceLROnPlateau<span class="token punctuation">(</span>monitor<span class="token operator">=</span><span class="token string">'val_loss'</span><span class="token punctuation">,</span> factor<span class="token operator">=</span><span class="token number">0.2</span><span class="token punctuation">,</span> patience<span class="token operator">=</span><span class="token number">10</span><span class="token punctuation">,</span> min_lr<span class="token operator">=</span><span class="token number">0.001</span><span class="token punctuation">,</span> verbose<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span>

        history <span class="token operator">=</span> model<span class="token punctuation">.</span>fit<span class="token punctuation">(</span>
            x_train<span class="token punctuation">,</span> y_train<span class="token punctuation">,</span> 
            batch_size<span class="token operator">=</span>config<span class="token punctuation">[</span><span class="token string">'batch_size'</span><span class="token punctuation">]</span><span class="token punctuation">,</span> 
            epochs<span class="token operator">=</span>config<span class="token punctuation">[</span><span class="token string">'nb_epoch'</span><span class="token punctuation">]</span><span class="token punctuation">,</span> 
            validation_split<span class="token operator">=</span>config<span class="token punctuation">[</span><span class="token string">'validation_split'</span><span class="token punctuation">]</span><span class="token punctuation">,</span> 
            shuffle<span class="token operator">=</span>config<span class="token punctuation">[</span><span class="token string">'shuffle'</span><span class="token punctuation">]</span><span class="token punctuation">,</span> 
            verbose<span class="token operator">=</span>verbose<span class="token punctuation">,</span> 
            callbacks<span class="token operator">=</span><span class="token punctuation">[</span>early_stopping<span class="token punctuation">,</span> reduce_lr<span class="token punctuation">,</span> model_checkpoint<span class="token punctuation">]</span><span class="token punctuation">)</span>
    <span class="token keyword">if</span> load_weights<span class="token punctuation">:</span>
        history <span class="token operator">=</span> <span class="token boolean">None</span>
        path <span class="token operator">=</span> <span class="token string">r'C:\Users\YangWang\Desktop\Text_Classifier_for_UtaPass_and_KKBOX\weights\attention_weights.hdf5'</span>
        model<span class="token punctuation">.</span>load_weights<span class="token punctuation">(</span>path<span class="token punctuation">)</span>
    
    <span class="token keyword">return</span> history<span class="token punctuation">,</span> model<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h4 id="CNN-LSTM"><a href="#CNN-LSTM" class="headerlink" title="CNN-LSTM"></a>CNN-LSTM</h4><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">def</span> <span class="token function">train_cnn_lstm</span><span class="token punctuation">(</span>x_train<span class="token punctuation">,</span> y_train<span class="token punctuation">,</span> wv_matrix<span class="token punctuation">,</span> verbose<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">,</span> load_weights<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    tf<span class="token punctuation">.</span>keras<span class="token punctuation">.</span>backend<span class="token punctuation">.</span>clear_session<span class="token punctuation">(</span><span class="token punctuation">)</span>
    
    x_input <span class="token operator">=</span> Input<span class="token punctuation">(</span>shape<span class="token operator">=</span><span class="token punctuation">(</span>config<span class="token punctuation">[</span><span class="token string">"MAX_LEN"</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">)</span><span class="token punctuation">)</span>
    x <span class="token operator">=</span> Embedding<span class="token punctuation">(</span>wv_matrix<span class="token punctuation">.</span>shape<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> wv_matrix<span class="token punctuation">.</span>shape<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span> weights<span class="token operator">=</span><span class="token punctuation">[</span>wv_matrix<span class="token punctuation">]</span><span class="token punctuation">,</span> trainable<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">)</span><span class="token punctuation">(</span>x_input<span class="token punctuation">)</span>
    x <span class="token operator">=</span> SpatialDropout1D<span class="token punctuation">(</span>config<span class="token punctuation">[</span><span class="token string">'dropout_rate'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">(</span>x<span class="token punctuation">)</span>
    
    x <span class="token operator">=</span> Conv1D<span class="token punctuation">(</span>filters<span class="token operator">=</span>config<span class="token punctuation">[</span><span class="token string">'nb_filter'</span><span class="token punctuation">]</span><span class="token punctuation">,</span> kernel_size<span class="token operator">=</span>config<span class="token punctuation">[</span><span class="token string">'filter_length'</span><span class="token punctuation">]</span><span class="token punctuation">,</span> padding<span class="token operator">=</span>config<span class="token punctuation">[</span><span class="token string">'border_mode'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">(</span>x<span class="token punctuation">)</span>
    x <span class="token operator">=</span> BatchNormalization<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">(</span>x<span class="token punctuation">)</span>
    x <span class="token operator">=</span> Activation<span class="token punctuation">(</span><span class="token string">"relu"</span><span class="token punctuation">)</span><span class="token punctuation">(</span>x<span class="token punctuation">)</span>
    x <span class="token operator">=</span> MaxPooling1D<span class="token punctuation">(</span>pool_size<span class="token operator">=</span>config<span class="token punctuation">[</span><span class="token string">'pool_length'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">(</span>x<span class="token punctuation">)</span>
    
    x <span class="token operator">=</span> Conv1D<span class="token punctuation">(</span>filters<span class="token operator">=</span>config<span class="token punctuation">[</span><span class="token string">'nb_filter'</span><span class="token punctuation">]</span><span class="token operator">*</span><span class="token number">2</span><span class="token punctuation">,</span> kernel_size<span class="token operator">=</span>config<span class="token punctuation">[</span><span class="token string">'filter_length'</span><span class="token punctuation">]</span><span class="token punctuation">,</span> padding<span class="token operator">=</span>config<span class="token punctuation">[</span><span class="token string">'border_mode'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">(</span>x<span class="token punctuation">)</span>
    x <span class="token operator">=</span> BatchNormalization<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">(</span>x<span class="token punctuation">)</span>
    x <span class="token operator">=</span> Activation<span class="token punctuation">(</span><span class="token string">"relu"</span><span class="token punctuation">)</span><span class="token punctuation">(</span>x<span class="token punctuation">)</span>
    x <span class="token operator">=</span> MaxPooling1D<span class="token punctuation">(</span>pool_size<span class="token operator">=</span>config<span class="token punctuation">[</span><span class="token string">'pool_length'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">(</span>x<span class="token punctuation">)</span>
    
    x <span class="token operator">=</span> Conv1D<span class="token punctuation">(</span>filters<span class="token operator">=</span>config<span class="token punctuation">[</span><span class="token string">'nb_filter'</span><span class="token punctuation">]</span><span class="token operator">*</span><span class="token number">4</span><span class="token punctuation">,</span> kernel_size<span class="token operator">=</span>config<span class="token punctuation">[</span><span class="token string">'filter_length'</span><span class="token punctuation">]</span><span class="token punctuation">,</span> padding<span class="token operator">=</span>config<span class="token punctuation">[</span><span class="token string">'border_mode'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">(</span>x<span class="token punctuation">)</span>
    x <span class="token operator">=</span> BatchNormalization<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">(</span>x<span class="token punctuation">)</span>
    x <span class="token operator">=</span> Activation<span class="token punctuation">(</span><span class="token string">"relu"</span><span class="token punctuation">)</span><span class="token punctuation">(</span>x<span class="token punctuation">)</span>
    x <span class="token operator">=</span> MaxPooling1D<span class="token punctuation">(</span>pool_size<span class="token operator">=</span>config<span class="token punctuation">[</span><span class="token string">'pool_length'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">(</span>x<span class="token punctuation">)</span>
    
    x <span class="token operator">=</span> LSTM<span class="token punctuation">(</span>units<span class="token operator">=</span>config<span class="token punctuation">[</span><span class="token string">'lstm_cell'</span><span class="token punctuation">]</span><span class="token punctuation">,</span> return_sequences<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">,</span> kernel_regularizer<span class="token operator">=</span>regularizers<span class="token punctuation">.</span>l2<span class="token punctuation">(</span><span class="token number">0.3</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">(</span>x<span class="token punctuation">)</span>
    x <span class="token operator">=</span> SeqSelfAttention<span class="token punctuation">(</span>units<span class="token operator">=</span>config<span class="token punctuation">[</span><span class="token string">'lstm_cell'</span><span class="token punctuation">]</span><span class="token punctuation">,</span> kernel_regularizer<span class="token operator">=</span>regularizers<span class="token punctuation">.</span>l2<span class="token punctuation">(</span><span class="token number">0.1</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">(</span>x<span class="token punctuation">)</span>
    
    x <span class="token operator">=</span> Flatten<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">(</span>x<span class="token punctuation">)</span>
    x <span class="token operator">=</span> Dense<span class="token punctuation">(</span>config<span class="token punctuation">[</span><span class="token string">'fc_cell'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">(</span>x<span class="token punctuation">)</span>
    x <span class="token operator">=</span> Dropout<span class="token punctuation">(</span>config<span class="token punctuation">[</span><span class="token string">'dropout_rate'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">(</span>x<span class="token punctuation">)</span>
    x <span class="token operator">=</span> Dense<span class="token punctuation">(</span>units<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">(</span>x<span class="token punctuation">)</span>
    x <span class="token operator">=</span> Activation<span class="token punctuation">(</span><span class="token string">'sigmoid'</span><span class="token punctuation">)</span><span class="token punctuation">(</span>x<span class="token punctuation">)</span>
    model <span class="token operator">=</span> Model<span class="token punctuation">(</span>inputs<span class="token operator">=</span>x_input<span class="token punctuation">,</span> outputs<span class="token operator">=</span>x<span class="token punctuation">)</span>

    <span class="token keyword">if</span> <span class="token keyword">not</span> load_weights<span class="token punctuation">:</span>
        model<span class="token punctuation">.</span><span class="token builtin">compile</span><span class="token punctuation">(</span>loss<span class="token operator">=</span>config<span class="token punctuation">[</span><span class="token string">'loss'</span><span class="token punctuation">]</span><span class="token punctuation">,</span> 
                      optimizer<span class="token operator">=</span>adadelta<span class="token punctuation">,</span> 
                      metrics<span class="token operator">=</span><span class="token punctuation">[</span>get_f1<span class="token punctuation">]</span><span class="token punctuation">)</span>

        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"="</span><span class="token operator">*</span><span class="token number">20</span><span class="token punctuation">,</span> <span class="token string">"Start Training CNN-LSTM"</span><span class="token punctuation">,</span> <span class="token string">"="</span><span class="token operator">*</span><span class="token number">20</span><span class="token punctuation">)</span>

        path <span class="token operator">=</span> <span class="token string">r'C:\Users\YangWang\Desktop\UtaPass_KKBOX_Classifier\weights\&#123;&#125;_weights.hdf5'</span><span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span><span class="token string">"cnn_lstm"</span><span class="token punctuation">)</span>
        model_checkpoint <span class="token operator">=</span> ModelCheckpoint<span class="token punctuation">(</span>path<span class="token punctuation">,</span> monitor<span class="token operator">=</span><span class="token string">'val_loss'</span><span class="token punctuation">,</span> verbose<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">,</span> save_best_only<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">,</span> mode<span class="token operator">=</span><span class="token string">'auto'</span><span class="token punctuation">)</span>
        early_stopping <span class="token operator">=</span> EarlyStopping<span class="token punctuation">(</span>monitor<span class="token operator">=</span><span class="token string">'val_loss'</span><span class="token punctuation">,</span> patience<span class="token operator">=</span><span class="token number">20</span><span class="token punctuation">,</span> verbose<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">,</span> mode<span class="token operator">=</span><span class="token string">'auto'</span><span class="token punctuation">)</span>
        reduce_lr <span class="token operator">=</span> ReduceLROnPlateau<span class="token punctuation">(</span>monitor<span class="token operator">=</span><span class="token string">'val_loss'</span><span class="token punctuation">,</span> factor<span class="token operator">=</span><span class="token number">0.2</span><span class="token punctuation">,</span> patience<span class="token operator">=</span><span class="token number">10</span><span class="token punctuation">,</span> min_lr<span class="token operator">=</span><span class="token number">0.001</span><span class="token punctuation">)</span>

        history <span class="token operator">=</span> model<span class="token punctuation">.</span>fit<span class="token punctuation">(</span>
            x_train<span class="token punctuation">,</span> y_train<span class="token punctuation">,</span> 
            batch_size<span class="token operator">=</span>config<span class="token punctuation">[</span><span class="token string">'batch_size'</span><span class="token punctuation">]</span><span class="token punctuation">,</span> 
            epochs<span class="token operator">=</span>config<span class="token punctuation">[</span><span class="token string">'nb_epoch'</span><span class="token punctuation">]</span><span class="token punctuation">,</span> 
            validation_split<span class="token operator">=</span>config<span class="token punctuation">[</span><span class="token string">'validation_split'</span><span class="token punctuation">]</span><span class="token punctuation">,</span> 
            shuffle<span class="token operator">=</span>config<span class="token punctuation">[</span><span class="token string">'shuffle'</span><span class="token punctuation">]</span><span class="token punctuation">,</span> 
            verbose<span class="token operator">=</span>verbose<span class="token punctuation">,</span> 
            callbacks<span class="token operator">=</span><span class="token punctuation">[</span>early_stopping<span class="token punctuation">,</span> reduce_lr<span class="token punctuation">,</span> model_checkpoint<span class="token punctuation">]</span><span class="token punctuation">)</span>
    <span class="token keyword">if</span> load_weights<span class="token punctuation">:</span> 
        history <span class="token operator">=</span> <span class="token boolean">None</span>
        path <span class="token operator">=</span> <span class="token string">r'C:\Users\YangWang\Desktop\UtaPass_KKBOX_Classifier\weights\&#123;&#125;_weights.hdf5'</span><span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span><span class="token string">"cnn_lstm"</span><span class="token punctuation">)</span>
        model<span class="token punctuation">.</span>load_weights<span class="token punctuation">(</span>path<span class="token punctuation">)</span>
    
    <span class="token keyword">return</span> history<span class="token punctuation">,</span> model<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h4 id="CNN-static"><a href="#CNN-static" class="headerlink" title="CNN-static"></a>CNN-static</h4><p>Based on “Convolutional Neural Networks for Sentence Classification” written by Yoon Kim [<a target="_blank" rel="noopener" href="http://arxiv.org/pdf/1408.5882v2.pdf">paper link</a>]</p>
<pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token comment"># Yoon Kim's paper: Convolutional Neural Networks for Sentence Classification</span>
<span class="token comment"># Reference from https://www.aclweb.org/anthology/D14-1181.pdf</span>
<span class="token keyword">def</span> <span class="token function">train_cnn_static</span><span class="token punctuation">(</span>x_train<span class="token punctuation">,</span> y_train<span class="token punctuation">,</span> wv_matrix<span class="token punctuation">,</span> trainable<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">,</span> verbose<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">,</span> load_weights<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    tf<span class="token punctuation">.</span>keras<span class="token punctuation">.</span>backend<span class="token punctuation">.</span>clear_session<span class="token punctuation">(</span><span class="token punctuation">)</span>
    
    x_input <span class="token operator">=</span> Input<span class="token punctuation">(</span>shape<span class="token operator">=</span><span class="token punctuation">(</span>config<span class="token punctuation">[</span><span class="token string">"MAX_LEN"</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">)</span><span class="token punctuation">)</span>
    x <span class="token operator">=</span> Embedding<span class="token punctuation">(</span>wv_matrix<span class="token punctuation">.</span>shape<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> wv_matrix<span class="token punctuation">.</span>shape<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span> weights<span class="token operator">=</span><span class="token punctuation">[</span>wv_matrix<span class="token punctuation">]</span><span class="token punctuation">,</span> trainable<span class="token operator">=</span>trainable<span class="token punctuation">)</span><span class="token punctuation">(</span>x_input<span class="token punctuation">)</span>
    
    x_conv_1 <span class="token operator">=</span> Conv1D<span class="token punctuation">(</span>filters<span class="token operator">=</span>config<span class="token punctuation">[</span><span class="token string">'nb_filter'</span><span class="token punctuation">]</span><span class="token punctuation">,</span> 
                      kernel_size<span class="token operator">=</span><span class="token number">3</span><span class="token punctuation">,</span> 
                      padding<span class="token operator">=</span>config<span class="token punctuation">[</span><span class="token string">'border_mode'</span><span class="token punctuation">]</span><span class="token punctuation">,</span> 
                      kernel_regularizer<span class="token operator">=</span>regularizers<span class="token punctuation">.</span>l2<span class="token punctuation">(</span><span class="token number">0.3</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">(</span>x<span class="token punctuation">)</span>
    x_conv_1 <span class="token operator">=</span> BatchNormalization<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">(</span>x_conv_1<span class="token punctuation">)</span>
    x_conv_1 <span class="token operator">=</span> Activation<span class="token punctuation">(</span><span class="token string">"relu"</span><span class="token punctuation">)</span><span class="token punctuation">(</span>x_conv_1<span class="token punctuation">)</span>
    x_conv_1 <span class="token operator">=</span> MaxPooling1D<span class="token punctuation">(</span>pool_size<span class="token operator">=</span><span class="token punctuation">(</span>config<span class="token punctuation">[</span><span class="token string">"MAX_LEN"</span><span class="token punctuation">]</span><span class="token operator">-</span><span class="token number">3</span><span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span> strides<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">,</span> padding<span class="token operator">=</span><span class="token string">"valid"</span><span class="token punctuation">)</span><span class="token punctuation">(</span>x_conv_1<span class="token punctuation">)</span>
    
    x_conv_2 <span class="token operator">=</span> Conv1D<span class="token punctuation">(</span>filters<span class="token operator">=</span>config<span class="token punctuation">[</span><span class="token string">'nb_filter'</span><span class="token punctuation">]</span><span class="token punctuation">,</span> 
                      kernel_size<span class="token operator">=</span><span class="token number">4</span><span class="token punctuation">,</span> 
                      padding<span class="token operator">=</span>config<span class="token punctuation">[</span><span class="token string">'border_mode'</span><span class="token punctuation">]</span><span class="token punctuation">,</span> 
                      kernel_regularizer<span class="token operator">=</span>regularizers<span class="token punctuation">.</span>l2<span class="token punctuation">(</span><span class="token number">0.3</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">(</span>x<span class="token punctuation">)</span>
    x_conv_2 <span class="token operator">=</span> BatchNormalization<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">(</span>x_conv_2<span class="token punctuation">)</span>
    x_conv_2 <span class="token operator">=</span> Activation<span class="token punctuation">(</span><span class="token string">"relu"</span><span class="token punctuation">)</span><span class="token punctuation">(</span>x_conv_2<span class="token punctuation">)</span>
    x_conv_2 <span class="token operator">=</span> MaxPooling1D<span class="token punctuation">(</span>pool_size<span class="token operator">=</span><span class="token punctuation">(</span>config<span class="token punctuation">[</span><span class="token string">"MAX_LEN"</span><span class="token punctuation">]</span><span class="token operator">-</span><span class="token number">4</span><span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span> strides<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">,</span> padding<span class="token operator">=</span><span class="token string">"valid"</span><span class="token punctuation">)</span><span class="token punctuation">(</span>x_conv_2<span class="token punctuation">)</span>
    
    x_conv_3 <span class="token operator">=</span> Conv1D<span class="token punctuation">(</span>filters<span class="token operator">=</span>config<span class="token punctuation">[</span><span class="token string">'nb_filter'</span><span class="token punctuation">]</span><span class="token punctuation">,</span> 
                      kernel_size<span class="token operator">=</span><span class="token number">5</span><span class="token punctuation">,</span> 
                      padding<span class="token operator">=</span>config<span class="token punctuation">[</span><span class="token string">'border_mode'</span><span class="token punctuation">]</span><span class="token punctuation">,</span> 
                      kernel_regularizer<span class="token operator">=</span>regularizers<span class="token punctuation">.</span>l2<span class="token punctuation">(</span><span class="token number">0.3</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">(</span>x<span class="token punctuation">)</span>
    x_conv_3 <span class="token operator">=</span> BatchNormalization<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">(</span>x_conv_3<span class="token punctuation">)</span>
    x_conv_3 <span class="token operator">=</span> Activation<span class="token punctuation">(</span><span class="token string">"relu"</span><span class="token punctuation">)</span><span class="token punctuation">(</span>x_conv_3<span class="token punctuation">)</span>
    x_conv_3 <span class="token operator">=</span> MaxPooling1D<span class="token punctuation">(</span>pool_size<span class="token operator">=</span><span class="token punctuation">(</span>config<span class="token punctuation">[</span><span class="token string">"MAX_LEN"</span><span class="token punctuation">]</span><span class="token operator">-</span><span class="token number">5</span><span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span> strides<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">,</span> padding<span class="token operator">=</span><span class="token string">"valid"</span><span class="token punctuation">)</span><span class="token punctuation">(</span>x_conv_3<span class="token punctuation">)</span>
    
    main <span class="token operator">=</span> Concatenate<span class="token punctuation">(</span>axis<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">[</span>x_conv_1<span class="token punctuation">,</span> x_conv_2<span class="token punctuation">,</span> x_conv_3<span class="token punctuation">]</span><span class="token punctuation">)</span>
    main <span class="token operator">=</span> Flatten<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">(</span>main<span class="token punctuation">)</span>
    main <span class="token operator">=</span> Dropout<span class="token punctuation">(</span>config<span class="token punctuation">[</span><span class="token string">'dropout_rate'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">(</span>main<span class="token punctuation">)</span>
    main <span class="token operator">=</span> Dense<span class="token punctuation">(</span>units<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">(</span>main<span class="token punctuation">)</span>
    main <span class="token operator">=</span> Activation<span class="token punctuation">(</span><span class="token string">'sigmoid'</span><span class="token punctuation">)</span><span class="token punctuation">(</span>main<span class="token punctuation">)</span>
    model <span class="token operator">=</span> Model<span class="token punctuation">(</span>inputs<span class="token operator">=</span>x_input<span class="token punctuation">,</span> outputs<span class="token operator">=</span>main<span class="token punctuation">)</span>

    <span class="token keyword">if</span> <span class="token keyword">not</span> load_weights<span class="token punctuation">:</span>
        model<span class="token punctuation">.</span><span class="token builtin">compile</span><span class="token punctuation">(</span>loss<span class="token operator">=</span>config<span class="token punctuation">[</span><span class="token string">"loss"</span><span class="token punctuation">]</span><span class="token punctuation">,</span> 
                      optimizer<span class="token operator">=</span>adagrad<span class="token punctuation">,</span> 
                      metrics<span class="token operator">=</span><span class="token punctuation">[</span>get_f1<span class="token punctuation">]</span><span class="token punctuation">)</span>

        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"="</span><span class="token operator">*</span><span class="token number">20</span><span class="token punctuation">,</span> <span class="token string">"Start Training CNN-static"</span><span class="token punctuation">,</span> <span class="token string">"="</span><span class="token operator">*</span><span class="token number">20</span><span class="token punctuation">)</span>

        path <span class="token operator">=</span> <span class="token string">r'C:\Users\YangWang\Desktop\Text_Classifier_for_UtaPass_and_KKBOX\weights\cnn_static_weights.hdf5'</span>
        model_checkpoint <span class="token operator">=</span> ModelCheckpoint<span class="token punctuation">(</span>path<span class="token punctuation">,</span> monitor<span class="token operator">=</span><span class="token string">'val_loss'</span><span class="token punctuation">,</span> verbose<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">,</span> save_best_only<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">,</span> mode<span class="token operator">=</span><span class="token string">'auto'</span><span class="token punctuation">)</span>
        early_stopping <span class="token operator">=</span> EarlyStopping<span class="token punctuation">(</span>monitor<span class="token operator">=</span><span class="token string">'val_loss'</span><span class="token punctuation">,</span> patience<span class="token operator">=</span><span class="token number">20</span><span class="token punctuation">,</span> verbose<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">,</span> mode<span class="token operator">=</span><span class="token string">'auto'</span><span class="token punctuation">)</span>
        reduce_lr <span class="token operator">=</span> ReduceLROnPlateau<span class="token punctuation">(</span>monitor<span class="token operator">=</span><span class="token string">'val_loss'</span><span class="token punctuation">,</span> factor<span class="token operator">=</span><span class="token number">0.2</span><span class="token punctuation">,</span> patience<span class="token operator">=</span><span class="token number">10</span><span class="token punctuation">,</span> min_lr<span class="token operator">=</span><span class="token number">0.001</span><span class="token punctuation">)</span>

        history <span class="token operator">=</span> model<span class="token punctuation">.</span>fit<span class="token punctuation">(</span>
            x_train<span class="token punctuation">,</span> y_train<span class="token punctuation">,</span> 
            batch_size<span class="token operator">=</span>config<span class="token punctuation">[</span><span class="token string">'batch_size'</span><span class="token punctuation">]</span><span class="token punctuation">,</span> 
            epochs<span class="token operator">=</span>config<span class="token punctuation">[</span><span class="token string">'nb_epoch'</span><span class="token punctuation">]</span><span class="token punctuation">,</span> 
            validation_split<span class="token operator">=</span>config<span class="token punctuation">[</span><span class="token string">'validation_split'</span><span class="token punctuation">]</span><span class="token punctuation">,</span> 
            shuffle<span class="token operator">=</span>config<span class="token punctuation">[</span><span class="token string">'shuffle'</span><span class="token punctuation">]</span><span class="token punctuation">,</span> 
            verbose<span class="token operator">=</span>verbose<span class="token punctuation">,</span> 
            callbacks<span class="token operator">=</span><span class="token punctuation">[</span>early_stopping<span class="token punctuation">,</span> reduce_lr<span class="token punctuation">,</span> model_checkpoint<span class="token punctuation">]</span><span class="token punctuation">)</span>
    <span class="token keyword">if</span> load_weights<span class="token punctuation">:</span>
        history <span class="token operator">=</span> <span class="token boolean">None</span>
        path <span class="token operator">=</span> <span class="token string">r'C:\Users\YangWang\Desktop\Text_Classifier_for_UtaPass_and_KKBOX\weights\cnn_static_weights.hdf5'</span>
        model<span class="token punctuation">.</span>load_weights<span class="token punctuation">(</span>path<span class="token punctuation">)</span>
    
    <span class="token keyword">return</span> history<span class="token punctuation">,</span> model<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h4 id="CNN-multichannel"><a href="#CNN-multichannel" class="headerlink" title="CNN-multichannel"></a>CNN-multichannel</h4><p>Based on “Convolutional Neural Networks for Sentence Classification” written by Yoon Kim [<a target="_blank" rel="noopener" href="http://arxiv.org/pdf/1408.5882v2.pdf">paper link</a>]</p>
<pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">def</span> <span class="token function">train_cnn_multichannel</span><span class="token punctuation">(</span>x_train<span class="token punctuation">,</span> y_train<span class="token punctuation">,</span> wv_matrix<span class="token punctuation">,</span> trainable<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">,</span> verbose<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">,</span> load_weights<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    tf<span class="token punctuation">.</span>keras<span class="token punctuation">.</span>backend<span class="token punctuation">.</span>clear_session<span class="token punctuation">(</span><span class="token punctuation">)</span>
    
    <span class="token comment"># Channel 1</span>
    x_input_1 <span class="token operator">=</span> Input<span class="token punctuation">(</span>shape<span class="token operator">=</span><span class="token punctuation">(</span>config<span class="token punctuation">[</span><span class="token string">"MAX_LEN"</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">)</span><span class="token punctuation">)</span>
    embedding_1 <span class="token operator">=</span> Embedding<span class="token punctuation">(</span>
        wv_matrix<span class="token punctuation">.</span>shape<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> 
        wv_matrix<span class="token punctuation">.</span>shape<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span> 
        weights<span class="token operator">=</span><span class="token punctuation">[</span>wv_matrix<span class="token punctuation">]</span><span class="token punctuation">,</span> 
        trainable<span class="token operator">=</span>trainable<span class="token punctuation">)</span><span class="token punctuation">(</span>x_input_1<span class="token punctuation">)</span>
    x_conv_1 <span class="token operator">=</span> Conv1D<span class="token punctuation">(</span>
        filters<span class="token operator">=</span>config<span class="token punctuation">[</span><span class="token string">'nb_filter'</span><span class="token punctuation">]</span><span class="token punctuation">,</span> 
        kernel_size<span class="token operator">=</span><span class="token number">3</span><span class="token punctuation">,</span> 
        padding<span class="token operator">=</span>config<span class="token punctuation">[</span><span class="token string">'border_mode'</span><span class="token punctuation">]</span><span class="token punctuation">,</span> 
        kernel_regularizer<span class="token operator">=</span>regularizers<span class="token punctuation">.</span>l2<span class="token punctuation">(</span><span class="token number">0.3</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">(</span>embedding_1<span class="token punctuation">)</span>
    x_conv_1 <span class="token operator">=</span> BatchNormalization<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">(</span>x_conv_1<span class="token punctuation">)</span>
    x_conv_1 <span class="token operator">=</span> Activation<span class="token punctuation">(</span><span class="token string">"relu"</span><span class="token punctuation">)</span><span class="token punctuation">(</span>x_conv_1<span class="token punctuation">)</span>
    x_conv_1 <span class="token operator">=</span> MaxPooling1D<span class="token punctuation">(</span>pool_size<span class="token operator">=</span><span class="token punctuation">(</span>config<span class="token punctuation">[</span><span class="token string">"MAX_LEN"</span><span class="token punctuation">]</span><span class="token operator">-</span><span class="token number">3</span><span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span> strides<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">,</span> padding<span class="token operator">=</span><span class="token string">"valid"</span><span class="token punctuation">)</span><span class="token punctuation">(</span>x_conv_1<span class="token punctuation">)</span>
    flat_1 <span class="token operator">=</span> Flatten<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">(</span>x_conv_1<span class="token punctuation">)</span>
    
    <span class="token comment"># Channel 2</span>
    x_input_2 <span class="token operator">=</span> Input<span class="token punctuation">(</span>shape<span class="token operator">=</span><span class="token punctuation">(</span>config<span class="token punctuation">[</span><span class="token string">"MAX_LEN"</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">)</span><span class="token punctuation">)</span>
    embedding_2 <span class="token operator">=</span> Embedding<span class="token punctuation">(</span>
        wv_matrix<span class="token punctuation">.</span>shape<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> 
        wv_matrix<span class="token punctuation">.</span>shape<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span> 
        weights<span class="token operator">=</span><span class="token punctuation">[</span>wv_matrix<span class="token punctuation">]</span><span class="token punctuation">,</span> 
        trainable<span class="token operator">=</span>trainable<span class="token punctuation">)</span><span class="token punctuation">(</span>x_input_2<span class="token punctuation">)</span>
    x_conv_2 <span class="token operator">=</span> Conv1D<span class="token punctuation">(</span>
        filters<span class="token operator">=</span>config<span class="token punctuation">[</span><span class="token string">'nb_filter'</span><span class="token punctuation">]</span><span class="token punctuation">,</span> 
        kernel_size<span class="token operator">=</span><span class="token number">3</span><span class="token punctuation">,</span> 
        padding<span class="token operator">=</span>config<span class="token punctuation">[</span><span class="token string">'border_mode'</span><span class="token punctuation">]</span><span class="token punctuation">,</span> 
        kernel_regularizer<span class="token operator">=</span>regularizers<span class="token punctuation">.</span>l2<span class="token punctuation">(</span><span class="token number">0.3</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">(</span>embedding_2<span class="token punctuation">)</span>
    x_conv_2 <span class="token operator">=</span> BatchNormalization<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">(</span>x_conv_2<span class="token punctuation">)</span>
    x_conv_2 <span class="token operator">=</span> Activation<span class="token punctuation">(</span><span class="token string">"relu"</span><span class="token punctuation">)</span><span class="token punctuation">(</span>x_conv_2<span class="token punctuation">)</span>
    x_conv_2 <span class="token operator">=</span> MaxPooling1D<span class="token punctuation">(</span>pool_size<span class="token operator">=</span><span class="token punctuation">(</span>config<span class="token punctuation">[</span><span class="token string">"MAX_LEN"</span><span class="token punctuation">]</span><span class="token operator">-</span><span class="token number">3</span><span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span> strides<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">,</span> padding<span class="token operator">=</span><span class="token string">"valid"</span><span class="token punctuation">)</span><span class="token punctuation">(</span>x_conv_2<span class="token punctuation">)</span>
    flat_2 <span class="token operator">=</span> Flatten<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">(</span>x_conv_2<span class="token punctuation">)</span>
    
    <span class="token comment"># Channel 1</span>
    x_input_3 <span class="token operator">=</span> Input<span class="token punctuation">(</span>shape<span class="token operator">=</span><span class="token punctuation">(</span>config<span class="token punctuation">[</span><span class="token string">"MAX_LEN"</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">)</span><span class="token punctuation">)</span>
    embedding_3 <span class="token operator">=</span> Embedding<span class="token punctuation">(</span>
        wv_matrix<span class="token punctuation">.</span>shape<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> 
        wv_matrix<span class="token punctuation">.</span>shape<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span> 
        weights<span class="token operator">=</span><span class="token punctuation">[</span>wv_matrix<span class="token punctuation">]</span><span class="token punctuation">,</span> 
        trainable<span class="token operator">=</span>trainable<span class="token punctuation">)</span><span class="token punctuation">(</span>x_input_3<span class="token punctuation">)</span>
    x_conv_3 <span class="token operator">=</span> Conv1D<span class="token punctuation">(</span>
        filters<span class="token operator">=</span>config<span class="token punctuation">[</span><span class="token string">'nb_filter'</span><span class="token punctuation">]</span><span class="token punctuation">,</span> 
        kernel_size<span class="token operator">=</span><span class="token number">3</span><span class="token punctuation">,</span> 
        padding<span class="token operator">=</span>config<span class="token punctuation">[</span><span class="token string">'border_mode'</span><span class="token punctuation">]</span><span class="token punctuation">,</span> 
        kernel_regularizer<span class="token operator">=</span>regularizers<span class="token punctuation">.</span>l2<span class="token punctuation">(</span><span class="token number">0.3</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">(</span>embedding_3<span class="token punctuation">)</span>
    x_conv_3 <span class="token operator">=</span> BatchNormalization<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">(</span>x_conv_3<span class="token punctuation">)</span>
    x_conv_3 <span class="token operator">=</span> Activation<span class="token punctuation">(</span><span class="token string">"relu"</span><span class="token punctuation">)</span><span class="token punctuation">(</span>x_conv_3<span class="token punctuation">)</span>
    x_conv_3 <span class="token operator">=</span> MaxPooling1D<span class="token punctuation">(</span>pool_size<span class="token operator">=</span><span class="token punctuation">(</span>config<span class="token punctuation">[</span><span class="token string">"MAX_LEN"</span><span class="token punctuation">]</span><span class="token operator">-</span><span class="token number">3</span><span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span> strides<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">,</span> padding<span class="token operator">=</span><span class="token string">"valid"</span><span class="token punctuation">)</span><span class="token punctuation">(</span>x_conv_3<span class="token punctuation">)</span>
    flat_3 <span class="token operator">=</span> Flatten<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">(</span>x_conv_3<span class="token punctuation">)</span>
    
    main <span class="token operator">=</span> Concatenate<span class="token punctuation">(</span>axis<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">[</span>flat_1<span class="token punctuation">,</span> flat_2<span class="token punctuation">,</span> flat_3<span class="token punctuation">]</span><span class="token punctuation">)</span>
    main <span class="token operator">=</span> Dense<span class="token punctuation">(</span>units<span class="token operator">=</span><span class="token number">100</span><span class="token punctuation">)</span><span class="token punctuation">(</span>main<span class="token punctuation">)</span>
    main <span class="token operator">=</span> Activation<span class="token punctuation">(</span><span class="token string">'relu'</span><span class="token punctuation">)</span><span class="token punctuation">(</span>main<span class="token punctuation">)</span>
    main <span class="token operator">=</span> Dropout<span class="token punctuation">(</span>config<span class="token punctuation">[</span><span class="token string">'dropout_rate'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">(</span>main<span class="token punctuation">)</span>
    main <span class="token operator">=</span> Dense<span class="token punctuation">(</span>units<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">(</span>main<span class="token punctuation">)</span>
    main <span class="token operator">=</span> Activation<span class="token punctuation">(</span><span class="token string">'sigmoid'</span><span class="token punctuation">)</span><span class="token punctuation">(</span>main<span class="token punctuation">)</span>
    model <span class="token operator">=</span> Model<span class="token punctuation">(</span>inputs<span class="token operator">=</span><span class="token punctuation">[</span>x_input_1<span class="token punctuation">,</span> x_input_2<span class="token punctuation">,</span> x_input_3<span class="token punctuation">]</span><span class="token punctuation">,</span> outputs<span class="token operator">=</span>main<span class="token punctuation">)</span>

    <span class="token keyword">if</span> <span class="token keyword">not</span> load_weights<span class="token punctuation">:</span>
        model<span class="token punctuation">.</span><span class="token builtin">compile</span><span class="token punctuation">(</span>loss<span class="token operator">=</span>config<span class="token punctuation">[</span><span class="token string">"loss"</span><span class="token punctuation">]</span><span class="token punctuation">,</span> 
                      optimizer<span class="token operator">=</span>adagrad<span class="token punctuation">,</span> 
                      metrics<span class="token operator">=</span><span class="token punctuation">[</span>get_f1<span class="token punctuation">]</span><span class="token punctuation">)</span>

        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"="</span><span class="token operator">*</span><span class="token number">20</span><span class="token punctuation">,</span> <span class="token string">"Start Training CNN-multichannel"</span><span class="token punctuation">,</span> <span class="token string">"="</span><span class="token operator">*</span><span class="token number">20</span><span class="token punctuation">)</span>

        path <span class="token operator">=</span> <span class="token string">r'C:\Users\YangWang\Desktop\Text_Classifier_for_UtaPass_and_KKBOX\weights\&#123;&#125;_weights.hdf5'</span><span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span><span class="token string">"cnn_multi"</span><span class="token punctuation">)</span>
        model_checkpoint <span class="token operator">=</span> ModelCheckpoint<span class="token punctuation">(</span>path<span class="token punctuation">,</span> monitor<span class="token operator">=</span><span class="token string">'val_loss'</span><span class="token punctuation">,</span> verbose<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">,</span> save_best_only<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">,</span> mode<span class="token operator">=</span><span class="token string">'auto'</span><span class="token punctuation">)</span>
        early_stopping <span class="token operator">=</span> EarlyStopping<span class="token punctuation">(</span>monitor<span class="token operator">=</span><span class="token string">'val_loss'</span><span class="token punctuation">,</span> patience<span class="token operator">=</span><span class="token number">20</span><span class="token punctuation">,</span> verbose<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">,</span> mode<span class="token operator">=</span><span class="token string">'auto'</span><span class="token punctuation">)</span>
        reduce_lr <span class="token operator">=</span> ReduceLROnPlateau<span class="token punctuation">(</span>monitor<span class="token operator">=</span><span class="token string">'val_loss'</span><span class="token punctuation">,</span> factor<span class="token operator">=</span><span class="token number">0.2</span><span class="token punctuation">,</span> patience<span class="token operator">=</span><span class="token number">10</span><span class="token punctuation">,</span> min_lr<span class="token operator">=</span><span class="token number">0.001</span><span class="token punctuation">)</span>

        history <span class="token operator">=</span> model<span class="token punctuation">.</span>fit<span class="token punctuation">(</span>
            <span class="token punctuation">[</span>x_train<span class="token punctuation">,</span> x_train<span class="token punctuation">,</span> x_train<span class="token punctuation">]</span><span class="token punctuation">,</span> y_train<span class="token punctuation">,</span> 
            batch_size<span class="token operator">=</span>config<span class="token punctuation">[</span><span class="token string">'batch_size'</span><span class="token punctuation">]</span><span class="token punctuation">,</span> 
            epochs<span class="token operator">=</span>config<span class="token punctuation">[</span><span class="token string">'nb_epoch'</span><span class="token punctuation">]</span><span class="token punctuation">,</span> 
            validation_split<span class="token operator">=</span>config<span class="token punctuation">[</span><span class="token string">'validation_split'</span><span class="token punctuation">]</span><span class="token punctuation">,</span> 
            shuffle<span class="token operator">=</span>config<span class="token punctuation">[</span><span class="token string">'shuffle'</span><span class="token punctuation">]</span><span class="token punctuation">,</span> 
            verbose<span class="token operator">=</span>verbose<span class="token punctuation">,</span> 
            callbacks<span class="token operator">=</span><span class="token punctuation">[</span>early_stopping<span class="token punctuation">,</span> reduce_lr<span class="token punctuation">,</span> model_checkpoint<span class="token punctuation">]</span><span class="token punctuation">)</span>
    <span class="token keyword">if</span> load_weights<span class="token punctuation">:</span>
        history <span class="token operator">=</span> <span class="token boolean">None</span>
        path <span class="token operator">=</span> <span class="token string">r'C:\Users\YangWang\Desktop\Text_Classifier_for_UtaPass_and_KKBOX\weights\&#123;&#125;_weights.hdf5'</span><span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span><span class="token string">"cnn_multi"</span><span class="token punctuation">)</span>
        model<span class="token punctuation">.</span>load_weights<span class="token punctuation">(</span>path<span class="token punctuation">)</span>
    
    <span class="token keyword">return</span> history<span class="token punctuation">,</span> model<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h4 id="Text-ResNet"><a href="#Text-ResNet" class="headerlink" title="Text-ResNet"></a>Text-ResNet</h4><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">def</span> <span class="token function">identity_resnet_block</span><span class="token punctuation">(</span>x<span class="token punctuation">,</span> nb_filter<span class="token punctuation">)</span><span class="token punctuation">:</span>
    x_shortcut <span class="token operator">=</span> x

    <span class="token comment"># First component of main path</span>
    res_x <span class="token operator">=</span> Conv1D<span class="token punctuation">(</span>
        filters<span class="token operator">=</span>nb_filter<span class="token punctuation">,</span> 
        kernel_size<span class="token operator">=</span><span class="token number">5</span><span class="token punctuation">,</span> 
        strides<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">,</span> 
        padding<span class="token operator">=</span><span class="token string">'same'</span><span class="token punctuation">)</span><span class="token punctuation">(</span>x<span class="token punctuation">)</span>
    res_x <span class="token operator">=</span> BatchNormalization<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">(</span>res_x<span class="token punctuation">)</span>
    res_x <span class="token operator">=</span> Activation<span class="token punctuation">(</span><span class="token string">"relu"</span><span class="token punctuation">)</span><span class="token punctuation">(</span>res_x<span class="token punctuation">)</span>

    <span class="token comment"># Second component of main path</span>
    res_x <span class="token operator">=</span> Conv1D<span class="token punctuation">(</span>
        filters<span class="token operator">=</span>nb_filter<span class="token punctuation">,</span> 
        kernel_size<span class="token operator">=</span><span class="token number">5</span><span class="token punctuation">,</span> 
        strides<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">,</span> 
        padding<span class="token operator">=</span><span class="token string">'same'</span><span class="token punctuation">)</span><span class="token punctuation">(</span>res_x<span class="token punctuation">)</span>
    res_x <span class="token operator">=</span> BatchNormalization<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">(</span>res_x<span class="token punctuation">)</span>
    res_x <span class="token operator">=</span> Activation<span class="token punctuation">(</span><span class="token string">"relu"</span><span class="token punctuation">)</span><span class="token punctuation">(</span>res_x<span class="token punctuation">)</span>

    <span class="token comment"># Third component of main path</span>
    res_x <span class="token operator">=</span> Conv1D<span class="token punctuation">(</span>
        filters<span class="token operator">=</span>nb_filter<span class="token punctuation">,</span> 
        kernel_size<span class="token operator">=</span><span class="token number">5</span><span class="token punctuation">,</span> 
        strides<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">,</span> 
        padding<span class="token operator">=</span><span class="token string">'same'</span><span class="token punctuation">)</span><span class="token punctuation">(</span>res_x<span class="token punctuation">)</span>
    res_x <span class="token operator">=</span> BatchNormalization<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">(</span>res_x<span class="token punctuation">)</span>

    <span class="token comment"># Final Step: add shortcut value to the main path</span>
    x <span class="token operator">=</span> Add<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">[</span>x_shortcut<span class="token punctuation">,</span> res_x<span class="token punctuation">]</span><span class="token punctuation">)</span>
    output <span class="token operator">=</span> Activation<span class="token punctuation">(</span><span class="token string">'relu'</span><span class="token punctuation">)</span><span class="token punctuation">(</span>x<span class="token punctuation">)</span>
    <span class="token keyword">return</span> output

<span class="token keyword">def</span> <span class="token function">convolutional_resnet_block</span><span class="token punctuation">(</span>x<span class="token punctuation">,</span> nb_filter<span class="token punctuation">)</span><span class="token punctuation">:</span>
    x_shortcut <span class="token operator">=</span> x

    <span class="token comment"># First component of main path</span>
    res_x <span class="token operator">=</span> Conv1D<span class="token punctuation">(</span>
        filters<span class="token operator">=</span>nb_filter<span class="token punctuation">,</span> 
        kernel_size<span class="token operator">=</span><span class="token number">5</span><span class="token punctuation">,</span> 
        strides<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">,</span> 
        padding<span class="token operator">=</span><span class="token string">'same'</span><span class="token punctuation">)</span><span class="token punctuation">(</span>x<span class="token punctuation">)</span>
    res_x <span class="token operator">=</span> BatchNormalization<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">(</span>res_x<span class="token punctuation">)</span>
    res_x <span class="token operator">=</span> Activation<span class="token punctuation">(</span><span class="token string">"relu"</span><span class="token punctuation">)</span><span class="token punctuation">(</span>res_x<span class="token punctuation">)</span>

    <span class="token comment"># Second component of main path</span>
    res_x <span class="token operator">=</span> Conv1D<span class="token punctuation">(</span>
        filters<span class="token operator">=</span>nb_filter<span class="token punctuation">,</span> 
        kernel_size<span class="token operator">=</span><span class="token number">5</span><span class="token punctuation">,</span> 
        strides<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">,</span> 
        padding<span class="token operator">=</span><span class="token string">'same'</span><span class="token punctuation">)</span><span class="token punctuation">(</span>res_x<span class="token punctuation">)</span>
    res_x <span class="token operator">=</span> BatchNormalization<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">(</span>res_x<span class="token punctuation">)</span>
    res_x <span class="token operator">=</span> Activation<span class="token punctuation">(</span><span class="token string">"relu"</span><span class="token punctuation">)</span><span class="token punctuation">(</span>res_x<span class="token punctuation">)</span>

    <span class="token comment"># Third component of main path</span>
    res_x <span class="token operator">=</span> Conv1D<span class="token punctuation">(</span>
        filters<span class="token operator">=</span>nb_filter<span class="token punctuation">,</span> 
        kernel_size<span class="token operator">=</span><span class="token number">5</span><span class="token punctuation">,</span> 
        strides<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">,</span> 
        padding<span class="token operator">=</span><span class="token string">'same'</span><span class="token punctuation">)</span><span class="token punctuation">(</span>res_x<span class="token punctuation">)</span>
    res_x <span class="token operator">=</span> BatchNormalization<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">(</span>res_x<span class="token punctuation">)</span>

    <span class="token comment"># Shortcut path</span>
    x_shortcut <span class="token operator">=</span> Conv1D<span class="token punctuation">(</span>
        filters<span class="token operator">=</span>nb_filter<span class="token punctuation">,</span> 
        kernel_size<span class="token operator">=</span><span class="token number">5</span><span class="token punctuation">,</span> 
        strides<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">,</span> 
        padding<span class="token operator">=</span><span class="token string">'same'</span><span class="token punctuation">)</span><span class="token punctuation">(</span>x_shortcut<span class="token punctuation">)</span>
    x_shortcut <span class="token operator">=</span> BatchNormalization<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">(</span>x_shortcut<span class="token punctuation">)</span>

    <span class="token comment"># Final Step: add shortcut value to the main path</span>
    x <span class="token operator">=</span> Add<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">[</span>x_shortcut<span class="token punctuation">,</span> res_x<span class="token punctuation">]</span><span class="token punctuation">)</span>
    output <span class="token operator">=</span> Activation<span class="token punctuation">(</span><span class="token string">'relu'</span><span class="token punctuation">)</span><span class="token punctuation">(</span>x<span class="token punctuation">)</span>
    <span class="token keyword">return</span> output

<span class="token keyword">def</span> <span class="token function">train_text_resnet</span><span class="token punctuation">(</span>x_train<span class="token punctuation">,</span> y_train<span class="token punctuation">,</span> wv_matrix<span class="token punctuation">,</span> verbose<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">,</span> load_weights<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    tf<span class="token punctuation">.</span>keras<span class="token punctuation">.</span>backend<span class="token punctuation">.</span>clear_session<span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token comment"># Resnet for reviews of UtaPass and KKBOX</span>
    x_input <span class="token operator">=</span> Input<span class="token punctuation">(</span>shape<span class="token operator">=</span><span class="token punctuation">(</span>config<span class="token punctuation">[</span><span class="token string">"MAX_LEN"</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">)</span><span class="token punctuation">)</span>
    x <span class="token operator">=</span> Embedding<span class="token punctuation">(</span>wv_matrix<span class="token punctuation">.</span>shape<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> wv_matrix<span class="token punctuation">.</span>shape<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span> weights<span class="token operator">=</span><span class="token punctuation">[</span>wv_matrix<span class="token punctuation">]</span><span class="token punctuation">,</span> trainable<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">)</span><span class="token punctuation">(</span>x_input<span class="token punctuation">)</span>
    x <span class="token operator">=</span> SpatialDropout1D<span class="token punctuation">(</span><span class="token number">0.25</span><span class="token punctuation">)</span><span class="token punctuation">(</span>x<span class="token punctuation">)</span>

    <span class="token comment"># Stage 1</span>
    x <span class="token operator">=</span> Conv1D<span class="token punctuation">(</span>filters<span class="token operator">=</span><span class="token number">64</span><span class="token punctuation">,</span> kernel_size<span class="token operator">=</span><span class="token number">3</span><span class="token punctuation">,</span> strides<span class="token operator">=</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">(</span>x<span class="token punctuation">)</span>
    x <span class="token operator">=</span> BatchNormalization<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">(</span>x<span class="token punctuation">)</span>
    x <span class="token operator">=</span> Activation<span class="token punctuation">(</span><span class="token string">"relu"</span><span class="token punctuation">)</span><span class="token punctuation">(</span>x<span class="token punctuation">)</span>
    x <span class="token operator">=</span> MaxPooling1D<span class="token punctuation">(</span>pool_size<span class="token operator">=</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">(</span>x<span class="token punctuation">)</span>
    <span class="token comment"># Stage 2</span>
    x <span class="token operator">=</span> convolutional_resnet_block<span class="token punctuation">(</span>x<span class="token punctuation">,</span> <span class="token number">64</span><span class="token punctuation">)</span>
    x <span class="token operator">=</span> identity_resnet_block<span class="token punctuation">(</span>x<span class="token punctuation">,</span> <span class="token number">64</span><span class="token punctuation">)</span>
    x <span class="token operator">=</span> identity_resnet_block<span class="token punctuation">(</span>x<span class="token punctuation">,</span> <span class="token number">64</span><span class="token punctuation">)</span>
    <span class="token comment"># Stage 3</span>
    x <span class="token operator">=</span> convolutional_resnet_block<span class="token punctuation">(</span>x<span class="token punctuation">,</span> <span class="token number">128</span><span class="token punctuation">)</span>
    x <span class="token operator">=</span> identity_resnet_block<span class="token punctuation">(</span>x<span class="token punctuation">,</span> <span class="token number">128</span><span class="token punctuation">)</span>
    x <span class="token operator">=</span> identity_resnet_block<span class="token punctuation">(</span>x<span class="token punctuation">,</span> <span class="token number">128</span><span class="token punctuation">)</span>
    x <span class="token operator">=</span> identity_resnet_block<span class="token punctuation">(</span>x<span class="token punctuation">,</span> <span class="token number">128</span><span class="token punctuation">)</span>
    <span class="token comment"># Stage 4</span>
    x <span class="token operator">=</span> convolutional_resnet_block<span class="token punctuation">(</span>x<span class="token punctuation">,</span> <span class="token number">256</span><span class="token punctuation">)</span>
    x <span class="token operator">=</span> identity_resnet_block<span class="token punctuation">(</span>x<span class="token punctuation">,</span> <span class="token number">256</span><span class="token punctuation">)</span>
    x <span class="token operator">=</span> identity_resnet_block<span class="token punctuation">(</span>x<span class="token punctuation">,</span> <span class="token number">256</span><span class="token punctuation">)</span>
    x <span class="token operator">=</span> identity_resnet_block<span class="token punctuation">(</span>x<span class="token punctuation">,</span> <span class="token number">256</span><span class="token punctuation">)</span>
    x <span class="token operator">=</span> identity_resnet_block<span class="token punctuation">(</span>x<span class="token punctuation">,</span> <span class="token number">256</span><span class="token punctuation">)</span>
    x <span class="token operator">=</span> identity_resnet_block<span class="token punctuation">(</span>x<span class="token punctuation">,</span> <span class="token number">256</span><span class="token punctuation">)</span>
    <span class="token comment"># Stage 5</span>
    x <span class="token operator">=</span> convolutional_resnet_block<span class="token punctuation">(</span>x<span class="token punctuation">,</span> <span class="token number">512</span><span class="token punctuation">)</span>
    x <span class="token operator">=</span> identity_resnet_block<span class="token punctuation">(</span>x<span class="token punctuation">,</span> <span class="token number">512</span><span class="token punctuation">)</span>
    x <span class="token operator">=</span> identity_resnet_block<span class="token punctuation">(</span>x<span class="token punctuation">,</span> <span class="token number">512</span><span class="token punctuation">)</span>
    <span class="token comment"># Average pool</span>
    x <span class="token operator">=</span> AveragePooling1D<span class="token punctuation">(</span>pool_size <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">(</span>x<span class="token punctuation">)</span>
    <span class="token comment"># Output layer</span>
    x <span class="token operator">=</span> Flatten<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">(</span>x<span class="token punctuation">)</span>

    x <span class="token operator">=</span> Dense<span class="token punctuation">(</span>units<span class="token operator">=</span><span class="token number">1024</span><span class="token punctuation">,</span> activation<span class="token operator">=</span><span class="token string">'relu'</span><span class="token punctuation">)</span><span class="token punctuation">(</span>x<span class="token punctuation">)</span>
    x <span class="token operator">=</span> Dropout<span class="token punctuation">(</span><span class="token number">0.5</span><span class="token punctuation">)</span><span class="token punctuation">(</span>x<span class="token punctuation">)</span>
    x <span class="token operator">=</span> Dense<span class="token punctuation">(</span>units<span class="token operator">=</span><span class="token number">1024</span><span class="token punctuation">,</span> activation<span class="token operator">=</span><span class="token string">'relu'</span><span class="token punctuation">)</span><span class="token punctuation">(</span>x<span class="token punctuation">)</span>
    x <span class="token operator">=</span> Dense<span class="token punctuation">(</span>units<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">(</span>x<span class="token punctuation">)</span>
    x <span class="token operator">=</span> BatchNormalization<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">(</span>x<span class="token punctuation">)</span>
    x <span class="token operator">=</span> Activation<span class="token punctuation">(</span><span class="token string">'sigmoid'</span><span class="token punctuation">)</span><span class="token punctuation">(</span>x<span class="token punctuation">)</span>

    model <span class="token operator">=</span> Model<span class="token punctuation">(</span>inputs<span class="token operator">=</span>x_input<span class="token punctuation">,</span> outputs<span class="token operator">=</span>x<span class="token punctuation">)</span>
    
    <span class="token keyword">if</span> <span class="token keyword">not</span> load_weights<span class="token punctuation">:</span> 
        model<span class="token punctuation">.</span><span class="token builtin">compile</span><span class="token punctuation">(</span>loss<span class="token operator">=</span>config<span class="token punctuation">[</span><span class="token string">"loss"</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
                      optimizer<span class="token operator">=</span>Nadam<span class="token punctuation">(</span>learning_rate<span class="token operator">=</span><span class="token number">0.001</span><span class="token punctuation">,</span> beta_1<span class="token operator">=</span><span class="token number">0.9</span><span class="token punctuation">,</span> beta_2<span class="token operator">=</span><span class="token number">0.999</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                      metrics<span class="token operator">=</span><span class="token punctuation">[</span>get_f1<span class="token punctuation">]</span><span class="token punctuation">)</span>

        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"="</span><span class="token operator">*</span><span class="token number">20</span><span class="token punctuation">,</span> <span class="token string">"Start Training Text-ResNet"</span><span class="token punctuation">,</span> <span class="token string">"="</span><span class="token operator">*</span><span class="token number">20</span><span class="token punctuation">)</span>

        path <span class="token operator">=</span> <span class="token string">r'C:\Users\YangWang\Desktop\Text_Classifier_for_UtaPass_and_KKBOX\weights\text_resnet_weights.hdf5'</span>
        model_checkpoint <span class="token operator">=</span> ModelCheckpoint<span class="token punctuation">(</span>path<span class="token punctuation">,</span> monitor<span class="token operator">=</span><span class="token string">'val_loss'</span><span class="token punctuation">,</span> verbose<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">,</span> save_best_only<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">,</span> mode<span class="token operator">=</span><span class="token string">'auto'</span><span class="token punctuation">)</span>
        early_stopping <span class="token operator">=</span> EarlyStopping<span class="token punctuation">(</span>monitor<span class="token operator">=</span><span class="token string">'val_loss'</span><span class="token punctuation">,</span> patience<span class="token operator">=</span><span class="token number">20</span><span class="token punctuation">,</span> verbose<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">,</span> mode<span class="token operator">=</span><span class="token string">'auto'</span><span class="token punctuation">)</span>
        reduce_lr <span class="token operator">=</span> ReduceLROnPlateau<span class="token punctuation">(</span>monitor<span class="token operator">=</span><span class="token string">'val_loss'</span><span class="token punctuation">,</span> factor<span class="token operator">=</span><span class="token number">0.2</span><span class="token punctuation">,</span> patience<span class="token operator">=</span><span class="token number">10</span><span class="token punctuation">,</span> min_lr<span class="token operator">=</span><span class="token number">0.001</span><span class="token punctuation">)</span>

        history <span class="token operator">=</span> model<span class="token punctuation">.</span>fit<span class="token punctuation">(</span>
            x_train<span class="token punctuation">,</span> y_train<span class="token punctuation">,</span> 
            batch_size<span class="token operator">=</span>config<span class="token punctuation">[</span><span class="token string">"batch_size"</span><span class="token punctuation">]</span><span class="token punctuation">,</span> 
            epochs<span class="token operator">=</span>config<span class="token punctuation">[</span><span class="token string">"nb_epoch"</span><span class="token punctuation">]</span><span class="token punctuation">,</span> 
            validation_split<span class="token operator">=</span>config<span class="token punctuation">[</span><span class="token string">"validation_split"</span><span class="token punctuation">]</span><span class="token punctuation">,</span> 
            shuffle<span class="token operator">=</span>config<span class="token punctuation">[</span><span class="token string">"shuffle"</span><span class="token punctuation">]</span><span class="token punctuation">,</span> 
            verbose<span class="token operator">=</span>verbose<span class="token punctuation">,</span> 
            callbacks<span class="token operator">=</span><span class="token punctuation">[</span>early_stopping<span class="token punctuation">,</span> reduce_lr<span class="token punctuation">,</span> model_checkpoint<span class="token punctuation">]</span><span class="token punctuation">)</span>
    <span class="token keyword">if</span> load_weights<span class="token punctuation">:</span>
        history <span class="token operator">=</span> <span class="token boolean">None</span>
        path <span class="token operator">=</span> <span class="token string">r'C:\Users\YangWang\Desktop\Text_Classifier_for_UtaPass_and_KKBOX\weights\text_resnet_weights.hdf5'</span>
        model<span class="token punctuation">.</span>load_weights<span class="token punctuation">(</span>path<span class="token punctuation">)</span>
    
    <span class="token keyword">return</span> history<span class="token punctuation">,</span> model<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h3 id="Start-Training"><a href="#Start-Training" class="headerlink" title="Start Training"></a>Start Training</h3><ol>
<li>Train each model and get history and model architecure.</li>
<li>Load the checkpoint from weights folder we saved during training.</li>
<li>Predict sentiment probability from testing set.</li>
<li>Compute accuracy score, f1 score, and confusion matrix.</li>
<li>Plot train and val history (loss and f1) and visualise confusion matrix.</li>
</ol>
<h4 id="Visualisation"><a href="#Visualisation" class="headerlink" title="Visualisation"></a>Visualisation</h4><p>Define two ploting functions to visualise the history of accuracy and loss.</p>
<pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">import</span> matplotlib<span class="token punctuation">.</span>pyplot <span class="token keyword">as</span> plt
plt<span class="token punctuation">.</span>style<span class="token punctuation">.</span>use<span class="token punctuation">(</span><span class="token string">'ggplot'</span><span class="token punctuation">)</span>

<span class="token keyword">def</span> <span class="token function">plot_history_ggplot</span><span class="token punctuation">(</span>history<span class="token punctuation">)</span><span class="token punctuation">:</span>
    acc <span class="token operator">=</span> history<span class="token punctuation">.</span>history<span class="token punctuation">[</span><span class="token string">'acc'</span><span class="token punctuation">]</span>
    val_acc <span class="token operator">=</span> history<span class="token punctuation">.</span>history<span class="token punctuation">[</span><span class="token string">'val_acc'</span><span class="token punctuation">]</span>
    loss <span class="token operator">=</span> history<span class="token punctuation">.</span>history<span class="token punctuation">[</span><span class="token string">'loss'</span><span class="token punctuation">]</span>
    val_loss <span class="token operator">=</span> history<span class="token punctuation">.</span>history<span class="token punctuation">[</span><span class="token string">'val_loss'</span><span class="token punctuation">]</span>
    x <span class="token operator">=</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token builtin">len</span><span class="token punctuation">(</span>acc<span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span>

    plt<span class="token punctuation">.</span>figure<span class="token punctuation">(</span>figsize<span class="token operator">=</span><span class="token punctuation">(</span><span class="token number">12</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    plt<span class="token punctuation">.</span>subplot<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span>
    plt<span class="token punctuation">.</span>plot<span class="token punctuation">(</span>x<span class="token punctuation">,</span> acc<span class="token punctuation">,</span> <span class="token string">'b'</span><span class="token punctuation">,</span> label<span class="token operator">=</span><span class="token string">'Training acc'</span><span class="token punctuation">)</span>
    plt<span class="token punctuation">.</span>plot<span class="token punctuation">(</span>x<span class="token punctuation">,</span> val_acc<span class="token punctuation">,</span> <span class="token string">'r'</span><span class="token punctuation">,</span> label<span class="token operator">=</span><span class="token string">'Validation acc'</span><span class="token punctuation">)</span>
    plt<span class="token punctuation">.</span>title<span class="token punctuation">(</span><span class="token string">'Training and validation accuracy'</span><span class="token punctuation">)</span>
    plt<span class="token punctuation">.</span>legend<span class="token punctuation">(</span><span class="token punctuation">)</span>
    plt<span class="token punctuation">.</span>subplot<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span>
    plt<span class="token punctuation">.</span>plot<span class="token punctuation">(</span>x<span class="token punctuation">,</span> loss<span class="token punctuation">,</span> <span class="token string">'b'</span><span class="token punctuation">,</span> label<span class="token operator">=</span><span class="token string">'Training loss'</span><span class="token punctuation">)</span>
    plt<span class="token punctuation">.</span>plot<span class="token punctuation">(</span>x<span class="token punctuation">,</span> val_loss<span class="token punctuation">,</span> <span class="token string">'r'</span><span class="token punctuation">,</span> label<span class="token operator">=</span><span class="token string">'Validation loss'</span><span class="token punctuation">)</span>
    plt<span class="token punctuation">.</span>title<span class="token punctuation">(</span><span class="token string">'Training and validation loss'</span><span class="token punctuation">)</span>
    plt<span class="token punctuation">.</span>legend<span class="token punctuation">(</span><span class="token punctuation">)</span>
    
<span class="token keyword">def</span> <span class="token function">plot_history</span><span class="token punctuation">(</span>history<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token comment"># plot results</span>
    loss <span class="token operator">=</span> history<span class="token punctuation">.</span>history<span class="token punctuation">[</span><span class="token string">'loss'</span><span class="token punctuation">]</span>
    val_loss <span class="token operator">=</span> history<span class="token punctuation">.</span>history<span class="token punctuation">[</span><span class="token string">'val_loss'</span><span class="token punctuation">]</span>

    f1 <span class="token operator">=</span> history<span class="token punctuation">.</span>history<span class="token punctuation">[</span><span class="token string">'acc'</span><span class="token punctuation">]</span>
    val_f1 <span class="token operator">=</span> history<span class="token punctuation">.</span>history<span class="token punctuation">[</span><span class="token string">'val_acc'</span><span class="token punctuation">]</span>

    plt<span class="token punctuation">.</span>figure<span class="token punctuation">(</span>figsize<span class="token operator">=</span><span class="token punctuation">(</span><span class="token number">20</span><span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    plt<span class="token punctuation">.</span>subplot<span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span>
    plt<span class="token punctuation">.</span>title<span class="token punctuation">(</span><span class="token string">'Loss'</span><span class="token punctuation">)</span>
    epochs <span class="token operator">=</span> <span class="token builtin">len</span><span class="token punctuation">(</span>loss<span class="token punctuation">)</span>
    plt<span class="token punctuation">.</span>plot<span class="token punctuation">(</span><span class="token builtin">range</span><span class="token punctuation">(</span>epochs<span class="token punctuation">)</span><span class="token punctuation">,</span> loss<span class="token punctuation">,</span> marker<span class="token operator">=</span><span class="token string">'.'</span><span class="token punctuation">,</span> label<span class="token operator">=</span><span class="token string">'loss'</span><span class="token punctuation">)</span>
    plt<span class="token punctuation">.</span>plot<span class="token punctuation">(</span><span class="token builtin">range</span><span class="token punctuation">(</span>epochs<span class="token punctuation">)</span><span class="token punctuation">,</span> val_loss<span class="token punctuation">,</span> marker<span class="token operator">=</span><span class="token string">'.'</span><span class="token punctuation">,</span> label<span class="token operator">=</span><span class="token string">'val_loss'</span><span class="token punctuation">)</span>
    plt<span class="token punctuation">.</span>legend<span class="token punctuation">(</span>loc<span class="token operator">=</span><span class="token string">'best'</span><span class="token punctuation">)</span>
    ax <span class="token operator">=</span> plt<span class="token punctuation">.</span>gca<span class="token punctuation">(</span><span class="token punctuation">)</span>
    ax<span class="token punctuation">.</span>spines<span class="token punctuation">[</span><span class="token string">'bottom'</span><span class="token punctuation">]</span><span class="token punctuation">.</span>set_linewidth<span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">)</span>
    ax<span class="token punctuation">.</span>spines<span class="token punctuation">[</span><span class="token string">'top'</span><span class="token punctuation">]</span><span class="token punctuation">.</span>set_linewidth<span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">)</span>
    ax<span class="token punctuation">.</span>spines<span class="token punctuation">[</span><span class="token string">'right'</span><span class="token punctuation">]</span><span class="token punctuation">.</span>set_linewidth<span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">)</span>
    ax<span class="token punctuation">.</span>spines<span class="token punctuation">[</span><span class="token string">'left'</span><span class="token punctuation">]</span><span class="token punctuation">.</span>set_linewidth<span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">)</span>
    ax<span class="token punctuation">.</span>set_facecolor<span class="token punctuation">(</span><span class="token string">'snow'</span><span class="token punctuation">)</span>
    plt<span class="token punctuation">.</span>grid<span class="token punctuation">(</span>color<span class="token operator">=</span><span class="token string">'lightgray'</span><span class="token punctuation">,</span> linestyle<span class="token operator">=</span><span class="token string">'-'</span><span class="token punctuation">,</span> linewidth<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span>
    plt<span class="token punctuation">.</span>xlabel<span class="token punctuation">(</span><span class="token string">'epoch'</span><span class="token punctuation">)</span>
    plt<span class="token punctuation">.</span>ylabel<span class="token punctuation">(</span><span class="token string">'loss'</span><span class="token punctuation">)</span>

    plt<span class="token punctuation">.</span>subplot<span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span>
    plt<span class="token punctuation">.</span>title<span class="token punctuation">(</span><span class="token string">'Accuracy'</span><span class="token punctuation">)</span>
    plt<span class="token punctuation">.</span>plot<span class="token punctuation">(</span><span class="token builtin">range</span><span class="token punctuation">(</span>epochs<span class="token punctuation">)</span><span class="token punctuation">,</span> f1<span class="token punctuation">,</span> marker<span class="token operator">=</span><span class="token string">'.'</span><span class="token punctuation">,</span> label<span class="token operator">=</span><span class="token string">'acc'</span><span class="token punctuation">)</span>
    plt<span class="token punctuation">.</span>plot<span class="token punctuation">(</span><span class="token builtin">range</span><span class="token punctuation">(</span>epochs<span class="token punctuation">)</span><span class="token punctuation">,</span> val_f1<span class="token punctuation">,</span> marker<span class="token operator">=</span><span class="token string">'.'</span><span class="token punctuation">,</span> label<span class="token operator">=</span><span class="token string">'val_acc'</span><span class="token punctuation">)</span>
    plt<span class="token punctuation">.</span>legend<span class="token punctuation">(</span>loc<span class="token operator">=</span><span class="token string">'best'</span><span class="token punctuation">)</span>
    ax <span class="token operator">=</span> plt<span class="token punctuation">.</span>gca<span class="token punctuation">(</span><span class="token punctuation">)</span>
    ax<span class="token punctuation">.</span>spines<span class="token punctuation">[</span><span class="token string">'bottom'</span><span class="token punctuation">]</span><span class="token punctuation">.</span>set_linewidth<span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">)</span>
    ax<span class="token punctuation">.</span>spines<span class="token punctuation">[</span><span class="token string">'top'</span><span class="token punctuation">]</span><span class="token punctuation">.</span>set_linewidth<span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">)</span>
    ax<span class="token punctuation">.</span>spines<span class="token punctuation">[</span><span class="token string">'right'</span><span class="token punctuation">]</span><span class="token punctuation">.</span>set_linewidth<span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">)</span>
    ax<span class="token punctuation">.</span>spines<span class="token punctuation">[</span><span class="token string">'left'</span><span class="token punctuation">]</span><span class="token punctuation">.</span>set_linewidth<span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">)</span>
    ax<span class="token punctuation">.</span>set_facecolor<span class="token punctuation">(</span><span class="token string">'snow'</span><span class="token punctuation">)</span>
    plt<span class="token punctuation">.</span>grid<span class="token punctuation">(</span>color<span class="token operator">=</span><span class="token string">'lightgray'</span><span class="token punctuation">,</span> linestyle<span class="token operator">=</span><span class="token string">'-'</span><span class="token punctuation">,</span> linewidth<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span>
    plt<span class="token punctuation">.</span>xlabel<span class="token punctuation">(</span><span class="token string">'epoch'</span><span class="token punctuation">)</span>
    plt<span class="token punctuation">.</span>ylabel<span class="token punctuation">(</span><span class="token string">'acc'</span><span class="token punctuation">)</span>
    
    plt<span class="token punctuation">.</span>tight_layout<span class="token punctuation">(</span><span class="token punctuation">)</span>
    plt<span class="token punctuation">.</span>show<span class="token punctuation">(</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>Plot confusion matrix heatmap.</p>
<pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">def</span> <span class="token function">plot_confusion_matrix</span><span class="token punctuation">(</span>cm<span class="token punctuation">)</span><span class="token punctuation">:</span>
    df_cm <span class="token operator">=</span> pd<span class="token punctuation">.</span>DataFrame<span class="token punctuation">(</span>cm<span class="token punctuation">)</span>
    plt<span class="token punctuation">.</span>figure<span class="token punctuation">(</span>figsize<span class="token operator">=</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">,</span> <span class="token number">8</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    hmap <span class="token operator">=</span> sns<span class="token punctuation">.</span>heatmap<span class="token punctuation">(</span>cm<span class="token punctuation">,</span> annot<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">,</span> fmt<span class="token operator">=</span><span class="token string">"d"</span><span class="token punctuation">,</span> cmap<span class="token operator">=</span><span class="token string">"Blues"</span><span class="token punctuation">)</span>
    hmap<span class="token punctuation">.</span>yaxis<span class="token punctuation">.</span>set_ticklabels<span class="token punctuation">(</span>hmap<span class="token punctuation">.</span>yaxis<span class="token punctuation">.</span>get_ticklabels<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> rotation<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">,</span> ha<span class="token operator">=</span><span class="token string">"right"</span><span class="token punctuation">)</span>
    hmap<span class="token punctuation">.</span>xaxis<span class="token punctuation">.</span>set_ticklabels<span class="token punctuation">(</span>hmap<span class="token punctuation">.</span>xaxis<span class="token punctuation">.</span>get_ticklabels<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> rotation<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">,</span> ha<span class="token operator">=</span><span class="token string">"right"</span><span class="token punctuation">)</span>
    plt<span class="token punctuation">.</span>xlabel<span class="token punctuation">(</span><span class="token string">"Predicted Sentiment"</span><span class="token punctuation">)</span>
    plt<span class="token punctuation">.</span>ylabel<span class="token punctuation">(</span><span class="token string">"Target Sentiment"</span><span class="token punctuation">)</span>
    plt<span class="token punctuation">.</span>show<span class="token punctuation">(</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h3 id="Accuracy-F1-Score-and-Confusion-Matrix"><a href="#Accuracy-F1-Score-and-Confusion-Matrix" class="headerlink" title="Accuracy, F1 Score, and Confusion Matrix"></a>Accuracy, F1 Score, and Confusion Matrix</h3><p>Compare the performance among several deep learning models.</p>
<h4 id="Simple-RNN-1"><a href="#Simple-RNN-1" class="headerlink" title="Simple RNN"></a>Simple RNN</h4><p>Accuracy:  0.7419<br>F1 Score:  0.7773</p>
<details>
<summary>Simple RNN Model Architecture</summary>
<pre><code>
Model: "model_1"
_________________________________________________________________
Layer (type)                 Output Shape              Param #   
=================================================================
input_1 (InputLayer)         (None, 64)                0         
_________________________________________________________________
embedding_1 (Embedding)      (None, 64, 300)           2251500   
_________________________________________________________________
spatial_dropout1d_1 (Spatial (None, 64, 300)           0         
_________________________________________________________________
simple_rnn_1 (SimpleRNN)     (None, 64, 50)            17550     
_________________________________________________________________
simple_rnn_2 (SimpleRNN)     (None, 50)                5050      
_________________________________________________________________
dropout_1 (Dropout)          (None, 50)                0         
_________________________________________________________________
dense_1 (Dense)              (None, 1)                 51        
_________________________________________________________________
activation_1 (Activation)    (None, 1)                 0         
=================================================================
Total params: 2,274,151
Trainable params: 22,651
Non-trainable params: 2,251,500
_________________________________________________________________
</code></pre>
</details>

<h4 id="GRU-1"><a href="#GRU-1" class="headerlink" title="GRU"></a>GRU</h4><p>Accuracy:  0.7821<br>F1 Score:  0.8216</p>
<details>
<summary>GRU Model Architecture</summary>
<pre><code>
Model: "model_1"
_________________________________________________________________
Layer (type)                 Output Shape              Param #   
=================================================================
input_1 (InputLayer)         (None, 64)                0         
_________________________________________________________________
embedding_1 (Embedding)      (None, 64, 300)           2251500   
_________________________________________________________________
spatial_dropout1d_1 (Spatial (None, 64, 300)           0         
_________________________________________________________________
gru_1 (GRU)                  (None, 64, 50)            52650     
_________________________________________________________________
gru_2 (GRU)                  (None, 50)                15150     
_________________________________________________________________
dropout_1 (Dropout)          (None, 50)                0         
_________________________________________________________________
dense_1 (Dense)              (None, 1)                 51        
_________________________________________________________________
activation_1 (Activation)    (None, 1)                 0         
=================================================================
Total params: 2,319,351
Trainable params: 67,851
Non-trainable params: 2,251,500
_________________________________________________________________
</code></pre>
</details>

<h4 id="LSTM-1"><a href="#LSTM-1" class="headerlink" title="LSTM"></a>LSTM</h4><p>Accuracy:  0.7697<br>F1 Score:  0.7945</p>
<details>
<summary>LSTM Model Architecture</summary>
<pre><code>
Model: "model_1"
_________________________________________________________________
Layer (type)                 Output Shape              Param #   
=================================================================
input_1 (InputLayer)         (None, 64)                0         
_________________________________________________________________
embedding_1 (Embedding)      (None, 64, 300)           2251500   
_________________________________________________________________
spatial_dropout1d_1 (Spatial (None, 64, 300)           0         
_________________________________________________________________
lstm_1 (LSTM)                (None, 64, 64)            93440     
_________________________________________________________________
lstm_2 (LSTM)                (None, 64)                33024     
_________________________________________________________________
dropout_1 (Dropout)          (None, 64)                0         
_________________________________________________________________
dense_1 (Dense)              (None, 1)                 65        
_________________________________________________________________
activation_1 (Activation)    (None, 1)                 0         
=================================================================
Total params: 2,378,029
Trainable params: 126,529
Non-trainable params: 2,251,500
_________________________________________________________________
</code></pre>
</details>

<h4 id="BiLSTM-1"><a href="#BiLSTM-1" class="headerlink" title="BiLSTM"></a>BiLSTM</h4><p>Accuracy:  0.7430<br>F1 Score:  0.7696</p>
<details>
<summary>BiLSTM Model Architecture</summary>
<pre><code>
Model: "model_1"
_________________________________________________________________
Layer (type)                 Output Shape              Param #   
=================================================================
input_1 (InputLayer)         (None, 64)                0         
_________________________________________________________________
embedding_1 (Embedding)      (None, 64, 300)           2251500   
_________________________________________________________________
spatial_dropout1d_1 (Spatial (None, 64, 300)           0         
_________________________________________________________________
bidirectional_1 (Bidirection (None, 64, 128)           186880    
_________________________________________________________________
bidirectional_2 (Bidirection (None, 128)               98816     
_________________________________________________________________
dropout_1 (Dropout)          (None, 128)               0         
_________________________________________________________________
dense_1 (Dense)              (None, 128)               16512     
_________________________________________________________________
dropout_2 (Dropout)          (None, 128)               0         
_________________________________________________________________
dense_2 (Dense)              (None, 1)                 129       
_________________________________________________________________
activation_1 (Activation)    (None, 1)                 0         
=================================================================
Total params: 2,553,837
Trainable params: 302,337
Non-trainable params: 2,251,500
_________________________________________________________________
</code></pre>
</details>

<h4 id="Attention-1"><a href="#Attention-1" class="headerlink" title="Attention"></a>Attention</h4><p>Accuracy:  0.7496<br>F1 Score:  0.7857</p>
<details>
<summary>Attention Model Architecture</summary>
<pre><code>
Model: "model_1"
_________________________________________________________________
Layer (type)                 Output Shape              Param #   
=================================================================
input_1 (InputLayer)         (None, 64)                0         
_________________________________________________________________
embedding_1 (Embedding)      (None, 64, 300)           2251500   
_________________________________________________________________
spatial_dropout1d_1 (Spatial (None, 64, 300)           0         
_________________________________________________________________
seq_self_attention_1 (SeqSel (None, 64, 300)           77057     
_________________________________________________________________
seq_self_attention_2 (SeqSel (None, 64, 300)           77057     
_________________________________________________________________
seq_self_attention_3 (SeqSel (None, 64, 300)           77057     
_________________________________________________________________
flatten_1 (Flatten)          (None, 19200)             0         
_________________________________________________________________
dropout_1 (Dropout)          (None, 19200)             0         
_________________________________________________________________
dense_1 (Dense)              (None, 1)                 19201     
_________________________________________________________________
activation_1 (Activation)    (None, 1)                 0         
=================================================================
Total params: 2,501,872
Trainable params: 250,372
Non-trainable params: 2,251,500
_________________________________________________________________
</code></pre>
</details>

<h4 id="CNN-Static"><a href="#CNN-Static" class="headerlink" title="CNN-Static"></a>CNN-Static</h4><p>Accuracy:  0.7736<br>F1 Score:  0.8031</p>
<details>
<summary>CNN-Static Model Architecture</summary>
<pre><code>
Model: "model_1"
__________________________________________________________________________________________________
Layer (type)                    Output Shape         Param #     Connected to                     
==================================================================================================
input_1 (InputLayer)            (None, 64)           0                                            
__________________________________________________________________________________________________
embedding_1 (Embedding)         (None, 64, 300)      2251500     input_1[0][0]                    
__________________________________________________________________________________________________
conv1d_1 (Conv1D)               (None, 64, 150)      135150      embedding_1[0][0]                
__________________________________________________________________________________________________
conv1d_2 (Conv1D)               (None, 64, 150)      180150      embedding_1[0][0]                
__________________________________________________________________________________________________
conv1d_3 (Conv1D)               (None, 64, 150)      225150      embedding_1[0][0]                
__________________________________________________________________________________________________
batch_normalization_1 (BatchNor (None, 64, 150)      600         conv1d_1[0][0]                   
__________________________________________________________________________________________________
batch_normalization_2 (BatchNor (None, 64, 150)      600         conv1d_2[0][0]                   
__________________________________________________________________________________________________
batch_normalization_3 (BatchNor (None, 64, 150)      600         conv1d_3[0][0]                   
__________________________________________________________________________________________________
activation_1 (Activation)       (None, 64, 150)      0           batch_normalization_1[0][0]      
__________________________________________________________________________________________________
activation_2 (Activation)       (None, 64, 150)      0           batch_normalization_2[0][0]      
__________________________________________________________________________________________________
activation_3 (Activation)       (None, 64, 150)      0           batch_normalization_3[0][0]      
__________________________________________________________________________________________________
max_pooling1d_1 (MaxPooling1D)  (None, 3, 150)       0           activation_1[0][0]               
__________________________________________________________________________________________________
max_pooling1d_2 (MaxPooling1D)  (None, 4, 150)       0           activation_2[0][0]               
__________________________________________________________________________________________________
max_pooling1d_3 (MaxPooling1D)  (None, 5, 150)       0           activation_3[0][0]               
__________________________________________________________________________________________________
concatenate_1 (Concatenate)     (None, 12, 150)      0           max_pooling1d_1[0][0]            
                                                                 max_pooling1d_2[0][0]            
                                                                 max_pooling1d_3[0][0]            
__________________________________________________________________________________________________
flatten_1 (Flatten)             (None, 1800)         0           concatenate_1[0][0]              
__________________________________________________________________________________________________
dropout_1 (Dropout)             (None, 1800)         0           flatten_1[0][0]                  
__________________________________________________________________________________________________
dense_1 (Dense)                 (None, 1)            1801        dropout_1[0][0]                  
__________________________________________________________________________________________________
activation_4 (Activation)       (None, 1)            0           dense_1[0][0]                    
==================================================================================================
Total params: 2,795,551
Trainable params: 543,151
Non-trainable params: 2,252,400
__________________________________________________________________________________________________
</code></pre>
</details>

<h4 id="CNN-MultiChannel"><a href="#CNN-MultiChannel" class="headerlink" title="CNN-MultiChannel"></a>CNN-MultiChannel</h4><p>Accuracy:  0.7744<br>F1 Score:  0.8073</p>
<details>
<summary>CNN-MultiChannel Model Architecture</summary>
<pre><code>
Model: "model_1"
__________________________________________________________________________________________________
Layer (type)                    Output Shape         Param #     Connected to                     
==================================================================================================
input_1 (InputLayer)            (None, 64)           0                                            
__________________________________________________________________________________________________
input_2 (InputLayer)            (None, 64)           0                                            
__________________________________________________________________________________________________
input_3 (InputLayer)            (None, 64)           0                                            
__________________________________________________________________________________________________
embedding_1 (Embedding)         (None, 64, 300)      2251500     input_1[0][0]                    
__________________________________________________________________________________________________
embedding_2 (Embedding)         (None, 64, 300)      2251500     input_2[0][0]                    
__________________________________________________________________________________________________
embedding_3 (Embedding)         (None, 64, 300)      2251500     input_3[0][0]                    
__________________________________________________________________________________________________
conv1d_1 (Conv1D)               (None, 64, 150)      135150      embedding_1[0][0]                
__________________________________________________________________________________________________
conv1d_2 (Conv1D)               (None, 64, 150)      135150      embedding_2[0][0]                
__________________________________________________________________________________________________
conv1d_3 (Conv1D)               (None, 64, 150)      135150      embedding_3[0][0]                
__________________________________________________________________________________________________
batch_normalization_1 (BatchNor (None, 64, 150)      600         conv1d_1[0][0]                   
__________________________________________________________________________________________________
batch_normalization_2 (BatchNor (None, 64, 150)      600         conv1d_2[0][0]                   
__________________________________________________________________________________________________
batch_normalization_3 (BatchNor (None, 64, 150)      600         conv1d_3[0][0]                   
__________________________________________________________________________________________________
activation_1 (Activation)       (None, 64, 150)      0           batch_normalization_1[0][0]      
__________________________________________________________________________________________________
activation_2 (Activation)       (None, 64, 150)      0           batch_normalization_2[0][0]      
__________________________________________________________________________________________________
activation_3 (Activation)       (None, 64, 150)      0           batch_normalization_3[0][0]      
__________________________________________________________________________________________________
max_pooling1d_1 (MaxPooling1D)  (None, 3, 150)       0           activation_1[0][0]               
__________________________________________________________________________________________________
max_pooling1d_2 (MaxPooling1D)  (None, 3, 150)       0           activation_2[0][0]               
__________________________________________________________________________________________________
max_pooling1d_3 (MaxPooling1D)  (None, 3, 150)       0           activation_3[0][0]               
__________________________________________________________________________________________________
flatten_1 (Flatten)             (None, 450)          0           max_pooling1d_1[0][0]            
__________________________________________________________________________________________________
flatten_2 (Flatten)             (None, 450)          0           max_pooling1d_2[0][0]            
__________________________________________________________________________________________________
flatten_3 (Flatten)             (None, 450)          0           max_pooling1d_3[0][0]            
__________________________________________________________________________________________________
concatenate_1 (Concatenate)     (None, 1350)         0           flatten_1[0][0]                  
                                                                 flatten_2[0][0]                  
                                                                 flatten_3[0][0]                  
__________________________________________________________________________________________________
dense_1 (Dense)                 (None, 100)          135100      concatenate_1[0][0]              
__________________________________________________________________________________________________
activation_4 (Activation)       (None, 100)          0           dense_1[0][0]                    
__________________________________________________________________________________________________
dropout_1 (Dropout)             (None, 100)          0           activation_4[0][0]               
__________________________________________________________________________________________________
dense_2 (Dense)                 (None, 1)            101         dropout_1[0][0]                  
__________________________________________________________________________________________________
activation_5 (Activation)       (None, 1)            0           dense_2[0][0]                    
==================================================================================================
Total params: 7,296,951
Trainable params: 541,551
Non-trainable params: 6,755,400
__________________________________________________________________________________________________
</code></pre>
</details>

<h4 id="CNN-LSTM-1"><a href="#CNN-LSTM-1" class="headerlink" title="CNN-LSTM"></a>CNN-LSTM</h4><p>Accuracy:  0.7380<br>F1 Score:  0.7785</p>
<details>
<summary>CNN-LSTM Model Architecture</summary>
<pre><code>
Model: "model_1"
_________________________________________________________________
Layer (type)                 Output Shape              Param #   
=================================================================
input_1 (InputLayer)         (None, 64)                0         
_________________________________________________________________
embedding_1 (Embedding)      (None, 64, 300)           2251500   
_________________________________________________________________
spatial_dropout1d_1 (Spatial (None, 64, 300)           0         
_________________________________________________________________
conv1d_1 (Conv1D)            (None, 64, 150)           135150    
_________________________________________________________________
batch_normalization_1 (Batch (None, 64, 150)           600       
_________________________________________________________________
activation_1 (Activation)    (None, 64, 150)           0         
_________________________________________________________________
max_pooling1d_1 (MaxPooling1 (None, 32, 150)           0         
_________________________________________________________________
conv1d_2 (Conv1D)            (None, 32, 300)           135300    
_________________________________________________________________
batch_normalization_2 (Batch (None, 32, 300)           1200      
_________________________________________________________________
activation_2 (Activation)    (None, 32, 300)           0         
_________________________________________________________________
max_pooling1d_2 (MaxPooling1 (None, 16, 300)           0         
_________________________________________________________________
conv1d_3 (Conv1D)            (None, 16, 600)           540600    
_________________________________________________________________
batch_normalization_3 (Batch (None, 16, 600)           2400      
_________________________________________________________________
activation_3 (Activation)    (None, 16, 600)           0         
_________________________________________________________________
max_pooling1d_3 (MaxPooling1 (None, 8, 600)            0         
_________________________________________________________________
lstm_1 (LSTM)                (None, 8, 64)             170240    
_________________________________________________________________
seq_self_attention_1 (SeqSel (None, 8, 64)             8321      
_________________________________________________________________
flatten_1 (Flatten)          (None, 512)               0         
_________________________________________________________________
dense_1 (Dense)              (None, 128)               65664     
_________________________________________________________________
dropout_1 (Dropout)          (None, 128)               0         
_________________________________________________________________
dense_2 (Dense)              (None, 1)                 129       
_________________________________________________________________
activation_4 (Activation)    (None, 1)                 0         
=================================================================
Total params: 3,311,104
Trainable params: 1,057,504
Non-trainable params: 2,253,600
_________________________________________________________________
</code></pre>
</details>

<h4 id="Text-ResNet-1"><a href="#Text-ResNet-1" class="headerlink" title="Text-ResNet"></a>Text-ResNet</h4><p>Accuracy:  0.7283<br>F1 Score:  0.7535</p>
<details>
<summary>Text-ResNet Model Architecture</summary>
<pre><code>
Model: "model_1"
__________________________________________________________________________________________________
Layer (type)                    Output Shape         Param #     Connected to                     
==================================================================================================
input_1 (InputLayer)            (None, 64)           0                                            
__________________________________________________________________________________________________
embedding_1 (Embedding)         (None, 64, 300)      2251500     input_1[0][0]                    
__________________________________________________________________________________________________
spatial_dropout1d_1 (SpatialDro (None, 64, 300)      0           embedding_1[0][0]                
__________________________________________________________________________________________________
conv1d_1 (Conv1D)               (None, 31, 64)       57664       spatial_dropout1d_1[0][0]        
__________________________________________________________________________________________________
batch_normalization_1 (BatchNor (None, 31, 64)       256         conv1d_1[0][0]                   
__________________________________________________________________________________________________
activation_1 (Activation)       (None, 31, 64)       0           batch_normalization_1[0][0]      
__________________________________________________________________________________________________
max_pooling1d_1 (MaxPooling1D)  (None, 15, 64)       0           activation_1[0][0]               
__________________________________________________________________________________________________
conv1d_2 (Conv1D)               (None, 15, 64)       20544       max_pooling1d_1[0][0]            
__________________________________________________________________________________________________
batch_normalization_2 (BatchNor (None, 15, 64)       256         conv1d_2[0][0]                   
__________________________________________________________________________________________________
activation_2 (Activation)       (None, 15, 64)       0           batch_normalization_2[0][0]      
__________________________________________________________________________________________________
conv1d_3 (Conv1D)               (None, 15, 64)       20544       activation_2[0][0]               
__________________________________________________________________________________________________
batch_normalization_3 (BatchNor (None, 15, 64)       256         conv1d_3[0][0]                   
__________________________________________________________________________________________________
activation_3 (Activation)       (None, 15, 64)       0           batch_normalization_3[0][0]      
__________________________________________________________________________________________________
conv1d_5 (Conv1D)               (None, 15, 64)       20544       max_pooling1d_1[0][0]            
__________________________________________________________________________________________________
conv1d_4 (Conv1D)               (None, 15, 64)       20544       activation_3[0][0]               
__________________________________________________________________________________________________
batch_normalization_5 (BatchNor (None, 15, 64)       256         conv1d_5[0][0]                   
__________________________________________________________________________________________________
batch_normalization_4 (BatchNor (None, 15, 64)       256         conv1d_4[0][0]                   
__________________________________________________________________________________________________
add_1 (Add)                     (None, 15, 64)       0           batch_normalization_5[0][0]      
                                                                 batch_normalization_4[0][0]      
__________________________________________________________________________________________________
activation_4 (Activation)       (None, 15, 64)       0           add_1[0][0]                      
__________________________________________________________________________________________________
conv1d_6 (Conv1D)               (None, 15, 64)       20544       activation_4[0][0]               
__________________________________________________________________________________________________
batch_normalization_6 (BatchNor (None, 15, 64)       256         conv1d_6[0][0]                   
__________________________________________________________________________________________________
activation_5 (Activation)       (None, 15, 64)       0           batch_normalization_6[0][0]      
__________________________________________________________________________________________________
conv1d_7 (Conv1D)               (None, 15, 64)       20544       activation_5[0][0]               
__________________________________________________________________________________________________
batch_normalization_7 (BatchNor (None, 15, 64)       256         conv1d_7[0][0]                   
__________________________________________________________________________________________________
activation_6 (Activation)       (None, 15, 64)       0           batch_normalization_7[0][0]      
__________________________________________________________________________________________________
conv1d_8 (Conv1D)               (None, 15, 64)       20544       activation_6[0][0]               
__________________________________________________________________________________________________
batch_normalization_8 (BatchNor (None, 15, 64)       256         conv1d_8[0][0]                   
__________________________________________________________________________________________________
add_2 (Add)                     (None, 15, 64)       0           activation_4[0][0]               
                                                                 batch_normalization_8[0][0]      
__________________________________________________________________________________________________
activation_7 (Activation)       (None, 15, 64)       0           add_2[0][0]                      
__________________________________________________________________________________________________
conv1d_9 (Conv1D)               (None, 15, 64)       20544       activation_7[0][0]               
__________________________________________________________________________________________________
batch_normalization_9 (BatchNor (None, 15, 64)       256         conv1d_9[0][0]                   
__________________________________________________________________________________________________
activation_8 (Activation)       (None, 15, 64)       0           batch_normalization_9[0][0]      
__________________________________________________________________________________________________
conv1d_10 (Conv1D)              (None, 15, 64)       20544       activation_8[0][0]               
__________________________________________________________________________________________________
batch_normalization_10 (BatchNo (None, 15, 64)       256         conv1d_10[0][0]                  
__________________________________________________________________________________________________
activation_9 (Activation)       (None, 15, 64)       0           batch_normalization_10[0][0]     
__________________________________________________________________________________________________
conv1d_11 (Conv1D)              (None, 15, 64)       20544       activation_9[0][0]               
__________________________________________________________________________________________________
batch_normalization_11 (BatchNo (None, 15, 64)       256         conv1d_11[0][0]                  
__________________________________________________________________________________________________
add_3 (Add)                     (None, 15, 64)       0           activation_7[0][0]               
                                                                 batch_normalization_11[0][0]     
__________________________________________________________________________________________________
activation_10 (Activation)      (None, 15, 64)       0           add_3[0][0]                      
__________________________________________________________________________________________________
conv1d_12 (Conv1D)              (None, 15, 128)      41088       activation_10[0][0]              
__________________________________________________________________________________________________
batch_normalization_12 (BatchNo (None, 15, 128)      512         conv1d_12[0][0]                  
__________________________________________________________________________________________________
activation_11 (Activation)      (None, 15, 128)      0           batch_normalization_12[0][0]     
__________________________________________________________________________________________________
conv1d_13 (Conv1D)              (None, 15, 128)      82048       activation_11[0][0]              
__________________________________________________________________________________________________
batch_normalization_13 (BatchNo (None, 15, 128)      512         conv1d_13[0][0]                  
__________________________________________________________________________________________________
activation_12 (Activation)      (None, 15, 128)      0           batch_normalization_13[0][0]     
__________________________________________________________________________________________________
conv1d_15 (Conv1D)              (None, 15, 128)      41088       activation_10[0][0]              
__________________________________________________________________________________________________
conv1d_14 (Conv1D)              (None, 15, 128)      82048       activation_12[0][0]              
__________________________________________________________________________________________________
batch_normalization_15 (BatchNo (None, 15, 128)      512         conv1d_15[0][0]                  
__________________________________________________________________________________________________
batch_normalization_14 (BatchNo (None, 15, 128)      512         conv1d_14[0][0]                  
__________________________________________________________________________________________________
add_4 (Add)                     (None, 15, 128)      0           batch_normalization_15[0][0]     
                                                                 batch_normalization_14[0][0]     
__________________________________________________________________________________________________
activation_13 (Activation)      (None, 15, 128)      0           add_4[0][0]                      
__________________________________________________________________________________________________
conv1d_16 (Conv1D)              (None, 15, 128)      82048       activation_13[0][0]              
__________________________________________________________________________________________________
batch_normalization_16 (BatchNo (None, 15, 128)      512         conv1d_16[0][0]                  
__________________________________________________________________________________________________
activation_14 (Activation)      (None, 15, 128)      0           batch_normalization_16[0][0]     
__________________________________________________________________________________________________
conv1d_17 (Conv1D)              (None, 15, 128)      82048       activation_14[0][0]              
__________________________________________________________________________________________________
batch_normalization_17 (BatchNo (None, 15, 128)      512         conv1d_17[0][0]                  
__________________________________________________________________________________________________
activation_15 (Activation)      (None, 15, 128)      0           batch_normalization_17[0][0]     
__________________________________________________________________________________________________
conv1d_18 (Conv1D)              (None, 15, 128)      82048       activation_15[0][0]              
__________________________________________________________________________________________________
batch_normalization_18 (BatchNo (None, 15, 128)      512         conv1d_18[0][0]                  
__________________________________________________________________________________________________
add_5 (Add)                     (None, 15, 128)      0           activation_13[0][0]              
                                                                 batch_normalization_18[0][0]     
__________________________________________________________________________________________________
activation_16 (Activation)      (None, 15, 128)      0           add_5[0][0]                      
__________________________________________________________________________________________________
conv1d_19 (Conv1D)              (None, 15, 128)      82048       activation_16[0][0]              
__________________________________________________________________________________________________
batch_normalization_19 (BatchNo (None, 15, 128)      512         conv1d_19[0][0]                  
__________________________________________________________________________________________________
activation_17 (Activation)      (None, 15, 128)      0           batch_normalization_19[0][0]     
__________________________________________________________________________________________________
conv1d_20 (Conv1D)              (None, 15, 128)      82048       activation_17[0][0]              
__________________________________________________________________________________________________
batch_normalization_20 (BatchNo (None, 15, 128)      512         conv1d_20[0][0]                  
__________________________________________________________________________________________________
activation_18 (Activation)      (None, 15, 128)      0           batch_normalization_20[0][0]     
__________________________________________________________________________________________________
conv1d_21 (Conv1D)              (None, 15, 128)      82048       activation_18[0][0]              
__________________________________________________________________________________________________
batch_normalization_21 (BatchNo (None, 15, 128)      512         conv1d_21[0][0]                  
__________________________________________________________________________________________________
add_6 (Add)                     (None, 15, 128)      0           activation_16[0][0]              
                                                                 batch_normalization_21[0][0]     
__________________________________________________________________________________________________
activation_19 (Activation)      (None, 15, 128)      0           add_6[0][0]                      
__________________________________________________________________________________________________
conv1d_22 (Conv1D)              (None, 15, 128)      82048       activation_19[0][0]              
__________________________________________________________________________________________________
batch_normalization_22 (BatchNo (None, 15, 128)      512         conv1d_22[0][0]                  
__________________________________________________________________________________________________
activation_20 (Activation)      (None, 15, 128)      0           batch_normalization_22[0][0]     
__________________________________________________________________________________________________
conv1d_23 (Conv1D)              (None, 15, 128)      82048       activation_20[0][0]              
__________________________________________________________________________________________________
batch_normalization_23 (BatchNo (None, 15, 128)      512         conv1d_23[0][0]                  
__________________________________________________________________________________________________
activation_21 (Activation)      (None, 15, 128)      0           batch_normalization_23[0][0]     
__________________________________________________________________________________________________
conv1d_24 (Conv1D)              (None, 15, 128)      82048       activation_21[0][0]              
__________________________________________________________________________________________________
batch_normalization_24 (BatchNo (None, 15, 128)      512         conv1d_24[0][0]                  
__________________________________________________________________________________________________
add_7 (Add)                     (None, 15, 128)      0           activation_19[0][0]              
                                                                 batch_normalization_24[0][0]     
__________________________________________________________________________________________________
activation_22 (Activation)      (None, 15, 128)      0           add_7[0][0]                      
__________________________________________________________________________________________________
conv1d_25 (Conv1D)              (None, 15, 256)      164096      activation_22[0][0]              
__________________________________________________________________________________________________
batch_normalization_25 (BatchNo (None, 15, 256)      1024        conv1d_25[0][0]                  
__________________________________________________________________________________________________
activation_23 (Activation)      (None, 15, 256)      0           batch_normalization_25[0][0]     
__________________________________________________________________________________________________
conv1d_26 (Conv1D)              (None, 15, 256)      327936      activation_23[0][0]              
__________________________________________________________________________________________________
batch_normalization_26 (BatchNo (None, 15, 256)      1024        conv1d_26[0][0]                  
__________________________________________________________________________________________________
activation_24 (Activation)      (None, 15, 256)      0           batch_normalization_26[0][0]     
__________________________________________________________________________________________________
conv1d_28 (Conv1D)              (None, 15, 256)      164096      activation_22[0][0]              
__________________________________________________________________________________________________
conv1d_27 (Conv1D)              (None, 15, 256)      327936      activation_24[0][0]              
__________________________________________________________________________________________________
batch_normalization_28 (BatchNo (None, 15, 256)      1024        conv1d_28[0][0]                  
__________________________________________________________________________________________________
batch_normalization_27 (BatchNo (None, 15, 256)      1024        conv1d_27[0][0]                  
__________________________________________________________________________________________________
add_8 (Add)                     (None, 15, 256)      0           batch_normalization_28[0][0]     
                                                                 batch_normalization_27[0][0]     
__________________________________________________________________________________________________
activation_25 (Activation)      (None, 15, 256)      0           add_8[0][0]                      
__________________________________________________________________________________________________
conv1d_29 (Conv1D)              (None, 15, 256)      327936      activation_25[0][0]              
__________________________________________________________________________________________________
batch_normalization_29 (BatchNo (None, 15, 256)      1024        conv1d_29[0][0]                  
__________________________________________________________________________________________________
activation_26 (Activation)      (None, 15, 256)      0           batch_normalization_29[0][0]     
__________________________________________________________________________________________________
conv1d_30 (Conv1D)              (None, 15, 256)      327936      activation_26[0][0]              
__________________________________________________________________________________________________
batch_normalization_30 (BatchNo (None, 15, 256)      1024        conv1d_30[0][0]                  
__________________________________________________________________________________________________
activation_27 (Activation)      (None, 15, 256)      0           batch_normalization_30[0][0]     
__________________________________________________________________________________________________
conv1d_31 (Conv1D)              (None, 15, 256)      327936      activation_27[0][0]              
__________________________________________________________________________________________________
batch_normalization_31 (BatchNo (None, 15, 256)      1024        conv1d_31[0][0]                  
__________________________________________________________________________________________________
add_9 (Add)                     (None, 15, 256)      0           activation_25[0][0]              
                                                                 batch_normalization_31[0][0]     
__________________________________________________________________________________________________
activation_28 (Activation)      (None, 15, 256)      0           add_9[0][0]                      
__________________________________________________________________________________________________
conv1d_32 (Conv1D)              (None, 15, 256)      327936      activation_28[0][0]              
__________________________________________________________________________________________________
batch_normalization_32 (BatchNo (None, 15, 256)      1024        conv1d_32[0][0]                  
__________________________________________________________________________________________________
activation_29 (Activation)      (None, 15, 256)      0           batch_normalization_32[0][0]     
__________________________________________________________________________________________________
conv1d_33 (Conv1D)              (None, 15, 256)      327936      activation_29[0][0]              
__________________________________________________________________________________________________
batch_normalization_33 (BatchNo (None, 15, 256)      1024        conv1d_33[0][0]                  
__________________________________________________________________________________________________
activation_30 (Activation)      (None, 15, 256)      0           batch_normalization_33[0][0]     
__________________________________________________________________________________________________
conv1d_34 (Conv1D)              (None, 15, 256)      327936      activation_30[0][0]              
__________________________________________________________________________________________________
batch_normalization_34 (BatchNo (None, 15, 256)      1024        conv1d_34[0][0]                  
__________________________________________________________________________________________________
add_10 (Add)                    (None, 15, 256)      0           activation_28[0][0]              
                                                                 batch_normalization_34[0][0]     
__________________________________________________________________________________________________
activation_31 (Activation)      (None, 15, 256)      0           add_10[0][0]                     
__________________________________________________________________________________________________
conv1d_35 (Conv1D)              (None, 15, 256)      327936      activation_31[0][0]              
__________________________________________________________________________________________________
batch_normalization_35 (BatchNo (None, 15, 256)      1024        conv1d_35[0][0]                  
__________________________________________________________________________________________________
activation_32 (Activation)      (None, 15, 256)      0           batch_normalization_35[0][0]     
__________________________________________________________________________________________________
conv1d_36 (Conv1D)              (None, 15, 256)      327936      activation_32[0][0]              
__________________________________________________________________________________________________
batch_normalization_36 (BatchNo (None, 15, 256)      1024        conv1d_36[0][0]                  
__________________________________________________________________________________________________
activation_33 (Activation)      (None, 15, 256)      0           batch_normalization_36[0][0]     
__________________________________________________________________________________________________
conv1d_37 (Conv1D)              (None, 15, 256)      327936      activation_33[0][0]              
__________________________________________________________________________________________________
batch_normalization_37 (BatchNo (None, 15, 256)      1024        conv1d_37[0][0]                  
__________________________________________________________________________________________________
add_11 (Add)                    (None, 15, 256)      0           activation_31[0][0]              
                                                                 batch_normalization_37[0][0]     
__________________________________________________________________________________________________
activation_34 (Activation)      (None, 15, 256)      0           add_11[0][0]                     
__________________________________________________________________________________________________
conv1d_38 (Conv1D)              (None, 15, 256)      327936      activation_34[0][0]              
__________________________________________________________________________________________________
batch_normalization_38 (BatchNo (None, 15, 256)      1024        conv1d_38[0][0]                  
__________________________________________________________________________________________________
activation_35 (Activation)      (None, 15, 256)      0           batch_normalization_38[0][0]     
__________________________________________________________________________________________________
conv1d_39 (Conv1D)              (None, 15, 256)      327936      activation_35[0][0]              
__________________________________________________________________________________________________
batch_normalization_39 (BatchNo (None, 15, 256)      1024        conv1d_39[0][0]                  
__________________________________________________________________________________________________
activation_36 (Activation)      (None, 15, 256)      0           batch_normalization_39[0][0]     
__________________________________________________________________________________________________
conv1d_40 (Conv1D)              (None, 15, 256)      327936      activation_36[0][0]              
__________________________________________________________________________________________________
batch_normalization_40 (BatchNo (None, 15, 256)      1024        conv1d_40[0][0]                  
__________________________________________________________________________________________________
add_12 (Add)                    (None, 15, 256)      0           activation_34[0][0]              
                                                                 batch_normalization_40[0][0]     
__________________________________________________________________________________________________
activation_37 (Activation)      (None, 15, 256)      0           add_12[0][0]                     
__________________________________________________________________________________________________
conv1d_41 (Conv1D)              (None, 15, 256)      327936      activation_37[0][0]              
__________________________________________________________________________________________________
batch_normalization_41 (BatchNo (None, 15, 256)      1024        conv1d_41[0][0]                  
__________________________________________________________________________________________________
activation_38 (Activation)      (None, 15, 256)      0           batch_normalization_41[0][0]     
__________________________________________________________________________________________________
conv1d_42 (Conv1D)              (None, 15, 256)      327936      activation_38[0][0]              
__________________________________________________________________________________________________
batch_normalization_42 (BatchNo (None, 15, 256)      1024        conv1d_42[0][0]                  
__________________________________________________________________________________________________
activation_39 (Activation)      (None, 15, 256)      0           batch_normalization_42[0][0]     
__________________________________________________________________________________________________
conv1d_43 (Conv1D)              (None, 15, 256)      327936      activation_39[0][0]              
__________________________________________________________________________________________________
batch_normalization_43 (BatchNo (None, 15, 256)      1024        conv1d_43[0][0]                  
__________________________________________________________________________________________________
add_13 (Add)                    (None, 15, 256)      0           activation_37[0][0]              
                                                                 batch_normalization_43[0][0]     
__________________________________________________________________________________________________
activation_40 (Activation)      (None, 15, 256)      0           add_13[0][0]                     
__________________________________________________________________________________________________
conv1d_44 (Conv1D)              (None, 15, 512)      655872      activation_40[0][0]              
__________________________________________________________________________________________________
batch_normalization_44 (BatchNo (None, 15, 512)      2048        conv1d_44[0][0]                  
__________________________________________________________________________________________________
activation_41 (Activation)      (None, 15, 512)      0           batch_normalization_44[0][0]     
__________________________________________________________________________________________________
conv1d_45 (Conv1D)              (None, 15, 512)      1311232     activation_41[0][0]              
__________________________________________________________________________________________________
batch_normalization_45 (BatchNo (None, 15, 512)      2048        conv1d_45[0][0]                  
__________________________________________________________________________________________________
activation_42 (Activation)      (None, 15, 512)      0           batch_normalization_45[0][0]     
__________________________________________________________________________________________________
conv1d_47 (Conv1D)              (None, 15, 512)      655872      activation_40[0][0]              
__________________________________________________________________________________________________
conv1d_46 (Conv1D)              (None, 15, 512)      1311232     activation_42[0][0]              
__________________________________________________________________________________________________
batch_normalization_47 (BatchNo (None, 15, 512)      2048        conv1d_47[0][0]                  
__________________________________________________________________________________________________
batch_normalization_46 (BatchNo (None, 15, 512)      2048        conv1d_46[0][0]                  
__________________________________________________________________________________________________
add_14 (Add)                    (None, 15, 512)      0           batch_normalization_47[0][0]     
                                                                 batch_normalization_46[0][0]     
__________________________________________________________________________________________________
activation_43 (Activation)      (None, 15, 512)      0           add_14[0][0]                     
__________________________________________________________________________________________________
conv1d_48 (Conv1D)              (None, 15, 512)      1311232     activation_43[0][0]              
__________________________________________________________________________________________________
batch_normalization_48 (BatchNo (None, 15, 512)      2048        conv1d_48[0][0]                  
__________________________________________________________________________________________________
activation_44 (Activation)      (None, 15, 512)      0           batch_normalization_48[0][0]     
__________________________________________________________________________________________________
conv1d_49 (Conv1D)              (None, 15, 512)      1311232     activation_44[0][0]              
__________________________________________________________________________________________________
batch_normalization_49 (BatchNo (None, 15, 512)      2048        conv1d_49[0][0]                  
__________________________________________________________________________________________________
activation_45 (Activation)      (None, 15, 512)      0           batch_normalization_49[0][0]     
__________________________________________________________________________________________________
conv1d_50 (Conv1D)              (None, 15, 512)      1311232     activation_45[0][0]              
__________________________________________________________________________________________________
batch_normalization_50 (BatchNo (None, 15, 512)      2048        conv1d_50[0][0]                  
__________________________________________________________________________________________________
add_15 (Add)                    (None, 15, 512)      0           activation_43[0][0]              
                                                                 batch_normalization_50[0][0]     
__________________________________________________________________________________________________
activation_46 (Activation)      (None, 15, 512)      0           add_15[0][0]                     
__________________________________________________________________________________________________
conv1d_51 (Conv1D)              (None, 15, 512)      1311232     activation_46[0][0]              
__________________________________________________________________________________________________
batch_normalization_51 (BatchNo (None, 15, 512)      2048        conv1d_51[0][0]                  
__________________________________________________________________________________________________
activation_47 (Activation)      (None, 15, 512)      0           batch_normalization_51[0][0]     
__________________________________________________________________________________________________
conv1d_52 (Conv1D)              (None, 15, 512)      1311232     activation_47[0][0]              
__________________________________________________________________________________________________
batch_normalization_52 (BatchNo (None, 15, 512)      2048        conv1d_52[0][0]                  
__________________________________________________________________________________________________
activation_48 (Activation)      (None, 15, 512)      0           batch_normalization_52[0][0]     
__________________________________________________________________________________________________
conv1d_53 (Conv1D)              (None, 15, 512)      1311232     activation_48[0][0]              
__________________________________________________________________________________________________
batch_normalization_53 (BatchNo (None, 15, 512)      2048        conv1d_53[0][0]                  
__________________________________________________________________________________________________
add_16 (Add)                    (None, 15, 512)      0           activation_46[0][0]              
                                                                 batch_normalization_53[0][0]     
__________________________________________________________________________________________________
activation_49 (Activation)      (None, 15, 512)      0           add_16[0][0]                     
__________________________________________________________________________________________________
average_pooling1d_1 (AveragePoo (None, 15, 512)      0           activation_49[0][0]              
__________________________________________________________________________________________________
flatten_1 (Flatten)             (None, 7680)         0           average_pooling1d_1[0][0]        
__________________________________________________________________________________________________
dense_1 (Dense)                 (None, 1024)         7865344     flatten_1[0][0]                  
__________________________________________________________________________________________________
dropout_1 (Dropout)             (None, 1024)         0           dense_1[0][0]                    
__________________________________________________________________________________________________
dense_2 (Dense)                 (None, 1024)         1049600     dropout_1[0][0]                  
__________________________________________________________________________________________________
dense_3 (Dense)                 (None, 1)            1025        dense_2[0][0]                    
__________________________________________________________________________________________________
batch_normalization_54 (BatchNo (None, 1)            4           dense_3[0][0]                    
__________________________________________________________________________________________________
activation_50 (Activation)      (None, 1)            0           batch_normalization_54[0][0]     
==================================================================================================
Total params: 30,169,393
Trainable params: 27,893,187
Non-trainable params: 2,276,206
__________________________________________________________________________________________________
</code></pre>
</details>

<h2 id="Performance"><a href="#Performance" class="headerlink" title="Performance"></a>Performance</h2><h3 id="Proposed-Model"><a href="#Proposed-Model" class="headerlink" title="Proposed Model"></a>Proposed Model</h3><h4 id="Statistical-Model"><a href="#Statistical-Model" class="headerlink" title="Statistical Model"></a>Statistical Model</h4><ol>
<li>Feature extracted by <code>CountVectorizer</code></li>
</ol>
<table>
<thead>
<tr>
<th></th>
<th>Naive Bayes</th>
<th>Gaussian Bayes</th>
<th>Bernoulli Bayes</th>
</tr>
</thead>
<tbody><tr>
<td>Accuracy</td>
<td><strong>0.7904</strong></td>
<td>0.6606</td>
<td>0.7540</td>
</tr>
<tr>
<td>F1 Score</td>
<td><strong>0.8357</strong></td>
<td>0.7689</td>
<td>0.8172</td>
</tr>
</tbody></table>
<ol start="2">
<li>Feature extracted by <code>TfidfVectorizer</code></li>
</ol>
<table>
<thead>
<tr>
<th></th>
<th>Naive Bayes</th>
<th>Gaussian Bayes</th>
<th>Bernoulli Bayes</th>
</tr>
</thead>
<tbody><tr>
<td>Accuracy</td>
<td><strong>0.7879</strong></td>
<td>0.6703</td>
<td>0.7540</td>
</tr>
<tr>
<td>F1 Score</td>
<td><strong>0.8362</strong></td>
<td>0.7708</td>
<td>0.8172</td>
</tr>
</tbody></table>
<h4 id="Deep-Learning-Model"><a href="#Deep-Learning-Model" class="headerlink" title="Deep Learning Model"></a>Deep Learning Model</h4><p>Feature extracted by word2vec.</p>
<table>
<thead>
<tr>
<th></th>
<th>Simple-RNN</th>
<th>GRU</th>
<th>LSTM</th>
<th>BiLSTM</th>
<th>Attention</th>
<th>CNN-Static</th>
<th>CNN-MultiChannel</th>
<th>CNN-LSTM</th>
<th>Text-ResNet</th>
</tr>
</thead>
<tbody><tr>
<td>Accuracy</td>
<td>0.7419</td>
<td><strong>0.7821</strong></td>
<td>0.7697</td>
<td>0.7430</td>
<td>0.7496</td>
<td>0.7736</td>
<td>0.7744</td>
<td>0.7380</td>
<td>0.7283</td>
</tr>
<tr>
<td>F1 Score</td>
<td>0.7773</td>
<td><strong>0.8216</strong></td>
<td>0.7945</td>
<td>0.7696</td>
<td>0.7857</td>
<td>0.8031</td>
<td>0.8073</td>
<td>0.7785</td>
<td>0.7535</td>
</tr>
<tr>
<td>Total params (M)</td>
<td>2.27</td>
<td>2.31</td>
<td>2.37</td>
<td>2.55</td>
<td>2.50</td>
<td>2.79</td>
<td>7.29</td>
<td>3.31</td>
<td>30.16</td>
</tr>
<tr>
<td>Trainable params (M)</td>
<td>0.02</td>
<td>0.06</td>
<td>0.12</td>
<td>0.30</td>
<td>0.25</td>
<td>0.54</td>
<td>0.54</td>
<td>1.05</td>
<td>27.89</td>
</tr>
<tr>
<td>Non-trainable params (M)</td>
<td>2.25</td>
<td>2.25</td>
<td>2.25</td>
<td>2.25</td>
<td>2.25</td>
<td>2.25</td>
<td>6.75</td>
<td>2.25</td>
<td>2.27</td>
</tr>
</tbody></table>
<h4 id="Pre-trained-Language-Model"><a href="#Pre-trained-Language-Model" class="headerlink" title="Pre-trained Language Model"></a>Pre-trained Language Model</h4><table>
<thead>
<tr>
<th></th>
<th>BERT</th>
<th>ALBERT</th>
<th>DISTILBERT</th>
</tr>
</thead>
<tbody><tr>
<td>Accuracy</td>
<td><strong>0.8543</strong></td>
<td>0.8005</td>
<td>0.8528</td>
</tr>
<tr>
<td>F1 Score</td>
<td>0.8806</td>
<td>0.8410</td>
<td><strong>0.8815</strong></td>
</tr>
</tbody></table>
<h2 id="Reference"><a href="#Reference" class="headerlink" title="Reference"></a>Reference</h2><ol>
<li>[<a target="_blank" rel="noopener" href="https://arxiv.org/pdf/1606.01781.pdf">link</a>] Alexis Conneau, Very Deep Convolutional Networks for Text Classification </li>
<li>[<a target="_blank" rel="noopener" href="https://anlp.jp/proceedings/annual_meeting/2018/pdf_dir/P12-2.pdf">link</a>] Lasguido Nio, Japanese Sentiment Classification Using Bidirectional Long Short-Term Memory Recurrent Neural Network </li>
<li>[<a target="_blank" rel="noopener" href="https://www.scitepress.org/Papers/2017/61934/61934.pdf">link</a>] Minato Sato, Japanese Text Classification by Character-level Deep ConvNets and Transfer Learning </li>
<li>[<a target="_blank" rel="noopener" href="https://www.aclweb.org/anthology/D14-1181.pdf">link</a>] Yoon Kim, Convolutional Neural Networks for Sentence Classification </li>
<li>[<a target="_blank" rel="noopener" href="https://arxiv.org/pdf/1810.04805.pdf">link</a>] Jacob Devlin, BERT: Pre-training of Deep Bidirectional Transformers for Language Understanding </li>
<li>[<a target="_blank" rel="noopener" href="https://arxiv.org/pdf/1909.11942.pdf">link</a>] Zhenzhong Lan, ALBERT: A Lite BERT for Self-supervised Learning of Language Representations </li>
<li>[<a target="_blank" rel="noopener" href="https://arxiv.org/pdf/1910.01108.pdf">link</a>] Victor Sanh, DistilBERT, a distilled version of BERT: smaller, faster, cheaper and lighter </li>
<li>[<a target="_blank" rel="noopener" href="https://www.bioinf.jku.at/publications/older/2604.pdf">link</a>] Sepp Hochreiter, Long Short-Term Memory </li>
<li>[<a target="_blank" rel="noopener" href="https://papers.nips.cc/paper/5021-distributed-representations-of-words-and-phrases-and-their-compositionality.pdf">link</a>] Tomas Mikolov, Distributed representations of words and phrases and their compositionality </li>
<li>[<a target="_blank" rel="noopener" href="https://www.aclweb.org/anthology/E17-1096.pdf">link</a>] Amr El-Desoky Mousa, Contextual bidirectional long short-term memory recurrent neural network language models: A generative approach to sentiment analysis </li>
<li>[<a target="_blank" rel="noopener" href="https://dl.acm.org/doi/pdf/10.1145/2766462.2767830">link</a>] Aliaksei Severyn, Twitter sentiment analysis with deep convolutional neural networks </li>
<li>[<a target="_blank" rel="noopener" href="http://jmlr.org/papers/volume15/srivastava14a/srivastava14a.pdf">link</a>] Nitish Srivastava, Dropout: A Simple Way to Prevent Neural Networks from Overfitting </li>
<li>[<a target="_blank" rel="noopener" href="https://arxiv.org/pdf/1502.03167.pdf">link</a>] Sergey Ioffe, Batch Normalization: Accelerating Deep Network Training by Reducing Internal Covariate Shift </li>
<li>[<a target="_blank" rel="noopener" href="https://arxiv.org/pdf/1602.07868.pdf">link</a>] Tim Salimans, Weight Normalization: A Simple Reparameterization to Accelerate Training of Deep Neural Networks </li>
<li>[<a target="_blank" rel="noopener" href="https://arxiv.org/pdf/1706.03762.pdf">link</a>] Ashish Vaswani, Attention Is All You Need </li>
<li>[<a target="_blank" rel="noopener" href="https://arxiv.org/pdf/1906.08237.pdf">link</a>] Zhilin Yang, XLNet: Generalized Autoregressive Pretraining for Language Understanding </li>
<li>[<a target="_blank" rel="noopener" href="https://arxiv.org/pdf/1904.08398.pdf">link</a>] Ashutosh Adhikari, DocBERT: BERT for Document Classification </li>
</ol>
<h2 id="Future-Roadmap"><a href="#Future-Roadmap" class="headerlink" title="Future Roadmap"></a>Future Roadmap</h2><p>It is completely possible to use only raw text as input for making predictions. The most important thing is to automatically extract the relevant features from this raw source of reviews data. Although the models don’t perform well and need more improvement, I have done a practise with a full harvest.</p>
<p>Text classifier is a meat-and-potatoes issue for most sentiment analysis task, and there are still many things can be done on this task. In future works, I might construct a multi-class text classifier to separate customers’ reviews into different issue types. (e.g. Function, UI, Crash, Truncate, Subscription, Server, Enhancement, etc), in order to tackle each consumer’s problem more efficiently and effectively.</p>

                
            </div>
            <hr/>

            

    <div class="reprint" id="reprint-statement">
        
            <div class="reprint__author">
                <span class="reprint-meta" style="font-weight: bold;">
                    <i class="fas fa-user">
                        Author:
                    </i>
                </span>
                <span class="reprint-info">
                    <a href="/Hexo-Blog/about" rel="external nofollow noreferrer">Yang Wang</a>
                </span>
            </div>
            <div class="reprint__type">
                <span class="reprint-meta" style="font-weight: bold;">
                    <i class="fas fa-link">
                        Link:
                    </i>
                </span>
                <span class="reprint-info">
                    <a href="https://penguinwang96825.github.io/Hexo-Blog/Hexo-Blog/2019/07/10/2019-07-10-sentiment-analysis-for-kkbox/">https://penguinwang96825.github.io/Hexo-Blog/Hexo-Blog/2019/07/10/2019-07-10-sentiment-analysis-for-kkbox/</a>
                </span>
            </div>
            <div class="reprint__notice">
                <span class="reprint-meta" style="font-weight: bold;">
                    <i class="fas fa-copyright">
                        Reprint policy:
                    </i>
                </span>
                <span class="reprint-info">
                    All articles in this blog are used except for special statements
                    <a href="https://creativecommons.org/licenses/by/4.0/deed.zh" rel="external nofollow noreferrer" target="_blank">CC BY 4.0</a>
                    reprint polocy. If reproduced, please indicate source
                    <a href="/Hexo-Blog/about" target="_blank">Yang Wang</a>
                    !
                </span>
            </div>
        
    </div>

    <script async defer>
      document.addEventListener("copy", function (e) {
        let toastHTML = '<span>Copied successfully, please follow the reprint policy of this article</span><button class="btn-flat toast-action" onclick="navToReprintStatement()" style="font-size: smaller">more</a>';
        M.toast({html: toastHTML})
      });

      function navToReprintStatement() {
        $("html, body").animate({scrollTop: $("#reprint-statement").offset().top - 80}, 800);
      }
    </script>



            <div class="tag_share" style="display: block;">
                <div class="post-meta__tag-list" style="display: inline-block;">
                    
                        <div class="article-tag">
                            
                                <a href="/Hexo-Blog/tags/Python/">
                                    <span class="chip bg-color">Python</span>
                                </a>
                            
                                <a href="/Hexo-Blog/tags/NLP/">
                                    <span class="chip bg-color">NLP</span>
                                </a>
                            
                                <a href="/Hexo-Blog/tags/KKBOX/">
                                    <span class="chip bg-color">KKBOX</span>
                                </a>
                            
                                <a href="/Hexo-Blog/tags/UtaPass/">
                                    <span class="chip bg-color">UtaPass</span>
                                </a>
                            
                        </div>
                    
                </div>
                <div class="post_share" style="zoom: 80%; width: fit-content; display: inline-block; float: right; margin: -0.15rem 0;">
                    <link rel="stylesheet" type="text/css" href="/Hexo-Blog/libs/share/css/share.min.css">
<div id="article-share">

    
    <div class="social-share" data-sites="twitter,facebook,google,qq,qzone,wechat,weibo,douban,linkedin" data-wechat-qrcode-helper="<p>WeChat swipe to share！</p>"></div>
    <script src="/Hexo-Blog/libs/share/js/social-share.min.js"></script>
    

    

</div>

                </div>
            </div>
            
        </div>
    </div>

    

    

    
        <div class="disqus-card card" data-aos="fade-up">
    <div id="disqus_thread" class="card-content">
        <noscript>Please enable JavaScript to view the
            <a target="_blank" rel="noopener" href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a>
        </noscript>
    </div>
</div>

<script type="text/javascript">
    disqus_config = function () {
        this.page.url = 'https://penguinwang96825.github.io/Hexo-Blog/2019/07/10/2019-07-10-sentiment-analysis-for-kkbox/';
        this.page.identifier = '/Hexo-Blog/2019/07/10/2019-07-10-sentiment-analysis-for-kkbox/';
        this.page.title = 'Sentiment Analysis for KKBOX';
    };
    let disqus_shortname = 'penguinwang';

    (function () { // DON'T EDIT BELOW THIS LINE
        let d = document, s = d.createElement('script');
        // 如：s.src = 'https://blinkfox.disqus.com/embed.js';
        s.src = '//' + disqus_shortname + '.disqus.com/embed.js';
        s.setAttribute('data-timestamp', new Date());
        (d.head || d.body).appendChild(s);
    })();
</script>

    

    

    

    

    

    

<article id="prenext-posts" class="prev-next articles">
    <div class="row article-row">
        
        <div class="article col s12 m6" data-aos="fade-up">
            <div class="article-badge left-badge text-color">
                <i class="fas fa-chevron-left"></i>&nbsp;Previous</div>
            <div class="card">
                <a href="/Hexo-Blog/2020/04/15/2020-04-15-qs-ranking-crawler/">
                    <div class="card-image">
                        
                        <img src="https://github.com/penguinwang96825/Hexo-Blog/blob/master/2020/04/15/2020-04-15-qs-ranking-crawler/wallhaven-oxzk8m.jpg?raw=true" class="responsive-img" alt="QS Ranking Crawler">
                        
                        <span class="card-title">QS Ranking Crawler</span>
                    </div>
                </a>
                <div class="card-content article-content">
                    <div class="summary block-with-text">
                        
                            This article aims to build a web scraper by using BeautifulSoup and Selenium, and scrape QS Rankings to discover the top universities from all over the world. "Uni name", "ranking" and "location" are fetched from the table and stored as a csv file. Jupyter notebook is available as well through my GitHub.
                        
                    </div>
                    <div class="publish-info">
                        <span class="publish-date">
                            <i class="far fa-clock fa-fw icon-date"></i>2020-04-15
                        </span>
                        <span class="publish-author">
                            
                            <i class="fas fa-bookmark fa-fw icon-category"></i>
                            
                            <a href="/Hexo-Blog/categories/Data-Science/" class="post-category">
                                    Data Science
                                </a>
                            
                            
                        </span>
                    </div>
                </div>
                
                <div class="card-action article-tags">
                    
                    <a href="/Hexo-Blog/tags/Python/">
                        <span class="chip bg-color">Python</span>
                    </a>
                    
                    <a href="/Hexo-Blog/tags/Crawler/">
                        <span class="chip bg-color">Crawler</span>
                    </a>
                    
                    <a href="/Hexo-Blog/tags/Visualisation/">
                        <span class="chip bg-color">Visualisation</span>
                    </a>
                    
                </div>
                
            </div>
        </div>
        
        
        <div class="article col s12 m6" data-aos="fade-up">
            <div class="article-badge right-badge text-color">
                Next&nbsp;<i class="fas fa-chevron-right"></i>
            </div>
            <div class="card">
                <a href="/Hexo-Blog/2019/06/11/2019-06-11-categorising-song-genre-by-analysing-lyrics/">
                    <div class="card-image">
                        
                        <img src="https://github.com/penguinwang96825/penguinwang96825.github.io/blob/master/2019/06/11/2019-06-11-categorising-song-genre-by-analysing-lyrics/hanny-naibaho.jpg?raw=true" class="responsive-img" alt="Categorising Song Genre by Analysing Lyrics">
                        
                        <span class="card-title">Categorising Song Genre by Analysing Lyrics</span>
                    </div>
                </a>
                <div class="card-content article-content">
                    <div class="summary block-with-text">
                        
                            The ability to classify music in an automated manner has become increasingly more important with the advent of musical streaming services allowing greater access to music. Spotify alone hit 100 million users in 2016, with other services provided by companies such as Apple, Soundcloud and YouTube. In addition, there are huge numbers of professional musicians, approximately 53,000 in the USA alone, as well as amateurs who are producing music which needs to be classified. With this quantity of music, it is unfeasible to classify genres without an automated method.
                        
                    </div>
                    <div class="publish-info">
                            <span class="publish-date">
                                <i class="far fa-clock fa-fw icon-date"></i>2019-06-11
                            </span>
                        <span class="publish-author">
                            
                            <i class="fas fa-bookmark fa-fw icon-category"></i>
                            
                            <a href="/Hexo-Blog/categories/Speech/" class="post-category">
                                    Speech
                                </a>
                            
                            
                        </span>
                    </div>
                </div>
                
                <div class="card-action article-tags">
                    
                    <a href="/Hexo-Blog/tags/Python/">
                        <span class="chip bg-color">Python</span>
                    </a>
                    
                    <a href="/Hexo-Blog/tags/NLP/">
                        <span class="chip bg-color">NLP</span>
                    </a>
                    
                    <a href="/Hexo-Blog/tags/Embedding/">
                        <span class="chip bg-color">Embedding</span>
                    </a>
                    
                </div>
                
            </div>
        </div>
        
    </div>
</article>

</div>


<script>
    $('#articleContent').on('copy', function (e) {
        // IE8 or earlier browser is 'undefined'
        if (typeof window.getSelection === 'undefined') return;

        var selection = window.getSelection();
        // if the selection is short let's not annoy our users.
        if (('' + selection).length < Number.parseInt('120')) {
            return;
        }

        // create a div outside of the visible area and fill it with the selected text.
        var bodyElement = document.getElementsByTagName('body')[0];
        var newdiv = document.createElement('div');
        newdiv.style.position = 'absolute';
        newdiv.style.left = '-99999px';
        bodyElement.appendChild(newdiv);
        newdiv.appendChild(selection.getRangeAt(0).cloneContents());

        // we need a <pre> tag workaround.
        // otherwise the text inside "pre" loses all the line breaks!
        if (selection.getRangeAt(0).commonAncestorContainer.nodeName === 'PRE') {
            newdiv.innerHTML = "<pre>" + newdiv.innerHTML + "</pre>";
        }

        var url = document.location.href;
        newdiv.innerHTML += '<br />'
            + 'From: Yang&#39;s Blog<br />'
            + 'Author: Yang Wang<br />'
            + 'Link: <a href="' + url + '">' + url + '</a><br />'
            + 'The copyright of this article belongs to the author, please indicate the source of any form of reproduction.';

        selection.selectAllChildren(newdiv);
        window.setTimeout(function () {bodyElement.removeChild(newdiv);}, 200);
    });
</script>


<!-- 代码块功能依赖 -->
<script type="text/javascript" src="/Hexo-Blog/libs/codeBlock/codeBlockFuction.js"></script>

<!-- 代码语言 -->

<script type="text/javascript" src="/Hexo-Blog/libs/codeBlock/codeLang.js"></script>


<!-- 代码块复制 -->


<!-- 代码块收缩 -->

<script type="text/javascript" src="/Hexo-Blog/libs/codeBlock/codeShrink.js"></script>


    </div>
    <div id="toc-aside" class="expanded col l3 hide-on-med-and-down">
        <div class="toc-widget card" style="background-color: white;">
            <div class="toc-title"><i class="far fa-list-alt"></i>&nbsp;&nbsp;TOC</div>
            <div id="toc-content"></div>
        </div>
    </div>
</div>

<!-- TOC 悬浮按钮. -->

<div id="floating-toc-btn" class="hide-on-med-and-down">
    <a class="btn-floating btn-large bg-color">
        <i class="fas fa-list-ul"></i>
    </a>
</div>


<script src="/Hexo-Blog/libs/tocbot/tocbot.min.js"></script>
<script>
    $(function () {
        tocbot.init({
            tocSelector: '#toc-content',
            contentSelector: '#articleContent',
            headingsOffset: -($(window).height() * 0.4 - 45),
            collapseDepth: Number('0'),
            headingSelector: 'h1, h2, h3, h4'
        });

        // modify the toc link href to support Chinese.
        let i = 0;
        let tocHeading = 'toc-heading-';
        $('#toc-content a').each(function () {
            $(this).attr('href', '#' + tocHeading + (++i));
        });

        // modify the heading title id to support Chinese.
        i = 0;
        $('#articleContent').children('h1, h2, h3, h4').each(function () {
            $(this).attr('id', tocHeading + (++i));
        });

        // Set scroll toc fixed.
        let tocHeight = parseInt($(window).height() * 0.4 - 64);
        let $tocWidget = $('.toc-widget');
        $(window).scroll(function () {
            let scroll = $(window).scrollTop();
            /* add post toc fixed. */
            if (scroll > tocHeight) {
                $tocWidget.addClass('toc-fixed');
            } else {
                $tocWidget.removeClass('toc-fixed');
            }
        });

        
        /* 修复文章卡片 div 的宽度. */
        let fixPostCardWidth = function (srcId, targetId) {
            let srcDiv = $('#' + srcId);
            if (srcDiv.length === 0) {
                return;
            }

            let w = srcDiv.width();
            if (w >= 450) {
                w = w + 21;
            } else if (w >= 350 && w < 450) {
                w = w + 18;
            } else if (w >= 300 && w < 350) {
                w = w + 16;
            } else {
                w = w + 14;
            }
            $('#' + targetId).width(w);
        };

        // 切换TOC目录展开收缩的相关操作.
        const expandedClass = 'expanded';
        let $tocAside = $('#toc-aside');
        let $mainContent = $('#main-content');
        $('#floating-toc-btn .btn-floating').click(function () {
            if ($tocAside.hasClass(expandedClass)) {
                $tocAside.removeClass(expandedClass).hide();
                $mainContent.removeClass('l9');
            } else {
                $tocAside.addClass(expandedClass).show();
                $mainContent.addClass('l9');
            }
            fixPostCardWidth('artDetail', 'prenext-posts');
        });
        
    });
</script>

    

</main>


<script type="text/javascript" src="http://cdn.mathjax.org/mathjax/latest/MathJax.js?config=default"></script>

    <footer class="page-footer bg-color">
    
        <link rel="stylesheet" href="/Hexo-Blog/libs/aplayer/APlayer.min.css">
<style>
    .aplayer .aplayer-lrc p {
        
        display: none;
        
        font-size: 12px;
        font-weight: 700;
        line-height: 16px !important;
    }

    .aplayer .aplayer-lrc p.aplayer-lrc-current {
        
        display: none;
        
        font-size: 15px;
        color: #42b983;
    }

    
    .aplayer.aplayer-fixed.aplayer-narrow .aplayer-body {
        left: -66px !important;
    }

    .aplayer.aplayer-fixed.aplayer-narrow .aplayer-body:hover {
        left: 0px !important;
    }

    
</style>
<div class="">
    
    <div class="row">
        <meting-js class="col l8 offset-l2 m10 offset-m1 s12"
                   server="netease"
                   type="playlist"
                   id="503838841"
                   fixed='true'
                   autoplay='false'
                   theme='#42b983'
                   loop='all'
                   order='random'
                   preload='auto'
                   volume='0.3'
                   list-folded='true'
        >
        </meting-js>
    </div>
</div>

<script src="/Hexo-Blog/libs/aplayer/APlayer.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/meting@2/dist/Meting.min.js"></script>

    
    <div class="container row center-align" style="margin-bottom: 15px !important;">
        <div class="col s12 m8 l8 copy-right">
            Copyright&nbsp;&copy;
            
                <span id="year">2018-2021</span>
            
            <span id="year">2018</span>
            <a href="/Hexo-Blog/about" target="_blank">Yang Wang</a>
            |&nbsp;Powered by&nbsp;<a href="https://hexo.io/" target="_blank">Hexo</a>
            |&nbsp;Theme&nbsp;<a href="https://github.com/blinkfox/hexo-theme-matery" target="_blank">Matery</a>
            <br>
            
            &nbsp;<i class="fas fa-chart-area"></i>&nbsp;Total site word count:&nbsp;<span
                class="white-color">48.6k</span>&nbsp;words
            
            
            
            
            
            
            <span id="busuanzi_container_site_pv">
                |&nbsp;<i class="far fa-eye"></i>&nbsp;Total number of visits:&nbsp;<span id="busuanzi_value_site_pv"
                    class="white-color"></span>&nbsp;times
            </span>
            
            
            <span id="busuanzi_container_site_uv">
                |&nbsp;<i class="fas fa-users"></i>&nbsp;Total number of visitors:&nbsp;<span id="busuanzi_value_site_uv"
                    class="white-color"></span>&nbsp;people
            </span>
            
            <br>
            
            <span id="sitetime">Loading runtime...</span>
            <script>
                function siteTime() {
                    var seconds = 1000;
                    var minutes = seconds * 60;
                    var hours = minutes * 60;
                    var days = hours * 24;
                    var years = days * 365;
                    var today = new Date();
                    var startYear = "2018";
                    var startMonth = "12";
                    var startDate = "3";
                    var startHour = "0";
                    var startMinute = "0";
                    var startSecond = "0";
                    var todayYear = today.getFullYear();
                    var todayMonth = today.getMonth() + 1;
                    var todayDate = today.getDate();
                    var todayHour = today.getHours();
                    var todayMinute = today.getMinutes();
                    var todaySecond = today.getSeconds();
                    var t1 = Date.UTC(startYear, startMonth, startDate, startHour, startMinute, startSecond);
                    var t2 = Date.UTC(todayYear, todayMonth, todayDate, todayHour, todayMinute, todaySecond);
                    var diff = t2 - t1;
                    var diffYears = Math.floor(diff / years);
                    var diffDays = Math.floor((diff / days) - diffYears * 365);
                    var diffHours = Math.floor((diff - (diffYears * 365 + diffDays) * days) / hours);
                    var diffMinutes = Math.floor((diff - (diffYears * 365 + diffDays) * days - diffHours * hours) /
                        minutes);
                    var diffSeconds = Math.floor((diff - (diffYears * 365 + diffDays) * days - diffHours * hours -
                        diffMinutes * minutes) / seconds);
                    if (startYear == todayYear) {
                        document.getElementById("year").innerHTML = todayYear;
                        document.getElementById("sitetime").innerHTML = "This site has been safely operated " + diffDays + " days " + diffHours +
                            " hours " + diffMinutes + " minutes " + diffSeconds + " seconds";
                    } else {
                        document.getElementById("year").innerHTML = startYear + " - " + todayYear;
                        document.getElementById("sitetime").innerHTML = "This site has been safely operated " + diffYears + " years " + diffDays +
                            " days " + diffHours + " hours " + diffMinutes + " minutes " + diffSeconds + " seconds";
                    }
                }
                setInterval(siteTime, 1000);
            </script>
            
            <br>
            
        </div>
        <div class="col s12 m4 l4 social-link social-statis">
    <a href="https://github.com/penguinwang96825" class="tooltipped" target="_blank" data-tooltip="Visit my GitHub" data-position="top" data-delay="50">
        <i class="fab fa-github"></i>
    </a>



    <a href="mailto:penguinwang@smail.nchu.edu.tw" class="tooltipped" target="_blank" data-tooltip="Contact me by mail" data-position="top" data-delay="50">
        <i class="fas fa-envelope-open"></i>
    </a>













</div>
    </div>
</footer>

<div class="progress-bar"></div>

    <!-- 搜索遮罩框 -->
<div id="searchModal" class="modal">
    <div class="modal-content">
        <div class="search-header">
            <span class="title"><i class="fas fa-search"></i>&nbsp;&nbsp;Search</span>
            <input type="search" id="searchInput" name="s" placeholder="Please enter a search keyword"
                   class="search-input">
        </div>
        <div id="searchResult"></div>
    </div>
</div>

<script type="text/javascript">
$(function () {
    var searchFunc = function (path, search_id, content_id) {
        'use strict';
        $.ajax({
            url: path,
            dataType: "xml",
            success: function (xmlResponse) {
                // get the contents from search data
                var datas = $("entry", xmlResponse).map(function () {
                    return {
                        title: $("title", this).text(),
                        content: $("content", this).text(),
                        url: $("url", this).text()
                    };
                }).get();
                var $input = document.getElementById(search_id);
                var $resultContent = document.getElementById(content_id);
                $input.addEventListener('input', function () {
                    var str = '<ul class=\"search-result-list\">';
                    var keywords = this.value.trim().toLowerCase().split(/[\s\-]+/);
                    $resultContent.innerHTML = "";
                    if (this.value.trim().length <= 0) {
                        return;
                    }
                    // perform local searching
                    datas.forEach(function (data) {
                        var isMatch = true;
                        var data_title = data.title.trim().toLowerCase();
                        var data_content = data.content.trim().replace(/<[^>]+>/g, "").toLowerCase();
                        var data_url = data.url;
                        data_url = data_url.indexOf('/') === 0 ? data.url : '/' + data_url;
                        var index_title = -1;
                        var index_content = -1;
                        var first_occur = -1;
                        // only match artiles with not empty titles and contents
                        if (data_title !== '' && data_content !== '') {
                            keywords.forEach(function (keyword, i) {
                                index_title = data_title.indexOf(keyword);
                                index_content = data_content.indexOf(keyword);
                                if (index_title < 0 && index_content < 0) {
                                    isMatch = false;
                                } else {
                                    if (index_content < 0) {
                                        index_content = 0;
                                    }
                                    if (i === 0) {
                                        first_occur = index_content;
                                    }
                                }
                            });
                        }
                        // show search results
                        if (isMatch) {
                            str += "<li><a href='" + data_url + "' class='search-result-title'>" + data_title + "</a>";
                            var content = data.content.trim().replace(/<[^>]+>/g, "");
                            if (first_occur >= 0) {
                                // cut out 100 characters
                                var start = first_occur - 20;
                                var end = first_occur + 80;
                                if (start < 0) {
                                    start = 0;
                                }
                                if (start === 0) {
                                    end = 100;
                                }
                                if (end > content.length) {
                                    end = content.length;
                                }
                                var match_content = content.substr(start, end);
                                // highlight all keywords
                                keywords.forEach(function (keyword) {
                                    var regS = new RegExp(keyword, "gi");
                                    match_content = match_content.replace(regS, "<em class=\"search-keyword\">" + keyword + "</em>");
                                });

                                str += "<p class=\"search-result\">" + match_content + "...</p>"
                            }
                            str += "</li>";
                        }
                    });
                    str += "</ul>";
                    $resultContent.innerHTML = str;
                });
            }
        });
    };

    searchFunc('/Hexo-Blog/search.xml', 'searchInput', 'searchResult');
});
</script>

    <!-- 回到顶部按钮 -->
<div id="backTop" class="top-scroll">
    <a class="btn-floating btn-large waves-effect waves-light" href="#!">
        <i class="fas fa-arrow-up"></i>
    </a>
</div>


    <script src="/Hexo-Blog/libs/materialize/materialize.min.js"></script>
    <script src="/Hexo-Blog/libs/masonry/masonry.pkgd.min.js"></script>
    <script src="/Hexo-Blog/libs/aos/aos.js"></script>
    <script src="/Hexo-Blog/libs/scrollprogress/scrollProgress.min.js"></script>
    <script src="/Hexo-Blog/libs/lightGallery/js/lightgallery-all.min.js"></script>
    <script src="/Hexo-Blog/js/matery.js"></script>

    <!-- Baidu Analytics -->

    <!-- Baidu Push -->

<script>
    (function () {
        var bp = document.createElement('script');
        var curProtocol = window.location.protocol.split(':')[0];
        if (curProtocol === 'https') {
            bp.src = 'https://zz.bdstatic.com/linksubmit/push.js';
        } else {
            bp.src = 'http://push.zhanzhang.baidu.com/push.js';
        }
        var s = document.getElementsByTagName("script")[0];
        s.parentNode.insertBefore(bp, s);
    })();
</script>

    
    <script src="/Hexo-Blog/libs/others/clicklove.js" async="async"></script>
    
    
    <script async src="/Hexo-Blog/libs/others/busuanzi.pure.mini.js"></script>
    

    

    

	
    

    

    

    
    <script src="/Hexo-Blog/libs/instantpage/instantpage.js" type="module"></script>
    

</body>

</html>
