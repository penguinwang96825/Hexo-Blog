<!DOCTYPE HTML>
<html lang="en">


<head>
    <meta charset="utf-8">
    <meta name="keywords" content="Audio-based Song Genre Classification, Yang&#39;s Blog">
    <meta name="description" content="CS Student / NLP Enthusiast / Tireless Coder">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <meta name="renderer" content="webkit|ie-stand|ie-comp">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="format-detection" content="telephone=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <!-- Global site tag (gtag.js) - Google Analytics -->


    <title>Audio-based Song Genre Classification | Yang&#39;s Blog</title>
    <link rel="icon" type="image/png" href="/favicon.png">

    <link rel="stylesheet" type="text/css" href="/libs/awesome/css/all.css">
    <link rel="stylesheet" type="text/css" href="/libs/materialize/materialize.min.css">
    <link rel="stylesheet" type="text/css" href="/libs/aos/aos.css">
    <link rel="stylesheet" type="text/css" href="/libs/animate/animate.min.css">
    <link rel="stylesheet" type="text/css" href="/libs/lightGallery/css/lightgallery.min.css">
    <link rel="stylesheet" type="text/css" href="/css/matery.css">
    <link rel="stylesheet" type="text/css" href="/css/my.css">

    <script src="/libs/jquery/jquery.min.js"></script>

<!-- hexo injector head_end start -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.12.0/dist/katex.min.css">

<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/hexo-math@4.0.0/dist/style.css">
<!-- hexo injector head_end end --><meta name="generator" content="Hexo 5.4.0"></head>




<body>
    <header class="navbar-fixed">
    <nav id="headNav" class="bg-color nav-transparent">
        <div id="navContainer" class="nav-wrapper container">
            <div class="brand-logo">
                <a href="/" class="waves-effect waves-light">
                    
                    <img src="/medias/logo.png" class="logo-img" alt="LOGO">
                    
                    <span class="logo-span">Yang&#39;s Blog</span>
                </a>
            </div>
            

<a href="#" data-target="mobile-nav" class="sidenav-trigger button-collapse"><i class="fas fa-bars"></i></a>
<ul class="right nav-menu">
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/" class="waves-effect waves-light">
      
      <i class="fas fa-home" style="zoom: 0.6;"></i>
      
      <span>Index</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/tags" class="waves-effect waves-light">
      
      <i class="fas fa-tags" style="zoom: 0.6;"></i>
      
      <span>Tags</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/categories" class="waves-effect waves-light">
      
      <i class="fas fa-bookmark" style="zoom: 0.6;"></i>
      
      <span>Categories</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/archives" class="waves-effect waves-light">
      
      <i class="fas fa-archive" style="zoom: 0.6;"></i>
      
      <span>Archives</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/about" class="waves-effect waves-light">
      
      <i class="fas fa-user-circle" style="zoom: 0.6;"></i>
      
      <span>About</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/contact" class="waves-effect waves-light">
      
      <i class="fas fa-comments" style="zoom: 0.6;"></i>
      
      <span>Contact</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/friends" class="waves-effect waves-light">
      
      <i class="fas fa-address-book" style="zoom: 0.6;"></i>
      
      <span>Friends</span>
    </a>
    
  </li>
  
  <li>
    <a href="#searchModal" class="modal-trigger waves-effect waves-light">
      <i id="searchIcon" class="fas fa-search" title="Search" style="zoom: 0.85;"></i>
    </a>
  </li>
</ul>


<div id="mobile-nav" class="side-nav sidenav">

    <div class="mobile-head bg-color">
        
        <img src="/medias/logo.png" class="logo-img circle responsive-img">
        
        <div class="logo-name">Yang&#39;s Blog</div>
        <div class="logo-desc">
            
            CS Student / NLP Enthusiast / Tireless Coder
            
        </div>
    </div>

    

    <ul class="menu-list mobile-menu-list">
        
        <li class="m-nav-item">
	  
		<a href="/" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-home"></i>
			
			Index
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/tags" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-tags"></i>
			
			Tags
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/categories" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-bookmark"></i>
			
			Categories
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/archives" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-archive"></i>
			
			Archives
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/about" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-user-circle"></i>
			
			About
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/contact" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-comments"></i>
			
			Contact
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/friends" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-address-book"></i>
			
			Friends
		</a>
          
        </li>
        
        
        <li><div class="divider"></div></li>
        <li>
            <a href="https://github.com/penguinwang96825" class="waves-effect waves-light" target="_blank">
                <i class="fab fa-github-square fa-fw"></i>Fork Me
            </a>
        </li>
        
    </ul>
</div>


        </div>

        
            <style>
    .nav-transparent .github-corner {
        display: none !important;
    }

    .github-corner {
        position: absolute;
        z-index: 10;
        top: 0;
        right: 0;
        border: 0;
        transform: scale(1.1);
    }

    .github-corner svg {
        color: #0f9d58;
        fill: #fff;
        height: 64px;
        width: 64px;
    }

    .github-corner:hover .octo-arm {
        animation: a 0.56s ease-in-out;
    }

    .github-corner .octo-arm {
        animation: none;
    }

    @keyframes a {
        0%,
        to {
            transform: rotate(0);
        }
        20%,
        60% {
            transform: rotate(-25deg);
        }
        40%,
        80% {
            transform: rotate(10deg);
        }
    }
</style>

<a href="https://github.com/penguinwang96825" class="github-corner tooltipped hide-on-med-and-down" target="_blank"
   data-tooltip="Fork Me" data-position="left" data-delay="50">
    <svg viewBox="0 0 250 250" aria-hidden="true">
        <path d="M0,0 L115,115 L130,115 L142,142 L250,250 L250,0 Z"></path>
        <path d="M128.3,109.0 C113.8,99.7 119.0,89.6 119.0,89.6 C122.0,82.7 120.5,78.6 120.5,78.6 C119.2,72.0 123.4,76.3 123.4,76.3 C127.3,80.9 125.5,87.3 125.5,87.3 C122.9,97.6 130.6,101.9 134.4,103.2"
              fill="currentColor" style="transform-origin: 130px 106px;" class="octo-arm"></path>
        <path d="M115.0,115.0 C114.9,115.1 118.7,116.5 119.8,115.4 L133.7,101.6 C136.9,99.2 139.9,98.4 142.2,98.6 C133.8,88.0 127.5,74.4 143.8,58.0 C148.5,53.4 154.0,51.2 159.7,51.0 C160.3,49.4 163.2,43.6 171.4,40.1 C171.4,40.1 176.1,42.5 178.8,56.2 C183.1,58.6 187.2,61.8 190.9,65.4 C194.5,69.0 197.7,73.2 200.1,77.6 C213.8,80.2 216.3,84.9 216.3,84.9 C212.7,93.1 206.9,96.0 205.4,96.6 C205.1,102.4 203.0,107.8 198.3,112.5 C181.9,128.9 168.3,122.5 157.7,114.1 C157.9,116.9 156.7,120.9 152.7,124.9 L141.0,136.5 C139.8,137.7 141.6,141.9 141.8,141.8 Z"
              fill="currentColor" class="octo-body"></path>
    </svg>
</a>
        
    </nav>

</header>

    



<div class="bg-cover pd-header post-cover" style="background-image: url('https://github.com/penguinwang96825/penguinwang96825.github.io/blob/master/2021/02/05/2021-02-05-audio-based-song-genre-classification/yomex-owo.jpg?raw=true')">
    <div class="container" style="right: 0px;left: 0px;">
        <div class="row">
            <div class="col s12 m12 l12">
                <div class="brand">
                    <h1 class="description center-align post-title">Audio-based Song Genre Classification</h1>
                </div>
            </div>
        </div>
    </div>
</div>




<main class="post-container content">

    
    <link rel="stylesheet" href="/libs/tocbot/tocbot.css">
<style>
    #articleContent h1::before,
    #articleContent h2::before,
    #articleContent h3::before,
    #articleContent h4::before,
    #articleContent h5::before,
    #articleContent h6::before {
        display: block;
        content: " ";
        height: 100px;
        margin-top: -100px;
        visibility: hidden;
    }

    #articleContent :focus {
        outline: none;
    }

    .toc-fixed {
        position: fixed;
        top: 64px;
    }

    .toc-widget {
        width: 345px;
        padding-left: 20px;
    }

    .toc-widget .toc-title {
        padding: 35px 0 15px 17px;
        font-size: 1.5rem;
        font-weight: bold;
        line-height: 1.5rem;
    }

    .toc-widget ol {
        padding: 0;
        list-style: none;
    }

    #toc-content {
        padding-bottom: 30px;
        overflow: auto;
    }

    #toc-content ol {
        padding-left: 10px;
    }

    #toc-content ol li {
        padding-left: 10px;
    }

    #toc-content .toc-link:hover {
        color: #42b983;
        font-weight: 700;
        text-decoration: underline;
    }

    #toc-content .toc-link::before {
        background-color: transparent;
        max-height: 25px;

        position: absolute;
        right: 23.5vw;
        display: block;
    }

    #toc-content .is-active-link {
        color: #42b983;
    }

    #floating-toc-btn {
        position: fixed;
        right: 15px;
        bottom: 76px;
        padding-top: 15px;
        margin-bottom: 0;
        z-index: 998;
    }

    #floating-toc-btn .btn-floating {
        width: 48px;
        height: 48px;
    }

    #floating-toc-btn .btn-floating i {
        line-height: 48px;
        font-size: 1.4rem;
    }
</style>
<div class="row">
    <div id="main-content" class="col s12 m12 l9">
        <!-- 文章内容详情 -->
<div id="artDetail">
    <div class="card">
        <div class="card-content article-info">
            <div class="row tag-cate">
                <div class="col s7">
                    
                    <div class="article-tag">
                        
                            <a href="/tags/Python/">
                                <span class="chip bg-color">Python</span>
                            </a>
                        
                            <a href="/tags/Librosa/">
                                <span class="chip bg-color">Librosa</span>
                            </a>
                        
                    </div>
                    
                </div>
                <div class="col s5 right-align">
                    
                    <div class="post-cate">
                        <i class="fas fa-bookmark fa-fw icon-category"></i>
                        
                            <a href="/categories/Speech-NLP/" class="post-category">
                                Speech NLP
                            </a>
                        
                    </div>
                    
                </div>
            </div>

            <div class="post-info">
                
                <div class="post-date info-break-policy">
                    <i class="far fa-calendar-minus fa-fw"></i>Publish Date:&nbsp;&nbsp;
                    2021-02-05
                </div>
                

                

                
                <div class="info-break-policy">
                    <i class="far fa-file-word fa-fw"></i>Word Count:&nbsp;&nbsp;
                    3.6k
                </div>
                

                
                <div class="info-break-policy">
                    <i class="far fa-clock fa-fw"></i>Read Times:&nbsp;&nbsp;
                    22 Min
                </div>
                

                
                    <div id="busuanzi_container_page_pv" class="info-break-policy">
                        <i class="far fa-eye fa-fw"></i>Read Count:&nbsp;&nbsp;
                        <span id="busuanzi_value_page_pv"></span>
                    </div>
				
            </div>
        </div>
        <hr class="clearfix">

        
        <!-- 是否加载使用自带的 prismjs. -->
        <link rel="stylesheet" href="/libs/prism/prism.css">
        

        

        <div class="card-content article-card-content">
            <div id="articleContent">
                <p>Visualizing sound is kind of a trippy concept. There are some mesmerizing ways to do that, and also more mathematical ones, which I will explore both in this article.</p>
<h1 id="Introduction"><a href="#Introduction" class="headerlink" title="Introduction"></a>Introduction</h1><p>I wrote an <a href="/2019/06/11/2019-06-11-categorising-song-genre-by-analysing-lyrics/" title="[article]">[article]</a> about lyrics-based song genre classifier before. I was wondering whether using the audio-based data will improve the performance. For this reason, this work takes a closer look at expoiting audio-based approach to build a multi-class classifier.</p>
<h1 id="Audio-Processing"><a href="#Audio-Processing" class="headerlink" title="Audio Processing"></a>Audio Processing</h1><p>Let’s take one song for instance, </p>
<div style="display: flex;justify-content: center;">
    <div class="ready-player-1">
        <audio crossorigin>
            <source src="<img src="/2021/02/05/2021-02-05-audio-based-song-genre-classification/Beyonce-Halo.mp3" class="">" type="audio/mpeg">
        </audio>
    </div>
</div>

<link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/gh/greghub/green-audio-player/dist/css/green-audio-player.min.css">
<script src="https://cdn.jsdelivr.net/gh/greghub/green-audio-player/dist/js/green-audio-player.min.js"></script>
<script>
    document.addEventListener('DOMContentLoaded', function() {
        new GreenAudioPlayer('.ready-player-1', { showTooltips: true, showDownloadButton: false, enableKeystrokes: true });
    });
</script>

<hr>
<h2 id="Librosa"><a href="#Librosa" class="headerlink" title="Librosa"></a>Librosa</h2><p><code>librosa</code> is a python package for music and audio analysis. It provides the building blocks necessary to create music information retrieval systems. Let’s load the audio file we want to process first.</p>
<pre class="line-numbers language-python" data-language="python"><code class="language-python">signal<span class="token punctuation">,</span> sr <span class="token operator">=</span> librosa<span class="token punctuation">.</span>load<span class="token punctuation">(</span><span class="token string">"Halo.mp3"</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>Great, a wonderful song, isn’t it? Then how does the sound look like in a graph? </p>
<h2 id="Waveform"><a href="#Waveform" class="headerlink" title="Waveform"></a>Waveform</h2><p>We can now take a look at its waveform. The waveform of a signal is the shape of its graph as a function of time, independent of its time and magnitude scales and of any displacement in time. <a target="_blank" rel="noopener" href="https://pudding.cool/2018/02/waveforms/">Here</a> is a interesting animation of waveform written by Josh Comeau.</p>
<pre class="line-numbers language-python" data-language="python"><code class="language-python">plt<span class="token punctuation">.</span>rcParams<span class="token punctuation">[</span><span class="token string">"figure.figsize"</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">15</span><span class="token punctuation">,</span> <span class="token number">6</span>
librosa<span class="token punctuation">.</span>display<span class="token punctuation">.</span>waveplot<span class="token punctuation">(</span>signal<span class="token punctuation">,</span> sr<span class="token operator">=</span>sr<span class="token punctuation">,</span> alpha<span class="token operator">=</span><span class="token number">0.5</span><span class="token punctuation">)</span>
plt<span class="token punctuation">.</span>xlabel<span class="token punctuation">(</span><span class="token string">"Time"</span><span class="token punctuation">)</span>
plt<span class="token punctuation">.</span>ylabel<span class="token punctuation">(</span><span class="token string">"Amplitude"</span><span class="token punctuation">)</span>
plt<span class="token punctuation">.</span>show<span class="token punctuation">(</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<img src="/2021/02/05/2021-02-05-audio-based-song-genre-classification/waveform.png" class="">

<h3 id="Sampling-Rate"><a href="#Sampling-Rate" class="headerlink" title="Sampling Rate"></a>Sampling Rate</h3><p>When we use <code>librosa.load()</code> we can set a parameter called “sr”, which stands for “sampling rate”, but what exactly does this mean? In audio production, a sampling rate defines how many times per second a sound is sampled, that is, the number of amplitude that can be recorded per second. For example, the sampling rate is 1khz, which means that the amplitude of 1000 waves can be recorded in one second.</p>
<img src="/2021/02/05/2021-02-05-audio-based-song-genre-classification/sr.png" class="">

<p>The default sampling rate used by Librosa is 22050, but you can pass in almost any sampling rate you like. Further, the higher sample rate technically leads to more measurements per second and a closer recreation of the original audio, so 48 kHz is often used in “professional audio” contexts more than music contexts.</p>
<p>We can also indicate that sampling rate (Hz) is the inverse of the period <mjx-container class="MathJax" jax="SVG"><svg style="vertical-align: 0" xmlns="http://www.w3.org/2000/svg" width="1.593ex" height="1.532ex" role="img" focusable="false" viewBox="0 -677 704 677" xmlns:xlink="http://www.w3.org/1999/xlink"><defs><path id="MJX-7-TEX-I-1D447" d="M40 437Q21 437 21 445Q21 450 37 501T71 602L88 651Q93 669 101 677H569H659Q691 677 697 676T704 667Q704 661 687 553T668 444Q668 437 649 437Q640 437 637 437T631 442L629 445Q629 451 635 490T641 551Q641 586 628 604T573 629Q568 630 515 631Q469 631 457 630T439 622Q438 621 368 343T298 60Q298 48 386 46Q418 46 427 45T436 36Q436 31 433 22Q429 4 424 1L422 0Q419 0 415 0Q410 0 363 1T228 2Q99 2 64 0H49Q43 6 43 9T45 27Q49 40 55 46H83H94Q174 46 189 55Q190 56 191 56Q196 59 201 76T241 233Q258 301 269 344Q339 619 339 625Q339 630 310 630H279Q212 630 191 624Q146 614 121 583T67 467Q60 445 57 441T43 437H40Z"></path></defs><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)"><g data-mml-node="math"><g data-mml-node="mi"><use xlink:href="#MJX-7-TEX-I-1D447"></use></g></g></g></svg></mjx-container>. Look at the figure below in detail, the higher the sample rate, the less the sampling error.</p>
<p>$$<br>s_r = \frac{1}{T}<br>$$</p>
<img src="/2021/02/05/2021-02-05-audio-based-song-genre-classification/sampling-rate.png" class="">

<p>How many samples are necessary to ensure we are preserving the information contained in the signal? If the signal contains high frequency components, we will need to sample at a higher rate to avoid losing information that is in the signal. In general, to preserve the full information in the signal, it is necessary to sample at twice the maximum frequency of the signal. This is known as the Nyquist rate. The Sampling Theorem states that a signal can be exactly reproduced if it is sampled at a frequency F, where F is greater than twice the maximum frequency in the signal.</p>
<p>What happens if we sample the signal at a frequency that is lower that the Nyquist rate? When the signal is converted back into a continuous time signal, it will exhibit a phenomenon called ‘aliasing’. Aliasing is the presence of unwanted components in the reconstructed signal. These components were not present when the original signal was sampled. In addition, some of the frequencies in the original signal may be lost in the reconstructed signal. Aliasing occurs because signal frequencies can overlap if the sampling frequency is too low.</p>
<h3 id="Frames"><a href="#Frames" class="headerlink" title="Frames"></a>Frames</h3><ul>
<li>Perceivable audio to chunk.</li>
<li>Power of 2 # of samples.</li>
<li>Typical values: 256 ~ 8192.</li>
</ul>
<p>Formula for duration of a frame: </p>
<p>$$d_f = \frac{1}{s_r} \cdot K$$</p>
<p>where <mjx-container class="MathJax" jax="SVG"><svg style="vertical-align: -0.667ex" xmlns="http://www.w3.org/2000/svg" width="2.169ex" height="2.237ex" role="img" focusable="false" viewBox="0 -694 958.9 989" xmlns:xlink="http://www.w3.org/1999/xlink"><defs><path id="MJX-7-TEX-I-1D451" d="M366 683Q367 683 438 688T511 694Q523 694 523 686Q523 679 450 384T375 83T374 68Q374 26 402 26Q411 27 422 35Q443 55 463 131Q469 151 473 152Q475 153 483 153H487H491Q506 153 506 145Q506 140 503 129Q490 79 473 48T445 8T417 -8Q409 -10 393 -10Q359 -10 336 5T306 36L300 51Q299 52 296 50Q294 48 292 46Q233 -10 172 -10Q117 -10 75 30T33 157Q33 205 53 255T101 341Q148 398 195 420T280 442Q336 442 364 400Q369 394 369 396Q370 400 396 505T424 616Q424 629 417 632T378 637H357Q351 643 351 645T353 664Q358 683 366 683ZM352 326Q329 405 277 405Q242 405 210 374T160 293Q131 214 119 129Q119 126 119 118T118 106Q118 61 136 44T179 26Q233 26 290 98L298 109L352 326Z"></path><path id="MJX-7-TEX-I-1D453" d="M118 -162Q120 -162 124 -164T135 -167T147 -168Q160 -168 171 -155T187 -126Q197 -99 221 27T267 267T289 382V385H242Q195 385 192 387Q188 390 188 397L195 425Q197 430 203 430T250 431Q298 431 298 432Q298 434 307 482T319 540Q356 705 465 705Q502 703 526 683T550 630Q550 594 529 578T487 561Q443 561 443 603Q443 622 454 636T478 657L487 662Q471 668 457 668Q445 668 434 658T419 630Q412 601 403 552T387 469T380 433Q380 431 435 431Q480 431 487 430T498 424Q499 420 496 407T491 391Q489 386 482 386T428 385H372L349 263Q301 15 282 -47Q255 -132 212 -173Q175 -205 139 -205Q107 -205 81 -186T55 -132Q55 -95 76 -78T118 -61Q162 -61 162 -103Q162 -122 151 -136T127 -157L118 -162Z"></path></defs><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)"><g data-mml-node="math"><g data-mml-node="msub"><g data-mml-node="mi"><use xlink:href="#MJX-7-TEX-I-1D451"></use></g><g data-mml-node="mi" transform="translate(520, -150) scale(0.707)"><use xlink:href="#MJX-7-TEX-I-1D453"></use></g></g></g></g></svg></mjx-container> is duration of a frame, <mjx-container class="MathJax" jax="SVG"><svg style="vertical-align: -0.357ex" xmlns="http://www.w3.org/2000/svg" width="1.896ex" height="1.357ex" role="img" focusable="false" viewBox="0 -442 837.9 599.8" xmlns:xlink="http://www.w3.org/1999/xlink"><defs><path id="MJX-7-TEX-I-1D460" d="M131 289Q131 321 147 354T203 415T300 442Q362 442 390 415T419 355Q419 323 402 308T364 292Q351 292 340 300T328 326Q328 342 337 354T354 372T367 378Q368 378 368 379Q368 382 361 388T336 399T297 405Q249 405 227 379T204 326Q204 301 223 291T278 274T330 259Q396 230 396 163Q396 135 385 107T352 51T289 7T195 -10Q118 -10 86 19T53 87Q53 126 74 143T118 160Q133 160 146 151T160 120Q160 94 142 76T111 58Q109 57 108 57T107 55Q108 52 115 47T146 34T201 27Q237 27 263 38T301 66T318 97T323 122Q323 150 302 164T254 181T195 196T148 231Q131 256 131 289Z"></path><path id="MJX-7-TEX-I-1D45F" d="M21 287Q22 290 23 295T28 317T38 348T53 381T73 411T99 433T132 442Q161 442 183 430T214 408T225 388Q227 382 228 382T236 389Q284 441 347 441H350Q398 441 422 400Q430 381 430 363Q430 333 417 315T391 292T366 288Q346 288 334 299T322 328Q322 376 378 392Q356 405 342 405Q286 405 239 331Q229 315 224 298T190 165Q156 25 151 16Q138 -11 108 -11Q95 -11 87 -5T76 7T74 17Q74 30 114 189T154 366Q154 405 128 405Q107 405 92 377T68 316T57 280Q55 278 41 278H27Q21 284 21 287Z"></path></defs><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)"><g data-mml-node="math"><g data-mml-node="msub"><g data-mml-node="mi"><use xlink:href="#MJX-7-TEX-I-1D460"></use></g><g data-mml-node="mi" transform="translate(469, -150) scale(0.707)"><use xlink:href="#MJX-7-TEX-I-1D45F"></use></g></g></g></g></svg></mjx-container> is sample rate, and <mjx-container class="MathJax" jax="SVG"><svg style="vertical-align: 0" xmlns="http://www.w3.org/2000/svg" width="2.011ex" height="1.545ex" role="img" focusable="false" viewBox="0 -683 889 683" xmlns:xlink="http://www.w3.org/1999/xlink"><defs><path id="MJX-7-TEX-I-1D43E" d="M285 628Q285 635 228 637Q205 637 198 638T191 647Q191 649 193 661Q199 681 203 682Q205 683 214 683H219Q260 681 355 681Q389 681 418 681T463 682T483 682Q500 682 500 674Q500 669 497 660Q496 658 496 654T495 648T493 644T490 641T486 639T479 638T470 637T456 637Q416 636 405 634T387 623L306 305Q307 305 490 449T678 597Q692 611 692 620Q692 635 667 637Q651 637 651 648Q651 650 654 662T659 677Q662 682 676 682Q680 682 711 681T791 680Q814 680 839 681T869 682Q889 682 889 672Q889 650 881 642Q878 637 862 637Q787 632 726 586Q710 576 656 534T556 455L509 418L518 396Q527 374 546 329T581 244Q656 67 661 61Q663 59 666 57Q680 47 717 46H738Q744 38 744 37T741 19Q737 6 731 0H720Q680 3 625 3Q503 3 488 0H478Q472 6 472 9T474 27Q478 40 480 43T491 46H494Q544 46 544 71Q544 75 517 141T485 216L427 354L359 301L291 248L268 155Q245 63 245 58Q245 51 253 49T303 46H334Q340 37 340 35Q340 19 333 5Q328 0 317 0Q314 0 280 1T180 2Q118 2 85 2T49 1Q31 1 31 11Q31 13 34 25Q38 41 42 43T65 46Q92 46 125 49Q139 52 144 61Q147 65 216 339T285 628Z"></path></defs><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)"><g data-mml-node="math"><g data-mml-node="mi"><use xlink:href="#MJX-7-TEX-I-1D43E"></use></g></g></g></svg></mjx-container> is the frame size. </p>
<h2 id="Spectral-Leakage"><a href="#Spectral-Leakage" class="headerlink" title="Spectral Leakage"></a>Spectral Leakage</h2><ul>
<li>Processed signal isn’t an integer number of periods.</li>
<li>Endpoints are discontinuous.</li>
<li>Discontinuous appear as high-frequency components not present in the original signal.</li>
</ul>
<h2 id="Windowing"><a href="#Windowing" class="headerlink" title="Windowing"></a>Windowing</h2><ul>
<li>Apply windowing function to each frame.</li>
<li>Eliminates samples t both ends of a frame.</li>
<li>Generates a periodic signal.</li>
</ul>
<h2 id="Hann-Window"><a href="#Hann-Window" class="headerlink" title="Hann Window"></a>Hann Window</h2><p>This function is a member of both the cosine-sum and power-of-sine families. The end points of the Hann window just touch zero.</p>
<p>$$ w(k) = 0.5 \cdot (1-cos(\frac{2 \pi k}{K-1})), k = 1, \cdots, K $$</p>
<p>At both endpoints will touch zero, which is a problem losing a signal. The solution to this is to overlap the frames.</p>
<h3 id="Bit-Depth-amp-Bit-Rate"><a href="#Bit-Depth-amp-Bit-Rate" class="headerlink" title="Bit Depth &amp; Bit Rate"></a>Bit Depth &amp; Bit Rate</h3><p>Analog audio is a continuous wave, with an effectively infinite number of possible amplitude values. However, to measure this wave in digital audio, we need to define the wave’s amplitude as a finite value each time we sample it. </p>
<p>To illustrate bit depth, suppose you want to draw a picture of a sunset, but you only have 16 crayons. In real-life, sunsets come in a variety of colors, from dazzling yellows and oranges to faint reds and purples. If there were only 16 crayons, then it would be impossible to really draw all these different colors. What If you have 32 crayons, you can then use twice as many colors, although the picture still doesn’t look realistic. Thereupon, if you continue to add more crayons, you can definitely draw better.</p>
<p>The bit depth determines the number of possible amplitude values we can record for each sample. The most common bit depths are 16-bit, 24-bit, and 32-bit. Each is a binary term, representing a number of possible values. Systems of higher bit depths are able to express more possible values.</p>
<p>The bit rate of a file tells us how many bits of data are processed every second. Bit rates are usually measured in kilobits per second (kbps). To calculate the bit rate, we can use the following formula:</p>
<p>$$<br>Bit Rate = Frequency \times Bit Depth \times Channels<br>$$</p>
<p>A typical, uncompressed high-quality audio file has a sample rate of 44,100 samples per second, a bit depth of 16 bits per sample and 2 channels of stereo audio. The bit rate for this file would be: <strong>44100 samples per second × 16 bits per sample × 2 channels = 1411200 bits per second (or 1411.2 kbps)</strong>. </p>
<p>To sum up, we can know that the higher the bit rate, the faster the data transfer speed. With a firmer understanding of sample rate and bit depth, let’s dive in next topic - spectrum.</p>
<h2 id="Spectrum"><a href="#Spectrum" class="headerlink" title="Spectrum"></a>Spectrum</h2><p>Before we talk about the spectrum, we need to understand the sound waves first.</p>
<img src="/2021/02/05/2021-02-05-audio-based-song-genre-classification/sine.png" class="">

<ul>
<li><strong>Amplitude</strong>: the greater the amplitude, the louder the volume of the sound, and vice versa the lower the volume.</li>
<li><strong>Cycle</strong>: from position 0, to the peak, then to the trough, and finally back to 0, this is called a cycle.</li>
<li><strong>Frequency</strong>: frequency refers to how many cycles per second, the higher the frequency, the higher the pitch.</li>
<li><strong>Phase</strong>: indicates the position of the waveform in the cycle, measured in degrees.</li>
<li><strong>Wavelength</strong>: denotes the distance between two points with the same phase degree. The longer the wavelength, the lower the frequency, the shorter the wavelength, the higher the frequency.</li>
</ul>
<p>So what is a Spectrum? A spectrum displays the different frequencies present in a sound.</p>
<pre class="line-numbers language-python" data-language="python"><code class="language-python">fft <span class="token operator">=</span> np<span class="token punctuation">.</span>fft<span class="token punctuation">.</span>fft<span class="token punctuation">(</span>signal<span class="token punctuation">)</span>
magnitude <span class="token operator">=</span> np<span class="token punctuation">.</span>absolute<span class="token punctuation">(</span>fft<span class="token punctuation">)</span>
frequency <span class="token operator">=</span> np<span class="token punctuation">.</span>linspace<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> sr<span class="token punctuation">,</span> <span class="token builtin">len</span><span class="token punctuation">(</span>magnitude<span class="token punctuation">)</span><span class="token punctuation">)</span>
left_frequency <span class="token operator">=</span> frequency<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token builtin">int</span><span class="token punctuation">(</span><span class="token builtin">len</span><span class="token punctuation">(</span>frequency<span class="token punctuation">)</span><span class="token operator">/</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">]</span>
left_magnitude <span class="token operator">=</span> magnitude<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token builtin">int</span><span class="token punctuation">(</span><span class="token builtin">len</span><span class="token punctuation">(</span>magnitude<span class="token punctuation">)</span><span class="token operator">/</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">]</span>

plt<span class="token punctuation">.</span>plot<span class="token punctuation">(</span>left_frequency<span class="token punctuation">,</span> left_magnitude<span class="token punctuation">,</span> color<span class="token operator">=</span><span class="token string">"tab:blue"</span><span class="token punctuation">)</span>
plt<span class="token punctuation">.</span>xlabel<span class="token punctuation">(</span><span class="token string">"Frequency"</span><span class="token punctuation">)</span>
plt<span class="token punctuation">.</span>ylabel<span class="token punctuation">(</span><span class="token string">"Magnitude"</span><span class="token punctuation">)</span>
plt<span class="token punctuation">.</span>grid<span class="token punctuation">(</span><span class="token punctuation">)</span>
plt<span class="token punctuation">.</span>show<span class="token punctuation">(</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<img src="/2021/02/05/2021-02-05-audio-based-song-genre-classification/spectrum.png" class="">

<p>I use <code>np.fft.fft</code> to perform Discrete Fourier Transform (DFT) with the efficient Fast Fourier Transform (FFT) algorithm. Fourier Transform is another mathematical representation of sound. Fourier Transform is a function that gets a signal in the time domain as input, and outputs its decomposition into frequencies.</p>
<p>The Fourier Transform is one of deepest insights ever made. Unfortunately, the meaning is buried within dense equations:</p>
<p>$$<br>X_k = \sum_{n=0}^{N-1} x_n \cdot e^{-i2 \pi kn/N} \<br>x_n = \frac{1}{N} \sum_{k=0}^{N-1} X_k \cdot e^{i2 \pi kn/N}<br>$$</p>
<p>Rather than jumping into the symbols, let’s experience the key idea firsthand. Here’s a plain-English metaphor from this <a target="_blank" rel="noopener" href="https://betterexplained.com/articles/an-interactive-guide-to-the-fourier-transform/">article</a>:</p>
<ul>
<li><strong>What does the Fourier Transform do?</strong> Given a smoothie, it finds the recipe.</li>
<li><strong>How?</strong> Run the smoothie through filters to extract each ingredient.</li>
<li><strong>Why?</strong> Recipes are easier to analyze, compare, and modify than the smoothie itself.</li>
<li><strong>How do we get the smoothie back?</strong> Blend the ingredients.</li>
</ul>
<p>The Fourier Transform changes our perspective from consumer to producer, turning What do I have? into How was it made? In other words: given a smoothie, let’s find the recipe. In the process of filtration, the components and proportions do not change, so we can reverse the formula through this transformation, which is the meaning of the filter.</p>
<p>We can now derive the Discrete Fourier Transform from the continuous version of the Fourier series development.</p>
<p>$$<br>X[k] = \sum_{n=0}^{N-1} x[n] \cdot e^{-i2 \pi kn/N} \<br>X[k] = \sum_{n=0}^{N-1} x[n] \cdot cos(\frac{2 \pi kn}{N}) - i \sum_{n=0}^{N-1} x[n] \cdot sin(\frac{2 \pi kn}{N})<br>$$</p>
<img src="/2021/02/05/2021-02-05-audio-based-song-genre-classification/fft.png" class="">

<p>Let’s implement discrete fourier transform in python.</p>
<pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">def</span> <span class="token function">dft</span><span class="token punctuation">(</span>x<span class="token punctuation">)</span><span class="token punctuation">:</span>
    x <span class="token operator">=</span> np<span class="token punctuation">.</span>asarray<span class="token punctuation">(</span>x<span class="token punctuation">,</span> dtype<span class="token operator">=</span><span class="token builtin">float</span><span class="token punctuation">)</span>
    N <span class="token operator">=</span> x<span class="token punctuation">.</span>shape<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>
    cos <span class="token operator">=</span> np<span class="token punctuation">.</span>zeros_like<span class="token punctuation">(</span>x<span class="token punctuation">)</span>
    sin <span class="token operator">=</span> np<span class="token punctuation">.</span>zeros_like<span class="token punctuation">(</span>x<span class="token punctuation">)</span>
    X <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
    <span class="token keyword">for</span> k <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span>N<span class="token punctuation">)</span><span class="token punctuation">:</span>
        real<span class="token punctuation">,</span> image <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span>
        <span class="token keyword">for</span> n <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span>N<span class="token punctuation">)</span><span class="token punctuation">:</span>
            real <span class="token operator">+=</span> x<span class="token punctuation">[</span>n<span class="token punctuation">]</span> <span class="token operator">*</span> math<span class="token punctuation">.</span>cos<span class="token punctuation">(</span><span class="token number">2</span> <span class="token operator">*</span> math<span class="token punctuation">.</span>pi <span class="token operator">*</span> k <span class="token operator">*</span> n <span class="token operator">/</span> N<span class="token punctuation">)</span>
            image <span class="token operator">+=</span> x<span class="token punctuation">[</span>n<span class="token punctuation">]</span> <span class="token operator">*</span> math<span class="token punctuation">.</span>sin<span class="token punctuation">(</span><span class="token number">2</span> <span class="token operator">*</span> math<span class="token punctuation">.</span>pi <span class="token operator">*</span> k <span class="token operator">*</span> n <span class="token operator">/</span> N<span class="token punctuation">)</span>
        X<span class="token punctuation">.</span>append<span class="token punctuation">(</span><span class="token builtin">complex</span><span class="token punctuation">(</span>real<span class="token punctuation">,</span> image<span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token keyword">return</span> np<span class="token punctuation">.</span>array<span class="token punctuation">(</span>X<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>Check whether it is correct.</p>
<pre class="line-numbers language-python" data-language="python"><code class="language-python">x <span class="token operator">=</span> np<span class="token punctuation">.</span>random<span class="token punctuation">.</span>rand<span class="token punctuation">(</span><span class="token number">1000</span><span class="token punctuation">,</span> <span class="token punctuation">)</span>
<span class="token punctuation">(</span><span class="token punctuation">(</span>fft<span class="token punctuation">(</span>x<span class="token punctuation">)</span> <span class="token operator">-</span> np<span class="token punctuation">.</span>fft<span class="token punctuation">.</span>fft<span class="token punctuation">(</span>x<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">&lt;</span> <span class="token number">1e</span><span class="token operator">-</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token builtin">all</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>

<hr>
<pre class="line-numbers language-console" data-language="console"><code class="language-console">True<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<h3 id="Intuition"><a href="#Intuition" class="headerlink" title="Intuition"></a>Intuition</h3><ul>
<li>Decompose a complex sound into its frequency components.</li>
<li>Convert time domain to frequency domain.</li>
<li>Compare signal with sinusoids of various frequencies.</li>
<li>For each frequency we get a magnitude and a phase.</li>
<li>High magnitude indicates high similarity bwtween the signal and a sinunoid.</li>
</ul>
<h3 id="Reconstruct-the-signal"><a href="#Reconstruct-the-signal" class="headerlink" title="Reconstruct the signal"></a>Reconstruct the signal</h3><ul>
<li>Superimpose sinusoids</li>
<li>Weight them bu the relative magnitude</li>
<li>Use relative phase</li>
<li>Original signal and FT have same information</li>
</ul>
<h3 id="Inverse-Fourier-Transform"><a href="#Inverse-Fourier-Transform" class="headerlink" title="Inverse Fourier Transform"></a>Inverse Fourier Transform</h3><ul>
<li>Additive synthesis (waveform -&gt; spectrum -&gt; waveform)</li>
</ul>
<h2 id="Spectrogram"><a href="#Spectrogram" class="headerlink" title="Spectrogram"></a>Spectrogram</h2><p>Short-time Fourier transform (STFT) is a sequence of Fourier transforms of a windowed signal. STFT provides the time-localized frequency information for situations in which frequency components of a signal vary over time, whereas the standard Fourier transform provides the frequency information averaged over the entire signal time interval. In this work, I use STFT to obtain sprectrogram.</p>
<p>A spectrogram is a visual way of representing the signal strength, or “loudness”, of a signal over time at various frequencies present in a particular waveform. Not only can one see whether there is more or less energy at, but one can also see how energy levels vary over time.</p>
<pre class="line-numbers language-python" data-language="python"><code class="language-python">n_fft <span class="token operator">=</span> <span class="token number">2048</span>
hop_length <span class="token operator">=</span> <span class="token number">512</span>

stft <span class="token operator">=</span> librosa<span class="token punctuation">.</span>core<span class="token punctuation">.</span>stft<span class="token punctuation">(</span>signal<span class="token punctuation">,</span> n_fft<span class="token operator">=</span>n_fft<span class="token punctuation">,</span> hop_length<span class="token operator">=</span>hop_length<span class="token punctuation">)</span>
spectrogram <span class="token operator">=</span> np<span class="token punctuation">.</span><span class="token builtin">abs</span><span class="token punctuation">(</span>stft<span class="token punctuation">)</span>
log_spectrogram <span class="token operator">=</span> librosa<span class="token punctuation">.</span>amplitude_to_db<span class="token punctuation">(</span>spectrogram<span class="token punctuation">)</span>

librosa<span class="token punctuation">.</span>display<span class="token punctuation">.</span>specshow<span class="token punctuation">(</span>log_spectrogram<span class="token punctuation">,</span> sr<span class="token operator">=</span>sr<span class="token punctuation">,</span> hop_length<span class="token operator">=</span>hop_length<span class="token punctuation">)</span>
plt<span class="token punctuation">.</span>xlabel<span class="token punctuation">(</span><span class="token string">"Time"</span><span class="token punctuation">)</span>
plt<span class="token punctuation">.</span>ylabel<span class="token punctuation">(</span><span class="token string">"Frequency"</span><span class="token punctuation">)</span>
plt<span class="token punctuation">.</span>colorbar<span class="token punctuation">(</span><span class="token punctuation">)</span>
plt<span class="token punctuation">.</span>show<span class="token punctuation">(</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<img src="/2021/02/05/2021-02-05-audio-based-song-genre-classification/spectrogram.png" class="">

<h2 id="Mel-frequency-Cepstrum-Coefficients-MFCC"><a href="#Mel-frequency-Cepstrum-Coefficients-MFCC" class="headerlink" title="Mel-frequency Cepstrum Coefficients (MFCC)"></a>Mel-frequency Cepstrum Coefficients (MFCC)</h2><p>Mel-frequency cepstral coefficients (MFCCs) are coefficients that collectively make up an MFC. They are derived from a type of cepstral representation of the audio clip (a nonlinear “spectrum-of-a-spectrum”). The advantage of MFCC is that it is good in error reduction and able to produce a robust feature when the signal is affected by noise.</p>
<pre class="line-numbers language-python" data-language="python"><code class="language-python">mfcc <span class="token operator">=</span> librosa<span class="token punctuation">.</span>feature<span class="token punctuation">.</span>mfcc<span class="token punctuation">(</span>signal<span class="token punctuation">,</span> n_fft<span class="token operator">=</span>n_fft<span class="token punctuation">,</span> hop_length<span class="token operator">=</span>hop_length<span class="token punctuation">,</span> n_mfcc<span class="token operator">=</span><span class="token number">13</span><span class="token punctuation">)</span>
librosa<span class="token punctuation">.</span>display<span class="token punctuation">.</span>specshow<span class="token punctuation">(</span>mfcc<span class="token punctuation">,</span> sr<span class="token operator">=</span>sr<span class="token punctuation">,</span> hop_length<span class="token operator">=</span>hop_length<span class="token punctuation">)</span>
plt<span class="token punctuation">.</span>xlabel<span class="token punctuation">(</span><span class="token string">"Time"</span><span class="token punctuation">)</span>
plt<span class="token punctuation">.</span>ylabel<span class="token punctuation">(</span><span class="token string">"MFCC"</span><span class="token punctuation">)</span>
plt<span class="token punctuation">.</span>colorbar<span class="token punctuation">(</span><span class="token punctuation">)</span>
plt<span class="token punctuation">.</span>show<span class="token punctuation">(</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<img src="/2021/02/05/2021-02-05-audio-based-song-genre-classification/mfcc.png" class="">

<h2 id="Time-domain-Features"><a href="#Time-domain-Features" class="headerlink" title="Time-domain Features"></a>Time-domain Features</h2><ul>
<li>Amplitude envelope (AE)</li>
<li>Root-mean-square energy (RMS)</li>
<li>Zero-crossing rate (ZCR)</li>
</ul>
<h3 id="Amplitude-envelope"><a href="#Amplitude-envelope" class="headerlink" title="Amplitude envelope"></a>Amplitude envelope</h3><ul>
<li>Max value of all samples in a frame: </li>
</ul>
<p>$$AE_t = \max_{k=t \cdot K}^{(t+1) \cdot K-1} s(k)$$</p>
<ul>
<li>Gives rough idea of loudness</li>
<li>Sensitive to outliers</li>
<li>Onset detection, music genre classification</li>
</ul>
<pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">def</span> <span class="token function">amplitude_envelope</span><span class="token punctuation">(</span>signal<span class="token punctuation">,</span> frame_length<span class="token punctuation">,</span> hop_length<span class="token punctuation">)</span><span class="token punctuation">:</span>
    amplitude_envelope <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
    <span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token builtin">len</span><span class="token punctuation">(</span>signal<span class="token punctuation">)</span><span class="token punctuation">,</span> hop_length<span class="token punctuation">)</span><span class="token punctuation">:</span>
        current_frame_amplitude_envelope <span class="token operator">=</span> <span class="token builtin">max</span><span class="token punctuation">(</span>signal<span class="token punctuation">[</span>i<span class="token punctuation">:</span>i<span class="token operator">+</span>frame_length<span class="token punctuation">]</span><span class="token punctuation">)</span>
        amplitude_envelope<span class="token punctuation">.</span>append<span class="token punctuation">(</span>current_frame_amplitude_envelope<span class="token punctuation">)</span>
    <span class="token keyword">return</span> np<span class="token punctuation">.</span>array<span class="token punctuation">(</span>amplitude_envelope<span class="token punctuation">)</span>

FRAME_LENGTH <span class="token operator">=</span> <span class="token number">1024</span>
HOP_LENGTH <span class="token operator">=</span> <span class="token number">512</span>

ae_blank_space <span class="token operator">=</span> amplitude_envelope<span class="token punctuation">(</span>blank_space<span class="token punctuation">,</span> FRAME_LENGTH<span class="token punctuation">,</span> HOP_LENGTH<span class="token punctuation">)</span>
frames <span class="token operator">=</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> ae_blank_space<span class="token punctuation">.</span>size<span class="token punctuation">)</span>
t_interval <span class="token operator">=</span> librosa<span class="token punctuation">.</span>frames_to_time<span class="token punctuation">(</span>frames<span class="token punctuation">,</span> hop_length<span class="token operator">=</span>HOP_LENGTH<span class="token punctuation">)</span>

librosa<span class="token punctuation">.</span>display<span class="token punctuation">.</span>waveplot<span class="token punctuation">(</span>blank_space<span class="token punctuation">,</span> alpha<span class="token operator">=</span><span class="token number">0.5</span><span class="token punctuation">)</span>
plt<span class="token punctuation">.</span>plot<span class="token punctuation">(</span>t_interval<span class="token punctuation">,</span> ae_blank_space<span class="token punctuation">,</span> color<span class="token operator">=</span><span class="token string">"tab:red"</span><span class="token punctuation">)</span>
plt<span class="token punctuation">.</span>title<span class="token punctuation">(</span><span class="token string">"Taylor Swift Blank Space Amplitude Envelope"</span><span class="token punctuation">)</span>
plt<span class="token punctuation">.</span>ylim<span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
plt<span class="token punctuation">.</span>show<span class="token punctuation">(</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<img src="/2021/02/05/2021-02-05-audio-based-song-genre-classification/ae.png" class="">

<h3 id="Root-mean-square-energy"><a href="#Root-mean-square-energy" class="headerlink" title="Root-mean-square energy"></a>Root-mean-square energy</h3><ul>
<li>RMS of all samples in a frame: </li>
</ul>
<p>$$RMS_t = \sqrt[2]{\frac{1}{K} \cdot \sum_{k=t \cdot K}^{(t+1) \cdot K-1} s(k)^2}$$</p>
<ul>
<li>Indicator of loudness.</li>
<li>Less sensitive to outliers than AE.</li>
<li>Audio segmentation, music genre classification</li>
</ul>
<pre class="line-numbers language-python" data-language="python"><code class="language-python">FRAME_LENGTH <span class="token operator">=</span> <span class="token number">1024</span>
HOP_LENGTH <span class="token operator">=</span> <span class="token number">512</span>

rms_blank_space <span class="token operator">=</span> librosa<span class="token punctuation">.</span>feature<span class="token punctuation">.</span>rms<span class="token punctuation">(</span>blank_space<span class="token punctuation">,</span> frame_length<span class="token operator">=</span>FRAME_LENGTH<span class="token punctuation">,</span> hop_length<span class="token operator">=</span>HOP_LENGTH<span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>
frames <span class="token operator">=</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> rms_blank_space<span class="token punctuation">.</span>size<span class="token punctuation">)</span>
t_interval <span class="token operator">=</span> librosa<span class="token punctuation">.</span>frames_to_time<span class="token punctuation">(</span>frames<span class="token punctuation">,</span> hop_length<span class="token operator">=</span>HOP_LENGTH<span class="token punctuation">)</span>

librosa<span class="token punctuation">.</span>display<span class="token punctuation">.</span>waveplot<span class="token punctuation">(</span>blank_space<span class="token punctuation">,</span> alpha<span class="token operator">=</span><span class="token number">0.5</span><span class="token punctuation">)</span>
plt<span class="token punctuation">.</span>plot<span class="token punctuation">(</span>t_interval<span class="token punctuation">,</span> rms_blank_space<span class="token punctuation">,</span> color<span class="token operator">=</span><span class="token string">"tab:red"</span><span class="token punctuation">)</span>
plt<span class="token punctuation">.</span>title<span class="token punctuation">(</span><span class="token string">"Taylor Swift Blank Space Root-mean-square energy"</span><span class="token punctuation">)</span>
plt<span class="token punctuation">.</span>ylim<span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
plt<span class="token punctuation">.</span>show<span class="token punctuation">(</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<img src="/2021/02/05/2021-02-05-audio-based-song-genre-classification/rmse.png" class="">

<p>We can also build the function by ourselves.</p>
<pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">def</span> <span class="token function">root_mean_square</span><span class="token punctuation">(</span>signal<span class="token punctuation">,</span> frame_length<span class="token punctuation">,</span> hop_length<span class="token punctuation">)</span><span class="token punctuation">:</span>
    rms <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
    <span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token builtin">len</span><span class="token punctuation">(</span>signal<span class="token punctuation">)</span><span class="token punctuation">,</span> hop_length<span class="token punctuation">)</span><span class="token punctuation">:</span>
        current_frame_rms <span class="token operator">=</span> np<span class="token punctuation">.</span>sqrt<span class="token punctuation">(</span>np<span class="token punctuation">.</span><span class="token builtin">sum</span><span class="token punctuation">(</span>np<span class="token punctuation">.</span>square<span class="token punctuation">(</span>signal<span class="token punctuation">[</span>i<span class="token punctuation">:</span>i<span class="token operator">+</span>frame_length<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">/</span> frame_length<span class="token punctuation">)</span>
        rms<span class="token punctuation">.</span>append<span class="token punctuation">(</span>current_frame_rms<span class="token punctuation">)</span>
    <span class="token keyword">return</span> np<span class="token punctuation">.</span>array<span class="token punctuation">(</span>rms<span class="token punctuation">)</span>

rms_blank_space_from_scratch <span class="token operator">=</span> root_mean_square<span class="token punctuation">(</span>blank_space<span class="token punctuation">,</span> FRAME_LENGTH<span class="token punctuation">,</span> HOP_LENGTH<span class="token punctuation">)</span>
frames <span class="token operator">=</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> rms_blank_space_from_scratch<span class="token punctuation">.</span>size<span class="token punctuation">)</span>
t_interval <span class="token operator">=</span> librosa<span class="token punctuation">.</span>frames_to_time<span class="token punctuation">(</span>frames<span class="token punctuation">,</span> hop_length<span class="token operator">=</span>HOP_LENGTH<span class="token punctuation">)</span>

librosa<span class="token punctuation">.</span>display<span class="token punctuation">.</span>waveplot<span class="token punctuation">(</span>blank_space<span class="token punctuation">,</span> alpha<span class="token operator">=</span><span class="token number">0.5</span><span class="token punctuation">)</span>
plt<span class="token punctuation">.</span>plot<span class="token punctuation">(</span>t_interval<span class="token punctuation">,</span> rms_blank_space_from_scratch<span class="token punctuation">,</span> color<span class="token operator">=</span><span class="token string">"tab:red"</span><span class="token punctuation">)</span>
plt<span class="token punctuation">.</span>title<span class="token punctuation">(</span><span class="token string">"Taylor Swift Blank Space Root-mean-square energy from scratch"</span><span class="token punctuation">)</span>
plt<span class="token punctuation">.</span>ylim<span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
plt<span class="token punctuation">.</span>show<span class="token punctuation">(</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<img src="/2021/02/05/2021-02-05-audio-based-song-genre-classification/rmse-from-scratch.png" class="">

<h3 id="Zero-crossing-rate"><a href="#Zero-crossing-rate" class="headerlink" title="Zero-crossing rate"></a>Zero-crossing rate</h3><ul>
<li>Number of times a signal crosses the horizontal axis: </li>
</ul>
<p>$$ZCR_t = \frac{1}{2} \cdot \sum_{k=t \cdot K}^{(t+1) \cdot K-1} |sgn(s(k)) - sgn(s(k+1))|$$</p>
<ul>
<li>Recognition of percussive vs pitched sounds</li>
<li>Monophonic pitch estimation</li>
<li>Voice / Unvoiced decision for speech signals</li>
</ul>
<pre class="line-numbers language-python" data-language="python"><code class="language-python">zrc_blank_space <span class="token operator">=</span> librosa<span class="token punctuation">.</span>feature<span class="token punctuation">.</span>zero_crossing_rate<span class="token punctuation">(</span>blank_space<span class="token punctuation">,</span> frame_length<span class="token operator">=</span>FRAME_LENGTH<span class="token punctuation">,</span> hop_length<span class="token operator">=</span>HOP_LENGTH<span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>
frames <span class="token operator">=</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> zrc_blank_space<span class="token punctuation">.</span>size<span class="token punctuation">)</span>
t_interval <span class="token operator">=</span> librosa<span class="token punctuation">.</span>frames_to_time<span class="token punctuation">(</span>frames<span class="token punctuation">,</span> hop_length<span class="token operator">=</span>HOP_LENGTH<span class="token punctuation">)</span>

plt<span class="token punctuation">.</span>plot<span class="token punctuation">(</span>t_interval<span class="token punctuation">,</span> zrc_blank_space<span class="token operator">*</span>FRAME_LENGTH<span class="token punctuation">,</span> color<span class="token operator">=</span><span class="token string">"tab:red"</span><span class="token punctuation">)</span>
plt<span class="token punctuation">.</span>title<span class="token punctuation">(</span><span class="token string">"Taylor Swift Blank Zero-crossing rate"</span><span class="token punctuation">)</span>
plt<span class="token punctuation">.</span>ylim<span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">50</span><span class="token punctuation">,</span> <span class="token number">600</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
plt<span class="token punctuation">.</span>show<span class="token punctuation">(</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<img src="/2021/02/05/2021-02-05-audio-based-song-genre-classification/zcr.png" class="">

<h1 id="Prepare-Data"><a href="#Prepare-Data" class="headerlink" title="Prepare Data"></a>Prepare Data</h1><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">import</span> os
<span class="token keyword">import</span> json
<span class="token keyword">import</span> math

DATASETPATH <span class="token operator">=</span> <span class="token string">"mp3"</span>
JSONPATH <span class="token operator">=</span> <span class="token string">"data.json"</span>

<span class="token keyword">def</span> <span class="token function">save_mfcc</span><span class="token punctuation">(</span>dataset_path<span class="token punctuation">,</span> json_path<span class="token punctuation">,</span> sr<span class="token operator">=</span><span class="token number">22050</span><span class="token punctuation">,</span> duration<span class="token operator">=</span><span class="token number">30</span><span class="token punctuation">,</span> n_mfcc<span class="token operator">=</span><span class="token number">13</span><span class="token punctuation">,</span> n_fft<span class="token operator">=</span><span class="token number">2048</span><span class="token punctuation">,</span> hop_length<span class="token operator">=</span><span class="token number">512</span><span class="token punctuation">,</span> num_segment<span class="token operator">=</span><span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    data <span class="token operator">=</span> <span class="token punctuation">&#123;</span>
        <span class="token string">"mapping"</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span> 
        <span class="token string">"mfcc"</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span> 
        <span class="token string">"labels"</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
    <span class="token punctuation">&#125;</span>
    samples_per_track <span class="token operator">=</span> sr <span class="token operator">*</span> duration
    num_samples_per_segment <span class="token operator">=</span> <span class="token builtin">int</span><span class="token punctuation">(</span>samples_per_track <span class="token operator">/</span> num_segment<span class="token punctuation">)</span>
    expected_num_mfcc_vectors_per_segment <span class="token operator">=</span> math<span class="token punctuation">.</span>ceil<span class="token punctuation">(</span>num_samples_per_segment <span class="token operator">/</span> hop_length<span class="token punctuation">)</span>
    
    <span class="token comment"># Loop through all the genre folders</span>
    <span class="token keyword">for</span> i<span class="token punctuation">,</span> <span class="token punctuation">(</span>dirpath<span class="token punctuation">,</span> dirnames<span class="token punctuation">,</span> filenames<span class="token punctuation">)</span> <span class="token keyword">in</span> <span class="token builtin">enumerate</span><span class="token punctuation">(</span>os<span class="token punctuation">.</span>walk<span class="token punctuation">(</span>dataset_path<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">if</span> dirpath <span class="token keyword">is</span> <span class="token keyword">not</span> dataset_path<span class="token punctuation">:</span>
            <span class="token comment"># Save semantic labels</span>
            dirpath_components <span class="token operator">=</span> dirpath<span class="token punctuation">.</span>split<span class="token punctuation">(</span><span class="token string">"/"</span><span class="token punctuation">)</span>
            semantic_label <span class="token operator">=</span> dirpath_components<span class="token punctuation">[</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span>
            data<span class="token punctuation">[</span><span class="token string">"mapping"</span><span class="token punctuation">]</span><span class="token punctuation">.</span>append<span class="token punctuation">(</span>semantic_label<span class="token punctuation">)</span>
            <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"\nProcessing </span><span class="token interpolation"><span class="token punctuation">&#123;</span>semantic_label<span class="token punctuation">&#125;</span></span><span class="token string">"</span></span><span class="token punctuation">)</span>
            
            <span class="token comment"># Process files for a specific genres</span>
            <span class="token keyword">for</span> f <span class="token keyword">in</span> filenames<span class="token punctuation">:</span>
                file_path <span class="token operator">=</span> os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>join<span class="token punctuation">(</span>dirpath<span class="token punctuation">,</span> f<span class="token punctuation">)</span>
                signal<span class="token punctuation">,</span> sr <span class="token operator">=</span> librosa<span class="token punctuation">.</span>load<span class="token punctuation">(</span>file_path<span class="token punctuation">,</span> sr<span class="token operator">=</span>sr<span class="token punctuation">)</span>
                
                <span class="token comment"># Process segments extracting mfcc and store data</span>
                <span class="token keyword">for</span> s <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span>num_segment<span class="token punctuation">)</span><span class="token punctuation">:</span>
                    start_sample <span class="token operator">=</span> num_samples_per_segment <span class="token operator">*</span> s
                    finish_sample <span class="token operator">=</span> start_sample <span class="token operator">+</span> num_samples_per_segment
                    mfcc <span class="token operator">=</span> librosa<span class="token punctuation">.</span>feature<span class="token punctuation">.</span>mfcc<span class="token punctuation">(</span>signal<span class="token punctuation">[</span>start_sample<span class="token punctuation">:</span>finish_sample<span class="token punctuation">]</span><span class="token punctuation">,</span> 
                                                sr<span class="token operator">=</span>sr<span class="token punctuation">,</span> 
                                                n_mfcc<span class="token operator">=</span><span class="token number">13</span><span class="token punctuation">,</span> 
                                                n_fft<span class="token operator">=</span><span class="token number">2048</span><span class="token punctuation">,</span> 
                                                hop_length<span class="token operator">=</span><span class="token number">512</span><span class="token punctuation">)</span>
                    mfcc <span class="token operator">=</span> mfcc<span class="token punctuation">.</span>T
                    
                    <span class="token comment"># Store mfcc for segment if it has the expected length</span>
                    <span class="token keyword">if</span> <span class="token builtin">len</span><span class="token punctuation">(</span>mfcc<span class="token punctuation">)</span> <span class="token operator">==</span> expected_num_mfcc_vectors_per_segment<span class="token punctuation">:</span>
                        data<span class="token punctuation">[</span><span class="token string">"mfcc"</span><span class="token punctuation">]</span><span class="token punctuation">.</span>append<span class="token punctuation">(</span>mfcc<span class="token punctuation">.</span>tolist<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                        data<span class="token punctuation">[</span><span class="token string">"labels"</span><span class="token punctuation">]</span><span class="token punctuation">.</span>append<span class="token punctuation">(</span>i<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span>
                        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"</span><span class="token interpolation"><span class="token punctuation">&#123;</span>file_path<span class="token punctuation">&#125;</span></span><span class="token string"> | segments: </span><span class="token interpolation"><span class="token punctuation">&#123;</span>s<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">&#125;</span></span><span class="token string">"</span></span><span class="token punctuation">)</span>
    
    <span class="token comment"># Save data to a json file</span>
    <span class="token keyword">with</span> <span class="token builtin">open</span><span class="token punctuation">(</span>json_path<span class="token punctuation">,</span> <span class="token string">"w"</span><span class="token punctuation">)</span> <span class="token keyword">as</span> fp<span class="token punctuation">:</span>
        json<span class="token punctuation">.</span>dump<span class="token punctuation">(</span>data<span class="token punctuation">,</span> fp<span class="token punctuation">,</span> indent<span class="token operator">=</span><span class="token number">4</span><span class="token punctuation">)</span>

<span class="token keyword">def</span> <span class="token function">load_data</span><span class="token punctuation">(</span>json_path<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">with</span> <span class="token builtin">open</span><span class="token punctuation">(</span>json_path<span class="token punctuation">,</span> <span class="token string">"r"</span><span class="token punctuation">)</span> <span class="token keyword">as</span> fp<span class="token punctuation">:</span>
        data <span class="token operator">=</span> json<span class="token punctuation">.</span>load<span class="token punctuation">(</span>fp<span class="token punctuation">)</span>
        
    features <span class="token operator">=</span> np<span class="token punctuation">.</span>array<span class="token punctuation">(</span>data<span class="token punctuation">[</span><span class="token string">"mfcc"</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
    targets <span class="token operator">=</span> np<span class="token punctuation">.</span>array<span class="token punctuation">(</span>data<span class="token punctuation">[</span><span class="token string">"labels"</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
    
    <span class="token keyword">return</span> features<span class="token punctuation">,</span> targets

save_mfcc<span class="token punctuation">(</span>DATASETPATH<span class="token punctuation">,</span> JSONPATH<span class="token punctuation">)</span>
features<span class="token punctuation">,</span> targets <span class="token operator">=</span> load_data<span class="token punctuation">(</span>JSONPATH<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>Split the data into training dataset and validation dataset.</p>
<pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">from</span> sklearn<span class="token punctuation">.</span>model_selection <span class="token keyword">import</span> train_test_split

X_trainvalid<span class="token punctuation">,</span> X_test<span class="token punctuation">,</span> y_trainvalid<span class="token punctuation">,</span> y_test <span class="token operator">=</span> train_test_split<span class="token punctuation">(</span>features<span class="token punctuation">,</span> targets<span class="token punctuation">,</span> test_size<span class="token operator">=</span><span class="token number">0.1</span><span class="token punctuation">,</span> stratify<span class="token operator">=</span>targets<span class="token punctuation">)</span>
X_train<span class="token punctuation">,</span> X_valid<span class="token punctuation">,</span> y_train<span class="token punctuation">,</span> y_valid <span class="token operator">=</span> train_test_split<span class="token punctuation">(</span>X_trainvalid<span class="token punctuation">,</span> y_trainvalid<span class="token punctuation">,</span> test_size<span class="token operator">=</span><span class="token number">0.125</span><span class="token punctuation">,</span> stratify<span class="token operator">=</span>y_trainvalid<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>

<h1 id="Modeling"><a href="#Modeling" class="headerlink" title="Modeling"></a>Modeling</h1><p>Load the libraries.</p>
<pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">import</span> tez
<span class="token keyword">import</span> torch
<span class="token keyword">import</span> torch<span class="token punctuation">.</span>nn <span class="token keyword">as</span> nn
<span class="token keyword">from</span> sklearn <span class="token keyword">import</span> metrics<span class="token punctuation">,</span> model_selection<span class="token punctuation">,</span> preprocessing
<span class="token keyword">from</span> tez<span class="token punctuation">.</span>callbacks <span class="token keyword">import</span> EarlyStopping
<span class="token keyword">from</span> tez <span class="token keyword">import</span> enums
<span class="token keyword">from</span> tez<span class="token punctuation">.</span>utils <span class="token keyword">import</span> AverageMeter
<span class="token keyword">from</span> torch<span class="token punctuation">.</span>utils<span class="token punctuation">.</span>data <span class="token keyword">import</span> Dataset
<span class="token keyword">from</span> torch<span class="token punctuation">.</span>nn <span class="token keyword">import</span> functional <span class="token keyword">as</span> F
<span class="token keyword">from</span> collections <span class="token keyword">import</span> defaultdict
<span class="token keyword">from</span> tqdm <span class="token keyword">import</span> tqdm<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>Create <code>Dataset()</code> class from PyTorch.</p>
<pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">class</span> <span class="token class-name">SongGenreDataset</span><span class="token punctuation">(</span>Dataset<span class="token punctuation">)</span><span class="token punctuation">:</span>
    
    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> features<span class="token punctuation">,</span> targets<span class="token punctuation">)</span><span class="token punctuation">:</span>
        self<span class="token punctuation">.</span>features <span class="token operator">=</span> features
        self<span class="token punctuation">.</span>targets <span class="token operator">=</span> targets

    <span class="token keyword">def</span> <span class="token function">__len__</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">return</span> <span class="token builtin">len</span><span class="token punctuation">(</span>self<span class="token punctuation">.</span>features<span class="token punctuation">)</span>

    <span class="token keyword">def</span> <span class="token function">__getitem__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> idx<span class="token punctuation">)</span><span class="token punctuation">:</span>
        target <span class="token operator">=</span> self<span class="token punctuation">.</span>targets<span class="token punctuation">[</span>idx<span class="token punctuation">]</span>
        target <span class="token operator">=</span> np<span class="token punctuation">.</span>array<span class="token punctuation">(</span>target<span class="token punctuation">)</span>
        target <span class="token operator">=</span> target<span class="token punctuation">.</span>astype<span class="token punctuation">(</span>np<span class="token punctuation">.</span>float64<span class="token punctuation">)</span>
        feature <span class="token operator">=</span> self<span class="token punctuation">.</span>features<span class="token punctuation">[</span>idx<span class="token punctuation">]</span>
        feature <span class="token operator">=</span> np<span class="token punctuation">.</span>array<span class="token punctuation">(</span><span class="token punctuation">[</span>feature<span class="token punctuation">]</span><span class="token punctuation">)</span>
        feature <span class="token operator">=</span> feature<span class="token punctuation">.</span>astype<span class="token punctuation">(</span>np<span class="token punctuation">.</span>float64<span class="token punctuation">)</span>
        feature <span class="token operator">=</span> np<span class="token punctuation">.</span>expand_dims<span class="token punctuation">(</span>feature<span class="token punctuation">,</span> axis<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span>
        sample <span class="token operator">=</span> <span class="token punctuation">&#123;</span>
            <span class="token string">'feature'</span><span class="token punctuation">:</span> torch<span class="token punctuation">.</span>from_numpy<span class="token punctuation">(</span>feature<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token builtin">float</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> 
            <span class="token string">'target'</span><span class="token punctuation">:</span> torch<span class="token punctuation">.</span>from_numpy<span class="token punctuation">(</span>target<span class="token punctuation">)</span><span class="token punctuation">&#125;</span>
        <span class="token keyword">return</span> sample<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<hr>
<pre class="line-numbers language-python" data-language="python"><code class="language-python">train_dataset <span class="token operator">=</span> SongGenreDataset<span class="token punctuation">(</span>X_train<span class="token punctuation">,</span> y_train<span class="token punctuation">)</span>
valid_dataset <span class="token operator">=</span> SongGenreDataset<span class="token punctuation">(</span>X_valid<span class="token punctuation">,</span> y_valid<span class="token punctuation">)</span>
test_dataset <span class="token operator">=</span> SongGenreDataset<span class="token punctuation">(</span>X_test<span class="token punctuation">,</span> y_test<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>

<p>Create a simple MLP model.</p>
<pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">class</span> <span class="token class-name">SongGenreMLPClassifier</span><span class="token punctuation">(</span>tez<span class="token punctuation">.</span>Model<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> num_classes<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token builtin">super</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>__init__<span class="token punctuation">(</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>dropout <span class="token operator">=</span> nn<span class="token punctuation">.</span>Dropout<span class="token punctuation">(</span><span class="token number">0.1</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>fc1 <span class="token operator">=</span> nn<span class="token punctuation">.</span>Linear<span class="token punctuation">(</span><span class="token number">259</span><span class="token operator">*</span><span class="token number">13</span><span class="token punctuation">,</span> <span class="token number">128</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>out <span class="token operator">=</span> nn<span class="token punctuation">.</span>Linear<span class="token punctuation">(</span><span class="token number">128</span><span class="token punctuation">,</span> num_classes<span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>step_scheduler_after <span class="token operator">=</span> <span class="token string">"epoch"</span>
        self<span class="token punctuation">.</span>num_classes <span class="token operator">=</span> num_classes
        self<span class="token punctuation">.</span>history <span class="token operator">=</span> defaultdict<span class="token punctuation">(</span><span class="token builtin">list</span><span class="token punctuation">)</span>

    <span class="token keyword">def</span> <span class="token function">monitor_metrics</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> outputs<span class="token punctuation">,</span> targets<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">if</span> targets <span class="token keyword">is</span> <span class="token boolean">None</span><span class="token punctuation">:</span>
            <span class="token keyword">return</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span>
        outputs <span class="token operator">=</span> torch<span class="token punctuation">.</span>argmax<span class="token punctuation">(</span>outputs<span class="token punctuation">,</span> dim<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">.</span>cpu<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>detach<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>numpy<span class="token punctuation">(</span><span class="token punctuation">)</span>
        targets <span class="token operator">=</span> targets<span class="token punctuation">.</span>cpu<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>detach<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>numpy<span class="token punctuation">(</span><span class="token punctuation">)</span>
        accuracy <span class="token operator">=</span> metrics<span class="token punctuation">.</span>accuracy_score<span class="token punctuation">(</span>targets<span class="token punctuation">,</span> outputs<span class="token punctuation">)</span>
        <span class="token keyword">return</span> <span class="token punctuation">&#123;</span><span class="token string">"accuracy"</span><span class="token punctuation">:</span> accuracy<span class="token punctuation">&#125;</span>

    <span class="token keyword">def</span> <span class="token function">fetch_optimizer</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>
        opt <span class="token operator">=</span> torch<span class="token punctuation">.</span>optim<span class="token punctuation">.</span>Adam<span class="token punctuation">(</span>self<span class="token punctuation">.</span>parameters<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> lr<span class="token operator">=</span><span class="token number">3e</span><span class="token operator">-</span><span class="token number">4</span><span class="token punctuation">)</span>
        <span class="token keyword">return</span> opt

    <span class="token keyword">def</span> <span class="token function">fetch_scheduler</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>
        sch <span class="token operator">=</span> torch<span class="token punctuation">.</span>optim<span class="token punctuation">.</span>lr_scheduler<span class="token punctuation">.</span>CosineAnnealingWarmRestarts<span class="token punctuation">(</span>
            self<span class="token punctuation">.</span>optimizer<span class="token punctuation">,</span> T_0<span class="token operator">=</span><span class="token number">10</span><span class="token punctuation">,</span> T_mult<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">,</span> eta_min<span class="token operator">=</span><span class="token number">1e</span><span class="token operator">-</span><span class="token number">6</span><span class="token punctuation">,</span> last_epoch<span class="token operator">=</span><span class="token operator">-</span><span class="token number">1</span>
        <span class="token punctuation">)</span>
        <span class="token keyword">return</span> sch

    <span class="token keyword">def</span> <span class="token function">train_one_epoch</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> data_loader<span class="token punctuation">)</span><span class="token punctuation">:</span>
        self<span class="token punctuation">.</span>train<span class="token punctuation">(</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>model_state <span class="token operator">=</span> enums<span class="token punctuation">.</span>ModelState<span class="token punctuation">.</span>TRAIN
        losses <span class="token operator">=</span> AverageMeter<span class="token punctuation">(</span><span class="token punctuation">)</span>
        tk0 <span class="token operator">=</span> tqdm<span class="token punctuation">(</span>data_loader<span class="token punctuation">,</span> total<span class="token operator">=</span><span class="token builtin">len</span><span class="token punctuation">(</span>data_loader<span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token keyword">for</span> b_idx<span class="token punctuation">,</span> data <span class="token keyword">in</span> <span class="token builtin">enumerate</span><span class="token punctuation">(</span>tk0<span class="token punctuation">)</span><span class="token punctuation">:</span>
            self<span class="token punctuation">.</span>train_state <span class="token operator">=</span> enums<span class="token punctuation">.</span>TrainingState<span class="token punctuation">.</span>TRAIN_STEP_START
            loss<span class="token punctuation">,</span> metrics <span class="token operator">=</span> self<span class="token punctuation">.</span>train_one_step<span class="token punctuation">(</span>data<span class="token punctuation">)</span>
            self<span class="token punctuation">.</span>train_state <span class="token operator">=</span> enums<span class="token punctuation">.</span>TrainingState<span class="token punctuation">.</span>TRAIN_STEP_END
            losses<span class="token punctuation">.</span>update<span class="token punctuation">(</span>loss<span class="token punctuation">.</span>item<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> data_loader<span class="token punctuation">.</span>batch_size<span class="token punctuation">)</span>
            <span class="token keyword">if</span> b_idx <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">:</span>
                metrics_meter <span class="token operator">=</span> <span class="token punctuation">&#123;</span>k<span class="token punctuation">:</span> AverageMeter<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">for</span> k <span class="token keyword">in</span> metrics<span class="token punctuation">&#125;</span>
            monitor <span class="token operator">=</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span>
            <span class="token keyword">for</span> m_m <span class="token keyword">in</span> metrics_meter<span class="token punctuation">:</span>
                metrics_meter<span class="token punctuation">[</span>m_m<span class="token punctuation">]</span><span class="token punctuation">.</span>update<span class="token punctuation">(</span>metrics<span class="token punctuation">[</span>m_m<span class="token punctuation">]</span><span class="token punctuation">,</span> data_loader<span class="token punctuation">.</span>batch_size<span class="token punctuation">)</span>
                monitor<span class="token punctuation">[</span>m_m<span class="token punctuation">]</span> <span class="token operator">=</span> metrics_meter<span class="token punctuation">[</span>m_m<span class="token punctuation">]</span><span class="token punctuation">.</span>avg
            self<span class="token punctuation">.</span>current_train_step <span class="token operator">+=</span> <span class="token number">1</span>
            tk0<span class="token punctuation">.</span>set_postfix<span class="token punctuation">(</span>loss<span class="token operator">=</span>losses<span class="token punctuation">.</span>avg<span class="token punctuation">,</span> stage<span class="token operator">=</span><span class="token string">"train"</span><span class="token punctuation">,</span> <span class="token operator">**</span>monitor<span class="token punctuation">)</span>
        tk0<span class="token punctuation">.</span>close<span class="token punctuation">(</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>update_metrics<span class="token punctuation">(</span>losses<span class="token operator">=</span>losses<span class="token punctuation">,</span> monitor<span class="token operator">=</span>monitor<span class="token punctuation">)</span>
        <span class="token keyword">for</span> k<span class="token punctuation">,</span> v <span class="token keyword">in</span> monitor<span class="token punctuation">.</span>items<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
            self<span class="token punctuation">.</span>history<span class="token punctuation">[</span><span class="token string-interpolation"><span class="token string">f"train_</span><span class="token interpolation"><span class="token punctuation">&#123;</span>k<span class="token punctuation">&#125;</span></span><span class="token string">"</span></span><span class="token punctuation">]</span><span class="token punctuation">.</span>append<span class="token punctuation">(</span>v<span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>history<span class="token punctuation">[</span><span class="token string">"train_loss"</span><span class="token punctuation">]</span><span class="token punctuation">.</span>append<span class="token punctuation">(</span>losses<span class="token punctuation">.</span>avg<span class="token punctuation">)</span>
        <span class="token keyword">return</span> losses<span class="token punctuation">.</span>avg

    <span class="token keyword">def</span> <span class="token function">validate_one_epoch</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> data_loader<span class="token punctuation">)</span><span class="token punctuation">:</span>
        self<span class="token punctuation">.</span><span class="token builtin">eval</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>model_state <span class="token operator">=</span> enums<span class="token punctuation">.</span>ModelState<span class="token punctuation">.</span>VALID
        losses <span class="token operator">=</span> AverageMeter<span class="token punctuation">(</span><span class="token punctuation">)</span>
        tk0 <span class="token operator">=</span> tqdm<span class="token punctuation">(</span>data_loader<span class="token punctuation">,</span> total<span class="token operator">=</span><span class="token builtin">len</span><span class="token punctuation">(</span>data_loader<span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token keyword">for</span> b_idx<span class="token punctuation">,</span> data <span class="token keyword">in</span> <span class="token builtin">enumerate</span><span class="token punctuation">(</span>tk0<span class="token punctuation">)</span><span class="token punctuation">:</span>
            self<span class="token punctuation">.</span>train_state <span class="token operator">=</span> enums<span class="token punctuation">.</span>TrainingState<span class="token punctuation">.</span>VALID_STEP_START
            <span class="token keyword">with</span> torch<span class="token punctuation">.</span>no_grad<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
                loss<span class="token punctuation">,</span> metrics <span class="token operator">=</span> self<span class="token punctuation">.</span>validate_one_step<span class="token punctuation">(</span>data<span class="token punctuation">)</span>
            self<span class="token punctuation">.</span>train_state <span class="token operator">=</span> enums<span class="token punctuation">.</span>TrainingState<span class="token punctuation">.</span>VALID_STEP_END
            losses<span class="token punctuation">.</span>update<span class="token punctuation">(</span>loss<span class="token punctuation">.</span>item<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> data_loader<span class="token punctuation">.</span>batch_size<span class="token punctuation">)</span>
            <span class="token keyword">if</span> b_idx <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">:</span>
                metrics_meter <span class="token operator">=</span> <span class="token punctuation">&#123;</span>k<span class="token punctuation">:</span> AverageMeter<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">for</span> k <span class="token keyword">in</span> metrics<span class="token punctuation">&#125;</span>
            monitor <span class="token operator">=</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span>
            <span class="token keyword">for</span> m_m <span class="token keyword">in</span> metrics_meter<span class="token punctuation">:</span>
                metrics_meter<span class="token punctuation">[</span>m_m<span class="token punctuation">]</span><span class="token punctuation">.</span>update<span class="token punctuation">(</span>metrics<span class="token punctuation">[</span>m_m<span class="token punctuation">]</span><span class="token punctuation">,</span> data_loader<span class="token punctuation">.</span>batch_size<span class="token punctuation">)</span>
                monitor<span class="token punctuation">[</span>m_m<span class="token punctuation">]</span> <span class="token operator">=</span> metrics_meter<span class="token punctuation">[</span>m_m<span class="token punctuation">]</span><span class="token punctuation">.</span>avg
            tk0<span class="token punctuation">.</span>set_postfix<span class="token punctuation">(</span>loss<span class="token operator">=</span>losses<span class="token punctuation">.</span>avg<span class="token punctuation">,</span> stage<span class="token operator">=</span><span class="token string">"valid"</span><span class="token punctuation">,</span> <span class="token operator">**</span>monitor<span class="token punctuation">)</span>
            self<span class="token punctuation">.</span>current_valid_step <span class="token operator">+=</span> <span class="token number">1</span>
        tk0<span class="token punctuation">.</span>close<span class="token punctuation">(</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>update_metrics<span class="token punctuation">(</span>losses<span class="token operator">=</span>losses<span class="token punctuation">,</span> monitor<span class="token operator">=</span>monitor<span class="token punctuation">)</span>
        <span class="token keyword">for</span> k<span class="token punctuation">,</span> v <span class="token keyword">in</span> monitor<span class="token punctuation">.</span>items<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
            self<span class="token punctuation">.</span>history<span class="token punctuation">[</span><span class="token string-interpolation"><span class="token string">f"valid_</span><span class="token interpolation"><span class="token punctuation">&#123;</span>k<span class="token punctuation">&#125;</span></span><span class="token string">"</span></span><span class="token punctuation">]</span><span class="token punctuation">.</span>append<span class="token punctuation">(</span>v<span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>history<span class="token punctuation">[</span><span class="token string">"valid_loss"</span><span class="token punctuation">]</span><span class="token punctuation">.</span>append<span class="token punctuation">(</span>losses<span class="token punctuation">.</span>avg<span class="token punctuation">)</span>
        <span class="token keyword">return</span> losses<span class="token punctuation">.</span>avg
    
    <span class="token keyword">def</span> <span class="token function">forward</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> feature<span class="token punctuation">,</span> target<span class="token operator">=</span><span class="token boolean">None</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        target <span class="token operator">=</span> target<span class="token punctuation">.</span><span class="token builtin">long</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>to<span class="token punctuation">(</span>self<span class="token punctuation">.</span>device<span class="token punctuation">)</span>
        x <span class="token operator">=</span> feature<span class="token punctuation">.</span>reshape<span class="token punctuation">(</span>feature<span class="token punctuation">.</span>shape<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span>
        x <span class="token operator">=</span> F<span class="token punctuation">.</span>relu<span class="token punctuation">(</span>self<span class="token punctuation">.</span>fc1<span class="token punctuation">(</span>x<span class="token punctuation">)</span><span class="token punctuation">)</span>
        outputs <span class="token operator">=</span> self<span class="token punctuation">.</span>out<span class="token punctuation">(</span>self<span class="token punctuation">.</span>dropout<span class="token punctuation">(</span>x<span class="token punctuation">)</span><span class="token punctuation">)</span>
        outputs <span class="token operator">=</span> outputs<span class="token punctuation">.</span><span class="token builtin">float</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>to<span class="token punctuation">(</span>self<span class="token punctuation">.</span>device<span class="token punctuation">)</span>

        <span class="token keyword">if</span> target <span class="token keyword">is</span> <span class="token keyword">not</span> <span class="token boolean">None</span><span class="token punctuation">:</span>
            loss <span class="token operator">=</span> nn<span class="token punctuation">.</span>CrossEntropyLoss<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">(</span>outputs<span class="token punctuation">,</span> target<span class="token punctuation">)</span>
            metrics <span class="token operator">=</span> self<span class="token punctuation">.</span>monitor_metrics<span class="token punctuation">(</span>outputs<span class="token punctuation">,</span> target<span class="token punctuation">)</span>
            <span class="token keyword">return</span> outputs<span class="token punctuation">,</span> loss<span class="token punctuation">,</span> metrics
        
        <span class="token keyword">return</span> outputs<span class="token punctuation">,</span> <span class="token boolean">None</span><span class="token punctuation">,</span> <span class="token boolean">None</span>
    
    <span class="token keyword">def</span> <span class="token function">score</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> test_dataset<span class="token punctuation">,</span> n_jobs<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        
        <span class="token keyword">def</span> <span class="token function">softmax</span><span class="token punctuation">(</span>x<span class="token punctuation">)</span><span class="token punctuation">:</span>
            <span class="token keyword">return</span> np<span class="token punctuation">.</span>exp<span class="token punctuation">(</span>x<span class="token punctuation">)</span> <span class="token operator">/</span> np<span class="token punctuation">.</span><span class="token builtin">sum</span><span class="token punctuation">(</span>np<span class="token punctuation">.</span>exp<span class="token punctuation">(</span>x<span class="token punctuation">)</span><span class="token punctuation">,</span> axis<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">)</span>
        
        prediction <span class="token operator">=</span> self<span class="token punctuation">.</span>predict<span class="token punctuation">(</span>test_dataset<span class="token punctuation">,</span> n_jobs<span class="token operator">=</span>n_jobs<span class="token punctuation">)</span>
        prediction <span class="token operator">=</span> <span class="token builtin">list</span><span class="token punctuation">(</span>prediction<span class="token punctuation">)</span>
        prediction <span class="token operator">=</span> softmax<span class="token punctuation">(</span>np<span class="token punctuation">.</span>vstack<span class="token punctuation">(</span>prediction<span class="token punctuation">)</span><span class="token punctuation">)</span>
        prediction <span class="token operator">=</span> np<span class="token punctuation">.</span>argmax<span class="token punctuation">(</span>prediction<span class="token punctuation">,</span> axis<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span>
        groud_truth <span class="token operator">=</span> test_dataset<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string">"target"</span><span class="token punctuation">]</span><span class="token punctuation">.</span>detach<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>numpy<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>astype<span class="token punctuation">(</span>np<span class="token punctuation">.</span>int64<span class="token punctuation">)</span>
        <span class="token keyword">return</span> metrics<span class="token punctuation">.</span>accuracy_score<span class="token punctuation">(</span>prediction<span class="token punctuation">,</span> groud_truth<span class="token punctuation">)</span>
    
    <span class="token keyword">def</span> <span class="token function">plot_history</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">from</span> matplotlib<span class="token punctuation">.</span>ticker <span class="token keyword">import</span> MaxNLocator
        
        train_loss<span class="token punctuation">,</span> valid_loss <span class="token operator">=</span> self<span class="token punctuation">.</span>history<span class="token punctuation">[</span><span class="token string">"train_loss"</span><span class="token punctuation">]</span><span class="token punctuation">,</span> self<span class="token punctuation">.</span>history<span class="token punctuation">[</span><span class="token string">"valid_loss"</span><span class="token punctuation">]</span>
        train_accuracy<span class="token punctuation">,</span> valid_accuracy <span class="token operator">=</span> self<span class="token punctuation">.</span>history<span class="token punctuation">[</span><span class="token string">"train_accuracy"</span><span class="token punctuation">]</span><span class="token punctuation">,</span> self<span class="token punctuation">.</span>history<span class="token punctuation">[</span><span class="token string">"valid_accuracy"</span><span class="token punctuation">]</span>

        plt<span class="token punctuation">.</span>rcParams<span class="token punctuation">[</span><span class="token string">"figure.figsize"</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">15</span><span class="token punctuation">,</span> <span class="token number">6</span>
        ax1 <span class="token operator">=</span> plt<span class="token punctuation">.</span>subplot<span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span>
        ax1<span class="token punctuation">.</span>plot<span class="token punctuation">(</span><span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token builtin">len</span><span class="token punctuation">(</span>train_loss<span class="token punctuation">)</span><span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span> train_loss<span class="token punctuation">,</span> color<span class="token operator">=</span><span class="token string">"tab:blue"</span><span class="token punctuation">,</span> label<span class="token operator">=</span><span class="token string">"train"</span><span class="token punctuation">)</span>
        ax1<span class="token punctuation">.</span>plot<span class="token punctuation">(</span><span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token builtin">len</span><span class="token punctuation">(</span>valid_loss<span class="token punctuation">)</span><span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span> valid_loss<span class="token punctuation">,</span> color<span class="token operator">=</span><span class="token string">"tab:orange"</span><span class="token punctuation">,</span> label<span class="token operator">=</span><span class="token string">"valid"</span><span class="token punctuation">)</span>
        ax1<span class="token punctuation">.</span>xaxis<span class="token punctuation">.</span>set_major_locator<span class="token punctuation">(</span>MaxNLocator<span class="token punctuation">(</span>integer<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        ax1<span class="token punctuation">.</span>title<span class="token punctuation">.</span>set_text<span class="token punctuation">(</span><span class="token string">'Loss'</span><span class="token punctuation">)</span>
        ax1<span class="token punctuation">.</span>grid<span class="token punctuation">(</span><span class="token punctuation">)</span>
        ax2 <span class="token operator">=</span> plt<span class="token punctuation">.</span>subplot<span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span>
        ax2<span class="token punctuation">.</span>plot<span class="token punctuation">(</span><span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token builtin">len</span><span class="token punctuation">(</span>train_accuracy<span class="token punctuation">)</span><span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span> train_accuracy<span class="token punctuation">,</span> color<span class="token operator">=</span><span class="token string">"tab:blue"</span><span class="token punctuation">,</span> label<span class="token operator">=</span><span class="token string">"train"</span><span class="token punctuation">)</span>
        ax2<span class="token punctuation">.</span>plot<span class="token punctuation">(</span><span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token builtin">len</span><span class="token punctuation">(</span>valid_accuracy<span class="token punctuation">)</span><span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span> valid_accuracy<span class="token punctuation">,</span> color<span class="token operator">=</span><span class="token string">"tab:orange"</span><span class="token punctuation">,</span> label<span class="token operator">=</span><span class="token string">"valid"</span><span class="token punctuation">)</span>
        ax2<span class="token punctuation">.</span>xaxis<span class="token punctuation">.</span>set_major_locator<span class="token punctuation">(</span>MaxNLocator<span class="token punctuation">(</span>integer<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        ax2<span class="token punctuation">.</span>title<span class="token punctuation">.</span>set_text<span class="token punctuation">(</span><span class="token string">'Accuracy'</span><span class="token punctuation">)</span>
        ax2<span class="token punctuation">.</span>grid<span class="token punctuation">(</span><span class="token punctuation">)</span>
        plt<span class="token punctuation">.</span>tight_layout<span class="token punctuation">(</span><span class="token punctuation">)</span>
        plt<span class="token punctuation">.</span>show<span class="token punctuation">(</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>Start training!</p>
<pre class="line-numbers language-python" data-language="python"><code class="language-python">model <span class="token operator">=</span> SongGenreMLPClassifier<span class="token punctuation">(</span>num_classes<span class="token operator">=</span><span class="token number">3</span><span class="token punctuation">)</span>
MODEL_PATH <span class="token operator">=</span> <span class="token string">"./models/"</span>
MODEL_NAME <span class="token operator">=</span> <span class="token string">"SongGenreMLPClassifier"</span>
es <span class="token operator">=</span> EarlyStopping<span class="token punctuation">(</span>
    monitor<span class="token operator">=</span><span class="token string">"valid_loss"</span><span class="token punctuation">,</span>
    model_path<span class="token operator">=</span>os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>join<span class="token punctuation">(</span>MODEL_PATH<span class="token punctuation">,</span> MODEL_NAME <span class="token operator">+</span> <span class="token string">".bin"</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    patience<span class="token operator">=</span><span class="token number">15</span><span class="token punctuation">,</span>
    mode<span class="token operator">=</span><span class="token string">"min"</span><span class="token punctuation">,</span>
<span class="token punctuation">)</span>

model<span class="token punctuation">.</span>fit<span class="token punctuation">(</span>
    train_dataset<span class="token punctuation">,</span>
    valid_dataset<span class="token operator">=</span>valid_dataset<span class="token punctuation">,</span>
    train_bs<span class="token operator">=</span><span class="token number">16</span><span class="token punctuation">,</span>
    valid_bs<span class="token operator">=</span><span class="token number">16</span><span class="token punctuation">,</span>
    device<span class="token operator">=</span><span class="token string">"cuda"</span><span class="token punctuation">,</span>
    epochs<span class="token operator">=</span><span class="token number">10</span><span class="token punctuation">,</span> 
    fp16<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">,</span> 
    callbacks<span class="token operator">=</span><span class="token punctuation">[</span>es<span class="token punctuation">]</span><span class="token punctuation">,</span> 
    n_jobs<span class="token operator">=</span><span class="token number">0</span>
<span class="token punctuation">)</span>

model<span class="token punctuation">.</span>plot_history<span class="token punctuation">(</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<img src="/2021/02/05/2021-02-05-audio-based-song-genre-classification/history.png" class="">

<h1 id="Conclusion"><a href="#Conclusion" class="headerlink" title="Conclusion"></a>Conclusion</h1><p>In the end, we got a accuracy score of 50.7% on the test dataset. For your information, I only utilise 150 songs, which is not a large amount of data, but it achieves a higher score than most of the lyrics-based models (this <a href="/2019/06/11/2019-06-11-categorising-song-genre-by-analysing-lyrics/" title="article">article</a> I wrote before). In the future, I will investigate more different models to improve the performance for the audio-based classifier! Stay tuned!</p>
<h2 id="References"><a href="#References" class="headerlink" title="References"></a>References</h2><ol>
<li><a target="_blank" rel="noopener" href="https://github.community/t/is-it-possible-to-open-a-sound-file/10377/2">https://github.community/t/is-it-possible-to-open-a-sound-file/10377/2</a></li>
<li><a target="_blank" rel="noopener" href="https://developer.mozilla.org/en-US/docs/Web/HTML/Element/audio">https://developer.mozilla.org/en-US/docs/Web/HTML/Element/audio</a></li>
<li><a target="_blank" rel="noopener" href="https://www.izotope.com/en/learn/digital-audio-basics-sample-rate-and-bit-depth.html">https://www.izotope.com/en/learn/digital-audio-basics-sample-rate-and-bit-depth.html</a></li>
<li><a target="_blank" rel="noopener" href="https://www.youtube.com/watch?v=daB9naGBVv4&amp;list=RDCMUCZPFjMe1uRSirmSpznqvJfQ&amp;index=6&amp;ab_channel=ValerioVelardo-TheSoundofAI">https://www.youtube.com/watch?v=daB9naGBVv4&amp;list=RDCMUCZPFjMe1uRSirmSpznqvJfQ&amp;index=6&amp;ab_channel=ValerioVelardo-TheSoundofAI</a></li>
<li><a target="_blank" rel="noopener" href="http://www2.egr.uh.edu/~glover/applets/Sampling/Sampling.html">http://www2.egr.uh.edu/~glover/applets/Sampling/Sampling.html</a></li>
<li><a target="_blank" rel="noopener" href="https://www.dewresearch.com/products/163-derivation-of-the-dft">https://www.dewresearch.com/products/163-derivation-of-the-dft</a></li>
<li><a target="_blank" rel="noopener" href="https://teropa.info/harmonics-explorer/">https://teropa.info/harmonics-explorer/</a></li>
<li><a target="_blank" rel="noopener" href="https://towardsdatascience.com/extract-features-of-music-75a3f9bc265d">https://towardsdatascience.com/extract-features-of-music-75a3f9bc265d</a></li>
<li><a target="_blank" rel="noopener" href="https://haythamfayek.com/2016/04/21/speech-processing-for-machine-learning.html">https://haythamfayek.com/2016/04/21/speech-processing-for-machine-learning.html</a></li>
<li><a target="_blank" rel="noopener" href="https://www.kaggle.com/ilyamich/mfcc-implementation-and-tutorial">https://www.kaggle.com/ilyamich/mfcc-implementation-and-tutorial</a></li>
</ol>

                
            </div>
            <hr/>

            

    <div class="reprint" id="reprint-statement">
        
            <div class="reprint__author">
                <span class="reprint-meta" style="font-weight: bold;">
                    <i class="fas fa-user">
                        Author:
                    </i>
                </span>
                <span class="reprint-info">
                    <a href="/about" rel="external nofollow noreferrer">Yang Wang</a>
                </span>
            </div>
            <div class="reprint__type">
                <span class="reprint-meta" style="font-weight: bold;">
                    <i class="fas fa-link">
                        Link:
                    </i>
                </span>
                <span class="reprint-info">
                    <a href="https://penguinwang96825.github.io/2021/02/05/2021-02-05-audio-based-song-genre-classification/">https://penguinwang96825.github.io/2021/02/05/2021-02-05-audio-based-song-genre-classification/</a>
                </span>
            </div>
            <div class="reprint__notice">
                <span class="reprint-meta" style="font-weight: bold;">
                    <i class="fas fa-copyright">
                        Reprint policy:
                    </i>
                </span>
                <span class="reprint-info">
                    All articles in this blog are used except for special statements
                    <a href="https://creativecommons.org/licenses/by/4.0/deed.zh" rel="external nofollow noreferrer" target="_blank">CC BY 4.0</a>
                    reprint polocy. If reproduced, please indicate source
                    <a href="/about" target="_blank">Yang Wang</a>
                    !
                </span>
            </div>
        
    </div>

    <script async defer>
      document.addEventListener("copy", function (e) {
        let toastHTML = '<span>Copied successfully, please follow the reprint policy of this article</span><button class="btn-flat toast-action" onclick="navToReprintStatement()" style="font-size: smaller">more</a>';
        M.toast({html: toastHTML})
      });

      function navToReprintStatement() {
        $("html, body").animate({scrollTop: $("#reprint-statement").offset().top - 80}, 800);
      }
    </script>



            <div class="tag_share" style="display: block;">
                <div class="post-meta__tag-list" style="display: inline-block;">
                    
                        <div class="article-tag">
                            
                                <a href="/tags/Python/">
                                    <span class="chip bg-color">Python</span>
                                </a>
                            
                                <a href="/tags/Librosa/">
                                    <span class="chip bg-color">Librosa</span>
                                </a>
                            
                        </div>
                    
                </div>
                <div class="post_share" style="zoom: 80%; width: fit-content; display: inline-block; float: right; margin: -0.15rem 0;">
                    <link rel="stylesheet" type="text/css" href="/libs/share/css/share.min.css">
<div id="article-share">

    
    <div class="social-share" data-sites="twitter,facebook,google,qq,qzone,wechat,weibo,douban,linkedin" data-wechat-qrcode-helper="<p>WeChat swipe to share！</p>"></div>
    <script src="/libs/share/js/social-share.min.js"></script>
    

    

</div>

                </div>
            </div>
            
        </div>
    </div>

    

    

    

    

    

    

    

    

<article id="prenext-posts" class="prev-next articles">
    <div class="row article-row">
        
        <div class="article col s12 m6" data-aos="fade-up">
            <div class="article-badge left-badge text-color">
                <i class="fas fa-chevron-left"></i>&nbsp;Previous</div>
            <div class="card">
                <a href="/2021/02/06/2021-02-06-prevent-colab-from-disconnecting/">
                    <div class="card-image">
                        
                        <img src="https://github.com/penguinwang96825/penguinwang96825.github.io/blob/master/2021/02/06/2021-02-06-prevent-colab-from-disconnecting/kai-wenzel.jpg?raw=true" class="responsive-img" alt="Prevent Colab from Disconnecting">
                        
                        <span class="card-title">Prevent Colab from Disconnecting</span>
                    </div>
                </a>
                <div class="card-content article-content">
                    <div class="summary block-with-text">
                        
                            Google Colab notebooks have an idle timeout of 90 minutes and absolute timeout of 12 hours. This means, if user does not interact with his Google Colab notebook for more than 90 minutes, its instance is automatically terminated. Also, maximum lifetime of a Colab instance is 12 hours.
                        
                    </div>
                    <div class="publish-info">
                        <span class="publish-date">
                            <i class="far fa-clock fa-fw icon-date"></i>2021-02-06
                        </span>
                        <span class="publish-author">
                            
                            <i class="fas fa-bookmark fa-fw icon-category"></i>
                            
                            <a href="/categories/Installation/" class="post-category">
                                    Installation
                                </a>
                            
                            
                        </span>
                    </div>
                </div>
                
                <div class="card-action article-tags">
                    
                    <a href="/tags/Colab/">
                        <span class="chip bg-color">Colab</span>
                    </a>
                    
                    <a href="/tags/JavaScript/">
                        <span class="chip bg-color">JavaScript</span>
                    </a>
                    
                </div>
                
            </div>
        </div>
        
        
        <div class="article col s12 m6" data-aos="fade-up">
            <div class="article-badge right-badge text-color">
                Next&nbsp;<i class="fas fa-chevron-right"></i>
            </div>
            <div class="card">
                <a href="/2021/01/29/2021-01-29-matrix-decomposition/">
                    <div class="card-image">
                        
                        <img src="https://github.com/penguinwang96825/penguinwang96825.github.io/blob/master/2021/01/29/2021-01-29-matrix-decomposition/kelly-sikkema.jpg?raw=true" class="responsive-img" alt="Matrix Decomposition">
                        
                        <span class="card-title">Matrix Decomposition</span>
                    </div>
                </a>
                <div class="card-content article-content">
                    <div class="summary block-with-text">
                        
                            The most important application for decomposition is in data fitting. The following discussion is mostly presented in terms of different methods of decomposition for linear function.
                        
                    </div>
                    <div class="publish-info">
                            <span class="publish-date">
                                <i class="far fa-clock fa-fw icon-date"></i>2021-01-29
                            </span>
                        <span class="publish-author">
                            
                            <i class="fas fa-bookmark fa-fw icon-category"></i>
                            
                            <a href="/categories/Algorithm/" class="post-category">
                                    Algorithm
                                </a>
                            
                            
                        </span>
                    </div>
                </div>
                
                <div class="card-action article-tags">
                    
                    <a href="/tags/Python/">
                        <span class="chip bg-color">Python</span>
                    </a>
                    
                    <a href="/tags/MATLAB/">
                        <span class="chip bg-color">MATLAB</span>
                    </a>
                    
                    <a href="/tags/Linear-Algebra/">
                        <span class="chip bg-color">Linear Algebra</span>
                    </a>
                    
                </div>
                
            </div>
        </div>
        
    </div>
</article>

</div>


<script>
    $('#articleContent').on('copy', function (e) {
        // IE8 or earlier browser is 'undefined'
        if (typeof window.getSelection === 'undefined') return;

        var selection = window.getSelection();
        // if the selection is short let's not annoy our users.
        if (('' + selection).length < Number.parseInt('120')) {
            return;
        }

        // create a div outside of the visible area and fill it with the selected text.
        var bodyElement = document.getElementsByTagName('body')[0];
        var newdiv = document.createElement('div');
        newdiv.style.position = 'absolute';
        newdiv.style.left = '-99999px';
        bodyElement.appendChild(newdiv);
        newdiv.appendChild(selection.getRangeAt(0).cloneContents());

        // we need a <pre> tag workaround.
        // otherwise the text inside "pre" loses all the line breaks!
        if (selection.getRangeAt(0).commonAncestorContainer.nodeName === 'PRE') {
            newdiv.innerHTML = "<pre>" + newdiv.innerHTML + "</pre>";
        }

        var url = document.location.href;
        newdiv.innerHTML += '<br />'
            + 'From: Yang&#39;s Blog<br />'
            + 'Author: Yang Wang<br />'
            + 'Link: <a href="' + url + '">' + url + '</a><br />'
            + 'The copyright of this article belongs to the author, please indicate the source of any form of reproduction.';

        selection.selectAllChildren(newdiv);
        window.setTimeout(function () {bodyElement.removeChild(newdiv);}, 200);
    });
</script>


<!-- 代码块功能依赖 -->
<script type="text/javascript" src="/libs/codeBlock/codeBlockFuction.js"></script>

<!-- 代码语言 -->

<script type="text/javascript" src="/libs/codeBlock/codeLang.js"></script>


<!-- 代码块复制 -->


<!-- 代码块收缩 -->

<script type="text/javascript" src="/libs/codeBlock/codeShrink.js"></script>


    </div>
    <div id="toc-aside" class="expanded col l3 hide-on-med-and-down">
        <div class="toc-widget card" style="background-color: white;">
            <div class="toc-title"><i class="far fa-list-alt"></i>&nbsp;&nbsp;TOC</div>
            <div id="toc-content"></div>
        </div>
    </div>
</div>

<!-- TOC 悬浮按钮. -->

<div id="floating-toc-btn" class="hide-on-med-and-down">
    <a class="btn-floating btn-large bg-color">
        <i class="fas fa-list-ul"></i>
    </a>
</div>


<script src="/libs/tocbot/tocbot.min.js"></script>
<script>
    $(function () {
        tocbot.init({
            tocSelector: '#toc-content',
            contentSelector: '#articleContent',
            headingsOffset: -($(window).height() * 0.4 - 45),
            collapseDepth: Number('0'),
            headingSelector: 'h1, h2, h3, h4'
        });

        // modify the toc link href to support Chinese.
        let i = 0;
        let tocHeading = 'toc-heading-';
        $('#toc-content a').each(function () {
            $(this).attr('href', '#' + tocHeading + (++i));
        });

        // modify the heading title id to support Chinese.
        i = 0;
        $('#articleContent').children('h1, h2, h3, h4').each(function () {
            $(this).attr('id', tocHeading + (++i));
        });

        // Set scroll toc fixed.
        let tocHeight = parseInt($(window).height() * 0.4 - 64);
        let $tocWidget = $('.toc-widget');
        $(window).scroll(function () {
            let scroll = $(window).scrollTop();
            /* add post toc fixed. */
            if (scroll > tocHeight) {
                $tocWidget.addClass('toc-fixed');
            } else {
                $tocWidget.removeClass('toc-fixed');
            }
        });

        
        /* 修复文章卡片 div 的宽度. */
        let fixPostCardWidth = function (srcId, targetId) {
            let srcDiv = $('#' + srcId);
            if (srcDiv.length === 0) {
                return;
            }

            let w = srcDiv.width();
            if (w >= 450) {
                w = w + 21;
            } else if (w >= 350 && w < 450) {
                w = w + 18;
            } else if (w >= 300 && w < 350) {
                w = w + 16;
            } else {
                w = w + 14;
            }
            $('#' + targetId).width(w);
        };

        // 切换TOC目录展开收缩的相关操作.
        const expandedClass = 'expanded';
        let $tocAside = $('#toc-aside');
        let $mainContent = $('#main-content');
        $('#floating-toc-btn .btn-floating').click(function () {
            if ($tocAside.hasClass(expandedClass)) {
                $tocAside.removeClass(expandedClass).hide();
                $mainContent.removeClass('l9');
            } else {
                $tocAside.addClass(expandedClass).show();
                $mainContent.addClass('l9');
            }
            fixPostCardWidth('artDetail', 'prenext-posts');
        });
        
    });
</script>

    

</main>


<script type="text/javascript" src="http://cdn.mathjax.org/mathjax/latest/MathJax.js?config=default"></script>

    <footer class="page-footer bg-color">
    
        <link rel="stylesheet" href="/libs/aplayer/APlayer.min.css">
<style>
    .aplayer .aplayer-lrc p {
        
        display: none;
        
        font-size: 12px;
        font-weight: 700;
        line-height: 16px !important;
    }

    .aplayer .aplayer-lrc p.aplayer-lrc-current {
        
        display: none;
        
        font-size: 15px;
        color: #42b983;
    }

    
    .aplayer.aplayer-fixed.aplayer-narrow .aplayer-body {
        left: -66px !important;
    }

    .aplayer.aplayer-fixed.aplayer-narrow .aplayer-body:hover {
        left: 0px !important;
    }

    
</style>
<div class="">
    
    <div class="row">
        <meting-js class="col l8 offset-l2 m10 offset-m1 s12"
                   server="netease"
                   type="playlist"
                   id="503838841"
                   fixed='true'
                   autoplay='false'
                   theme='#42b983'
                   loop='all'
                   order='random'
                   preload='auto'
                   volume='0.3'
                   list-folded='true'
        >
        </meting-js>
    </div>
</div>

<script src="/libs/aplayer/APlayer.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/meting@2/dist/Meting.min.js"></script>

    
    <div class="container row center-align" style="margin-bottom: 15px !important;">
        <div class="col s12 m8 l8 copy-right">
            Copyright&nbsp;&copy;
            
                <span id="year">2018-2021</span>
            
            <span id="year">2018</span>
            <a href="/about" target="_blank">Yang Wang</a>
            |&nbsp;Powered by&nbsp;<a href="https://hexo.io/" target="_blank">Hexo</a>
            |&nbsp;Theme&nbsp;<a href="https://github.com/blinkfox/hexo-theme-matery" target="_blank">Matery</a>
            <br>
            
            &nbsp;<i class="fas fa-chart-area"></i>&nbsp;Total site word count:&nbsp;<span
                class="white-color">44.3k</span>&nbsp;words
            
            
            
            
            
            
            <span id="busuanzi_container_site_pv">
                |&nbsp;<i class="far fa-eye"></i>&nbsp;Total number of visits:&nbsp;<span id="busuanzi_value_site_pv"
                    class="white-color"></span>&nbsp;times
            </span>
            
            
            <span id="busuanzi_container_site_uv">
                |&nbsp;<i class="fas fa-users"></i>&nbsp;Total number of visitors:&nbsp;<span id="busuanzi_value_site_uv"
                    class="white-color"></span>&nbsp;people
            </span>
            
            <br>
            
            <span id="sitetime">Loading runtime...</span>
            <script>
                function siteTime() {
                    var seconds = 1000;
                    var minutes = seconds * 60;
                    var hours = minutes * 60;
                    var days = hours * 24;
                    var years = days * 365;
                    var today = new Date();
                    var startYear = "2018";
                    var startMonth = "12";
                    var startDate = "3";
                    var startHour = "0";
                    var startMinute = "0";
                    var startSecond = "0";
                    var todayYear = today.getFullYear();
                    var todayMonth = today.getMonth() + 1;
                    var todayDate = today.getDate();
                    var todayHour = today.getHours();
                    var todayMinute = today.getMinutes();
                    var todaySecond = today.getSeconds();
                    var t1 = Date.UTC(startYear, startMonth, startDate, startHour, startMinute, startSecond);
                    var t2 = Date.UTC(todayYear, todayMonth, todayDate, todayHour, todayMinute, todaySecond);
                    var diff = t2 - t1;
                    var diffYears = Math.floor(diff / years);
                    var diffDays = Math.floor((diff / days) - diffYears * 365);
                    var diffHours = Math.floor((diff - (diffYears * 365 + diffDays) * days) / hours);
                    var diffMinutes = Math.floor((diff - (diffYears * 365 + diffDays) * days - diffHours * hours) /
                        minutes);
                    var diffSeconds = Math.floor((diff - (diffYears * 365 + diffDays) * days - diffHours * hours -
                        diffMinutes * minutes) / seconds);
                    if (startYear == todayYear) {
                        document.getElementById("year").innerHTML = todayYear;
                        document.getElementById("sitetime").innerHTML = "This site has been safely operated " + diffDays + " days " + diffHours +
                            " hours " + diffMinutes + " minutes " + diffSeconds + " seconds";
                    } else {
                        document.getElementById("year").innerHTML = startYear + " - " + todayYear;
                        document.getElementById("sitetime").innerHTML = "This site has been safely operated " + diffYears + " years " + diffDays +
                            " days " + diffHours + " hours " + diffMinutes + " minutes " + diffSeconds + " seconds";
                    }
                }
                setInterval(siteTime, 1000);
            </script>
            
            <br>
            
        </div>
        <div class="col s12 m4 l4 social-link social-statis">
    <a href="https://github.com/penguinwang96825" class="tooltipped" target="_blank" data-tooltip="Visit my GitHub" data-position="top" data-delay="50">
        <i class="fab fa-github"></i>
    </a>



    <a href="mailto:penguinwang@smail.nchu.edu.tw" class="tooltipped" target="_blank" data-tooltip="Contact me by mail" data-position="top" data-delay="50">
        <i class="fas fa-envelope-open"></i>
    </a>













</div>
    </div>
</footer>

<div class="progress-bar"></div>

    <!-- 搜索遮罩框 -->
<div id="searchModal" class="modal">
    <div class="modal-content">
        <div class="search-header">
            <span class="title"><i class="fas fa-search"></i>&nbsp;&nbsp;Search</span>
            <input type="search" id="searchInput" name="s" placeholder="Please enter a search keyword"
                   class="search-input">
        </div>
        <div id="searchResult"></div>
    </div>
</div>

<script type="text/javascript">
$(function () {
    var searchFunc = function (path, search_id, content_id) {
        'use strict';
        $.ajax({
            url: path,
            dataType: "xml",
            success: function (xmlResponse) {
                // get the contents from search data
                var datas = $("entry", xmlResponse).map(function () {
                    return {
                        title: $("title", this).text(),
                        content: $("content", this).text(),
                        url: $("url", this).text()
                    };
                }).get();
                var $input = document.getElementById(search_id);
                var $resultContent = document.getElementById(content_id);
                $input.addEventListener('input', function () {
                    var str = '<ul class=\"search-result-list\">';
                    var keywords = this.value.trim().toLowerCase().split(/[\s\-]+/);
                    $resultContent.innerHTML = "";
                    if (this.value.trim().length <= 0) {
                        return;
                    }
                    // perform local searching
                    datas.forEach(function (data) {
                        var isMatch = true;
                        var data_title = data.title.trim().toLowerCase();
                        var data_content = data.content.trim().replace(/<[^>]+>/g, "").toLowerCase();
                        var data_url = data.url;
                        data_url = data_url.indexOf('/') === 0 ? data.url : '/' + data_url;
                        var index_title = -1;
                        var index_content = -1;
                        var first_occur = -1;
                        // only match artiles with not empty titles and contents
                        if (data_title !== '' && data_content !== '') {
                            keywords.forEach(function (keyword, i) {
                                index_title = data_title.indexOf(keyword);
                                index_content = data_content.indexOf(keyword);
                                if (index_title < 0 && index_content < 0) {
                                    isMatch = false;
                                } else {
                                    if (index_content < 0) {
                                        index_content = 0;
                                    }
                                    if (i === 0) {
                                        first_occur = index_content;
                                    }
                                }
                            });
                        }
                        // show search results
                        if (isMatch) {
                            str += "<li><a href='" + data_url + "' class='search-result-title'>" + data_title + "</a>";
                            var content = data.content.trim().replace(/<[^>]+>/g, "");
                            if (first_occur >= 0) {
                                // cut out 100 characters
                                var start = first_occur - 20;
                                var end = first_occur + 80;
                                if (start < 0) {
                                    start = 0;
                                }
                                if (start === 0) {
                                    end = 100;
                                }
                                if (end > content.length) {
                                    end = content.length;
                                }
                                var match_content = content.substr(start, end);
                                // highlight all keywords
                                keywords.forEach(function (keyword) {
                                    var regS = new RegExp(keyword, "gi");
                                    match_content = match_content.replace(regS, "<em class=\"search-keyword\">" + keyword + "</em>");
                                });

                                str += "<p class=\"search-result\">" + match_content + "...</p>"
                            }
                            str += "</li>";
                        }
                    });
                    str += "</ul>";
                    $resultContent.innerHTML = str;
                });
            }
        });
    };

    searchFunc('/search.xml', 'searchInput', 'searchResult');
});
</script>

    <!-- 回到顶部按钮 -->
<div id="backTop" class="top-scroll">
    <a class="btn-floating btn-large waves-effect waves-light" href="#!">
        <i class="fas fa-arrow-up"></i>
    </a>
</div>


    <script src="/libs/materialize/materialize.min.js"></script>
    <script src="/libs/masonry/masonry.pkgd.min.js"></script>
    <script src="/libs/aos/aos.js"></script>
    <script src="/libs/scrollprogress/scrollProgress.min.js"></script>
    <script src="/libs/lightGallery/js/lightgallery-all.min.js"></script>
    <script src="/js/matery.js"></script>

    <!-- Baidu Analytics -->

    <!-- Baidu Push -->

<script>
    (function () {
        var bp = document.createElement('script');
        var curProtocol = window.location.protocol.split(':')[0];
        if (curProtocol === 'https') {
            bp.src = 'https://zz.bdstatic.com/linksubmit/push.js';
        } else {
            bp.src = 'http://push.zhanzhang.baidu.com/push.js';
        }
        var s = document.getElementsByTagName("script")[0];
        s.parentNode.insertBefore(bp, s);
    })();
</script>

    
    <script src="/libs/others/clicklove.js" async="async"></script>
    
    
    <script async src="/libs/others/busuanzi.pure.mini.js"></script>
    

    

    

	
    

    

    

    
    <script src="/libs/instantpage/instantpage.js" type="module"></script>
    

</body>

</html>
